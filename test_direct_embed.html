<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Direto Power BI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { border: 2px solid #007bff; padding: 20px; margin: 20px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        iframe { border: 2px solid #28a745; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-success { background: #28a745; color: white; border: none; }
        .btn-warning { background: #ffc107; color: black; border: none; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üß™ Teste Direto: Power BI com Autentica√ß√£o</h1>
    
    <div class="info status">
        <strong>Link sendo testado:</strong><br>
        <code>https://app.powerbi.com/reportEmbed?reportId=ef9c9663-7cec-4c9a-8b57-c1a6c895057a&autoAuth=true&ctid=0b754a09-0568-48fd-a100-8621a0bbd7ab</code>
    </div>

    <div class="test-container">
        <h3>üìä Teste #1: Iframe B√°sico</h3>
        <button class="btn-primary" onclick="testBasicIframe()">Testar Iframe B√°sico</button>
        <button class="btn-warning" onclick="clearTest1()">Limpar</button>
        <div id="test1-status"></div>
        <div id="test1-container" style="min-height: 300px; border: 1px dashed #ccc; margin: 10px 0;">
            <p style="text-align: center; color: #666; margin-top: 100px;">√Årea de teste vazia</p>
        </div>
    </div>

    <div class="test-container">
        <h3>üîê Teste #2: Iframe com M√°ximas Permiss√µes</h3>
        <button class="btn-success" onclick="testMaxPermissions()">Testar com M√°ximas Permiss√µes</button>
        <button class="btn-warning" onclick="clearTest2()">Limpar</button>
        <div id="test2-status"></div>
        <div id="test2-container" style="min-height: 300px; border: 1px dashed #ccc; margin: 10px 0;">
            <p style="text-align: center; color: #666; margin-top: 100px;">√Årea de teste vazia</p>
        </div>
    </div>

    <div class="test-container">
        <h3>üìã Log de Debug</h3>
        <button class="btn-warning" onclick="clearLog()">Limpar Log</button>
        <pre id="debug-log">Aguardando testes...</pre>
    </div>

    <script>
        const authLink = 'https://app.powerbi.com/reportEmbed?reportId=ef9c9663-7cec-4c9a-8b57-c1a6c895057a&autoAuth=true&ctid=0b754a09-0568-48fd-a100-8621a0bbd7ab';
        
        function log(message) {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `\n[${timestamp}] ${message}`;
            console.log(`[${timestamp}] ${message}`);
        }

        function showStatus(testId, type, message) {
            const statusElement = document.getElementById(`test${testId}-status`);
            statusElement.innerHTML = `<div class="${type} status">${message}</div>`;
        }

        function testBasicIframe() {
            log('üöÄ INICIANDO: Teste de iframe b√°sico');
            showStatus(1, 'info', '‚è≥ Carregando iframe b√°sico...');
            
            const container = document.getElementById('test1-container');
            const startTime = Date.now();
            
            container.innerHTML = `
                <iframe 
                    id="basic-iframe"
                    src="${authLink}"
                    width="100%" 
                    height="280"
                    frameborder="0">
                </iframe>
            `;
            
            const iframe = document.getElementById('basic-iframe');
            
            iframe.onload = function() {
                const loadTime = Date.now() - startTime;
                log(`‚úÖ Iframe b√°sico onload ap√≥s ${loadTime}ms`);
                
                setTimeout(() => {
                    try {
                        const rect = iframe.getBoundingClientRect();
                        log(`üìè Dimens√µes: ${rect.width}x${rect.height}`);
                        
                        if (rect.height > 100) {
                            showStatus(1, 'success', '‚úÖ SUCESSO! Iframe b√°sico carregou');
                            log('üéâ RESULTADO: Iframe b√°sico funcionou!');
                        } else {
                            showStatus(1, 'warning', '‚ö†Ô∏è Iframe carregou mas pode estar vazio');
                            log('‚ö†Ô∏è RESULTADO: Iframe com dimens√µes suspeitas');
                        }
                    } catch (error) {
                        log(`‚ùå Erro ao verificar iframe: ${error.message}`);
                        showStatus(1, 'error', '‚ùå Erro ao verificar conte√∫do do iframe');
                    }
                }, 2000);
            };
            
            iframe.onerror = function() {
                log('‚ùå Iframe b√°sico onerror disparado');
                showStatus(1, 'error', '‚ùå ERRO! Iframe b√°sico falhou ao carregar');
            };
            
            // Timeout de seguran√ßa
            setTimeout(() => {
                const currentStatus = document.getElementById('test1-status').innerHTML;
                if (currentStatus.includes('‚è≥')) {
                    log('‚è∞ TIMEOUT: Iframe b√°sico n√£o carregou em 10 segundos');
                    showStatus(1, 'warning', '‚è∞ TIMEOUT - Iframe pode n√£o ter carregado completamente');
                }
            }, 10000);
        }

        function testMaxPermissions() {
            log('üîê INICIANDO: Teste com m√°ximas permiss√µes');
            showStatus(2, 'info', 'üîê Carregando iframe com m√°ximas permiss√µes...');
            
            const container = document.getElementById('test2-container');
            const startTime = Date.now();
            
            container.innerHTML = `
                <iframe 
                    id="max-iframe"
                    src="${authLink}"
                    width="100%" 
                    height="280"
                    frameborder="0"
                    allowfullscreen="true"
                    allowtransparency="true"
                    referrerpolicy="unsafe-url"
                    crossorigin="use-credentials"
                    allow="microphone; camera; fullscreen; display-capture; autoplay; encrypted-media; clipboard-read; clipboard-write; geolocation; cross-origin-isolated">
                </iframe>
            `;
            
            const iframe = document.getElementById('max-iframe');
            
            // Log das configura√ß√µes aplicadas
            log('üîß Configura√ß√µes aplicadas:');
            log('   - allowfullscreen: true');
            log('   - allowtransparency: true');
            log('   - referrerpolicy: unsafe-url');
            log('   - crossorigin: use-credentials');
            log('   - allow: m√°ximas permiss√µes');
            
            iframe.onload = function() {
                const loadTime = Date.now() - startTime;
                log(`‚úÖ Iframe com permiss√µes onload ap√≥s ${loadTime}ms`);
                
                setTimeout(() => {
                    try {
                        const rect = iframe.getBoundingClientRect();
                        log(`üìè Dimens√µes: ${rect.width}x${rect.height}`);
                        
                        // Tenta v√°rias verifica√ß√µes
                        let hasContent = false;
                        
                        // Verifica dimens√µes
                        if (rect.height > 200 && rect.width > 400) {
                            hasContent = true;
                            log('‚úÖ Dimens√µes indicam conte√∫do carregado');
                        }
                        
                        // Tenta acessar documento (CORS √© esperado)
                        try {
                            const doc = iframe.contentDocument;
                            if (doc) {
                                log('üìÑ Documento acess√≠vel - conte√∫do carregou');
                                hasContent = true;
                            }
                        } catch (corsError) {
                            if (corsError.name === 'SecurityError') {
                                log('üîí CORS/Security Error - ISSO √â BOM! Indica que algo carregou');
                                hasContent = true;
                            }
                        }
                        
                        if (hasContent) {
                            showStatus(2, 'success', 'üéâ SUCESSO! Iframe com permiss√µes parece ter funcionado!');
                            log('üéâ RESULTADO: Iframe com permiss√µes FUNCIONOU!');
                        } else {
                            showStatus(2, 'warning', '‚ö†Ô∏è Iframe carregou mas conte√∫do n√£o foi detectado');
                            log('‚ö†Ô∏è RESULTADO: N√£o foi poss√≠vel confirmar o conte√∫do');
                        }
                        
                    } catch (error) {
                        log(`‚ùå Erro ao verificar iframe: ${error.message}`);
                        showStatus(2, 'error', '‚ùå Erro ao verificar conte√∫do');
                    }
                }, 3000);
            };
            
            iframe.onerror = function() {
                log('‚ùå Iframe com permiss√µes onerror disparado');
                showStatus(2, 'error', '‚ùå ERRO! Iframe com permiss√µes falhou');
            };
            
            // Timeout de seguran√ßa
            setTimeout(() => {
                const currentStatus = document.getElementById('test2-status').innerHTML;
                if (currentStatus.includes('üîê')) {
                    log('‚è∞ TIMEOUT: Iframe com permiss√µes n√£o carregou em 15 segundos');
                    showStatus(2, 'warning', '‚è∞ TIMEOUT - Iframe pode n√£o ter carregado completamente');
                }
            }, 15000);
        }

        function clearTest1() {
            document.getElementById('test1-container').innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">√Årea de teste vazia</p>';
            document.getElementById('test1-status').innerHTML = '';
            log('üßπ Teste #1 limpo');
        }

        function clearTest2() {
            document.getElementById('test2-container').innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">√Årea de teste vazia</p>';
            document.getElementById('test2-status').innerHTML = '';
            log('üßπ Teste #2 limpo');
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = 'Log limpo...';
            console.clear();
        }

        // Intercepta erros do console
        window.addEventListener('error', function(e) {
            log(`‚ùå ERRO JS: ${e.message} em ${e.filename}:${e.lineno}`);
        });

        log('üéØ P√°gina de teste direto carregada');
        log('üìã Use os bot√µes para testar diferentes configura√ß√µes de iframe');
    </script>
</body>
</html>
