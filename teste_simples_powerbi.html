<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Super Simples Power BI</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.1); 
            padding: 30px; 
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 30px; }
        .test-area {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        iframe { 
            width: 100%; 
            height: 400px; 
            border: 3px solid #28a745; 
            border-radius: 5px;
            margin-top: 10px;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .log { 
            background: #343a40; 
            color: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Teste Super Simples: Power BI</h1>
        
        <div class="test-area">
            <h2>üìä Seu Link do Power BI</h2>
            <div class="info status">
                <strong>Link que voc√™ forneceu:</strong><br>
                <code style="font-size: 12px; word-break: break-all;">
                https://app.powerbi.com/reportEmbed?reportId=ef9c9663-7cec-4c9a-8b57-c1a6c895057a&autoAuth=true&ctid=0b754a09-0568-48fd-a100-8621a0bbd7ab
                </code>
            </div>
            
            <p><strong>üí° Este √© um link de embedding com autentica√ß√£o autom√°tica.</strong></p>
            <p>Links deste tipo t√™m maior chance de funcionar embedados porque:</p>
            <ul>
                <li>‚úÖ Usam o endpoint <code>/reportEmbed</code> (feito para embedding)</li>
                <li>‚úÖ Incluem <code>autoAuth=true</code> (autentica√ß√£o autom√°tica)</li>
                <li>‚úÖ T√™m <code>ctid</code> (ID da organiza√ß√£o/tenant)</li>
            </ul>
        </div>

        <div class="test-area">
            <h2>üß™ Teste do Iframe</h2>
            
            <button onclick="testarIframe()" id="btnTeste">
                üöÄ TESTAR AGORA
            </button>
            
            <button onclick="limparTeste()" class="btn-warning">
                üßπ Limpar Teste
            </button>
            
            <div id="resultado"></div>
            <div id="iframeContainer"></div>
        </div>

        <div class="test-area">
            <h2>üìã Log do Teste</h2>
            <div id="log" class="log">Aguardando teste...\n</div>
            <button onclick="limparLog()" class="btn-warning">Limpar Log</button>
        </div>
    </div>

    <script>
        const linkPowerBI = 'https://app.powerbi.com/reportEmbed?reportId=ef9c9663-7cec-4c9a-8b57-c1a6c895057a&autoAuth=true&ctid=0b754a09-0568-48fd-a100-8621a0bbd7ab';
        
        function log(mensagem) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${mensagem}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${mensagem}`);
        }

        function mostrarResultado(tipo, mensagem) {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = `<div class="${tipo} status">${mensagem}</div>`;
        }

        function testarIframe() {
            log('üöÄ INICIANDO TESTE DO IFRAME');
            log('üìä Link: ' + linkPowerBI);
            
            const btnTeste = document.getElementById('btnTeste');
            btnTeste.disabled = true;
            btnTeste.textContent = '‚è≥ Testando...';
            
            mostrarResultado('info', '‚è≥ Criando iframe e testando carregamento...');
            
            const container = document.getElementById('iframeContainer');
            const inicioTeste = Date.now();
            
            // Cria o iframe com configura√ß√µes otimizadas
            container.innerHTML = `
                <iframe 
                    id="testeIframe"
                    src="${linkPowerBI}"
                    frameborder="0"
                    allowfullscreen="true"
                    allowtransparency="true"
                    referrerpolicy="unsafe-url"
                    allow="microphone; camera; fullscreen; display-capture; autoplay; encrypted-media; clipboard-read; clipboard-write; geolocation"
                    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation allow-presentation">
                </iframe>
            `;
            
            const iframe = document.getElementById('testeIframe');
            let testeCompleto = false;
            
            log('üîß Iframe criado com configura√ß√µes otimizadas:');
            log('   ‚úÖ allowfullscreen: true');
            log('   ‚úÖ allowtransparency: true');
            log('   ‚úÖ referrerpolicy: unsafe-url');
            log('   ‚úÖ sandbox com permiss√µes m√°ximas');
            log('   ‚úÖ allow com todas as permiss√µes necess√°rias');
            
            // Monitora o carregamento
            iframe.onload = function() {
                const tempoCarregamento = Date.now() - inicioTeste;
                log(`üì° IFRAME ONLOAD disparado ap√≥s ${tempoCarregamento}ms`);
                
                // Aguarda um pouco para o conte√∫do carregar
                setTimeout(() => {
                    verificarConteudo();
                }, 3000);
            };
            
            iframe.onerror = function() {
                log('‚ùå IFRAME ONERROR disparado - erro ao carregar');
                finalizarTeste('error', '‚ùå ERRO: Iframe falhou ao carregar');
            };
            
            // Verifica periodicamente se algo mudou
            let verificacoes = 0;
            const monitoramento = setInterval(() => {
                verificacoes++;
                log(`üîç Verifica√ß√£o ${verificacoes}: Monitorando iframe...`);
                
                if (testeCompleto || verificacoes > 10) {
                    clearInterval(monitoramento);
                    return;
                }
                
                try {
                    const rect = iframe.getBoundingClientRect();
                    if (rect.height > 300) {
                        log(`üìè Iframe expandiu para ${rect.width}x${rect.height}`);
                    }
                } catch (error) {
                    log(`üîç Erro na verifica√ß√£o: ${error.message}`);
                }
            }, 2000);
            
            // Timeout final
            setTimeout(() => {
                if (!testeCompleto) {
                    log('‚è∞ TIMEOUT: Finalizando teste ap√≥s 20 segundos');
                    clearInterval(monitoramento);
                    verificarConteudo();
                }
            }, 20000);
            
            function verificarConteudo() {
                if (testeCompleto) return;
                testeCompleto = true;
                
                log('üîç VERIFICANDO RESULTADO FINAL...');
                
                try {
                    const rect = iframe.getBoundingClientRect();
                    log(`üìè Dimens√µes finais: ${rect.width}x${rect.height}`);
                    
                    let sucesso = false;
                    let motivo = '';
                    
                    // Verifica dimens√µes
                    if (rect.height > 350 && rect.width > 500) {
                        sucesso = true;
                        motivo = 'Dimens√µes indicam conte√∫do carregado';
                        log('‚úÖ DIMENS√ïES OK: Iframe tem tamanho adequado');
                    } else {
                        motivo = `Dimens√µes pequenas: ${rect.width}x${rect.height}`;
                        log('‚ö†Ô∏è DIMENS√ïES SUSPEITAS: Iframe pode estar vazio');
                    }
                    
                    // Tenta acessar o documento (CORS √© esperado e indica sucesso)
                    try {
                        const doc = iframe.contentDocument;
                        if (doc) {
                            log('üìÑ DOCUMENTO ACESS√çVEL: Conte√∫do carregou sem restri√ß√µes');
                            sucesso = true;
                            motivo = 'Documento iframe acess√≠vel';
                        }
                    } catch (corsError) {
                        if (corsError.name === 'SecurityError' || corsError.message.includes('cross-origin')) {
                            log('üîí CORS/SECURITY ERROR: ISSO √â BOM! Indica que o Power BI carregou');
                            sucesso = true;
                            motivo = 'CORS error indica conte√∫do Power BI carregado';
                        } else {
                            log(`‚ùì Erro desconhecido: ${corsError.message}`);
                        }
                    }
                    
                    // Resultado final
                    if (sucesso) {
                        log('üéâ RESULTADO: SUCESSO! O iframe parece ter funcionado!');
                        finalizarTeste('success', `üéâ SUCESSO! Iframe funcionou - ${motivo}`);
                    } else {
                        log('‚ùå RESULTADO: FALHA - Iframe n√£o carregou conte√∫do');
                        finalizarTeste('warning', `‚ö†Ô∏è FALHA: ${motivo} - Tente os links alternativos abaixo`);
                        mostrarAlternativas();
                    }
                    
                } catch (error) {
                    log(`‚ùå ERRO na verifica√ß√£o final: ${error.message}`);
                    finalizarTeste('error', '‚ùå ERRO: N√£o foi poss√≠vel verificar o conte√∫do');
                    mostrarAlternativas();
                }
            }
            
            function finalizarTeste(tipo, mensagem) {
                mostrarResultado(tipo, mensagem);
                btnTeste.disabled = false;
                btnTeste.textContent = 'üöÄ TESTAR NOVAMENTE';
                log('‚úÖ TESTE FINALIZADO');
            }
            
            function mostrarAlternativas() {
                const container = document.getElementById('iframeContainer');
                container.innerHTML += `
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 5px;">
                        <h4 style="color: #856404; margin-top: 0;">üîó Alternativas para Acessar o Relat√≥rio:</h4>
                        <p style="color: #856404;">Como o iframe n√£o funcionou, use uma dessas op√ß√µes:</p>
                        <div style="margin: 15px 0;">
                            <a href="${linkPowerBI}" target="_blank" 
                               style="display: inline-block; background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">
                                üîó Abrir em Nova Aba
                            </a>
                            <button onclick="abrirPopup()" 
                                    style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer;">
                                ü™ü Abrir em Popup
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        function abrirPopup() {
            log('ü™ü Abrindo popup otimizado');
            const width = Math.min(1400, window.screen.availWidth * 0.8);
            const height = Math.min(900, window.screen.availHeight * 0.8);
            const left = (window.screen.availWidth - width) / 2;
            const top = (window.screen.availHeight - height) / 2;
            
            const popup = window.open(
                linkPowerBI, 
                'PowerBIReport', 
                `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );
            
            if (popup) {
                log('‚úÖ Popup aberto com sucesso');
                popup.focus();
            } else {
                log('‚ùå Popup foi bloqueado pelo navegador');
                alert('Popup foi bloqueado. Permita popups para este site ou use "Nova Aba".');
            }
        }

        function limparTeste() {
            document.getElementById('iframeContainer').innerHTML = '';
            document.getElementById('resultado').innerHTML = '';
            document.getElementById('btnTeste').disabled = false;
            document.getElementById('btnTeste').textContent = 'üöÄ TESTAR AGORA';
            log('üßπ Teste limpo');
        }

        function limparLog() {
            document.getElementById('log').textContent = 'Log limpo...\n';
            console.clear();
        }

        // Inicializa√ß√£o
        log('üéØ P√°gina de teste carregada e pronta');
        log('üí° Clique em "TESTAR AGORA" para verificar se o link funciona embedado');
        
        // Intercepta erros
        window.addEventListener('error', function(e) {
            log(`‚ùå ERRO JAVASCRIPT: ${e.message}`);
        });
    </script>
</body>
</html>
