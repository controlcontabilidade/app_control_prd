{% extends "base.html" %}
{% block title %}{% if client %}Editar Cliente{% else %}Novo Cliente{% endif %}{% endblock %}

{% block head %}
<style>
.socio-card {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.socio-card:hover {
    background-color: #e9ecef;
    border-color: #dee2e6;
}

.socio-card .form-control-sm {
    font-size: 0.875rem;
}

.socio-card .form-label.small {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 2px;
}

#sociosContainer {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
    background-color: #ffffff;
}

.btn-outline-primary.btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.btn-outline-danger.btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* Estilos para os botões de visualização de senha */
.toggle-password-btn {
    border-left: none;
}

.toggle-password-btn:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
}

.toggle-password-btn:focus {
    box-shadow: none;
    border-color: #80bdff;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Formulário Principal -->
            <form method="POST" action="{{ url_for('save_client') }}" class="needs-validation" novalidate>
                <!-- Campo hidden para ID do cliente -->
                {% if client %}
                <input type="hidden" name="id" value="{{ client.id }}">
                {% if client._row_number %}
                <input type="hidden" name="row_number" value="{{ client._row_number }}">
                {% endif %}
                {% endif %}
                <!-- Bloco 1: Informações da Pessoa Física / Jurídica -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-building me-2"></i>
                            Bloco 1 - Informações da Pessoa Física / Jurídica
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Primeira linha: Nome da Empresa e Razão Social -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nomeEmpresa" class="form-label">
                                    <i class="bi bi-building me-1"></i>Nome da Empresa
                                    <span class="text-danger required-field">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="nomeEmpresa" name="nomeEmpresa" 
                                       value="{{ client.nomeEmpresa if client else '' }}" required>
                                <div class="invalid-feedback">
                                    Por favor, informe o nome da empresa.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="razaoSocialReceita" class="form-label">
                                    <i class="bi bi-file-text me-1"></i>Razão Social (Receita)
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="razaoSocialReceita" name="razaoSocialReceita"
                                       value="{{ client.razaoSocialReceita if client else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe a razão social.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Segunda linha: Nome Fantasia e CPF/CNPJ -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nomeFantasiaReceita" class="form-label">
                                    <i class="bi bi-shop me-1"></i>Nome Fantasia (Receita)
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="nomeFantasiaReceita" name="nomeFantasiaReceita"
                                       value="{{ client.nomeFantasiaReceita if client else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe o nome fantasia.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cpfCnpj" class="form-label">
                                    <i class="bi bi-card-text me-1"></i>CPF/CNPJ
                                    <span class="text-danger required-field">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="cpfCnpj" name="cpfCnpj"
                                       value="{{ client.cpfCnpj if client else '' }}" 
                                       placeholder="00.000.000/0001-00" required>
                                <div class="invalid-feedback">
                                    Por favor, informe o CPF ou CNPJ.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terceira linha: Estado, Cidade, Inscrição Estadual, Inscrição Municipal -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="estado" class="form-label">
                                    <i class="bi bi-map me-1"></i>Estado
                                    <span class="text-danger required-field">*</span>
                                </label>
                                <select class="form-select" id="estado" name="estado" required>
                                    <option value="">Selecione o estado</option>
                                    <option value="AC" {% if client and client.estado == 'AC' %}selected{% endif %}>Acre</option>
                                    <option value="AL" {% if client and client.estado == 'AL' %}selected{% endif %}>Alagoas</option>
                                    <option value="AP" {% if client and client.estado == 'AP' %}selected{% endif %}>Amapá</option>
                                    <option value="AM" {% if client and client.estado == 'AM' %}selected{% endif %}>Amazonas</option>
                                    <option value="BA" {% if client and client.estado == 'BA' %}selected{% endif %}>Bahia</option>
                                    <option value="CE" {% if client and client.estado == 'CE' %}selected{% endif %}>Ceará</option>
                                    <option value="DF" {% if client and client.estado == 'DF' %}selected{% endif %}>Distrito Federal</option>
                                    <option value="ES" {% if client and client.estado == 'ES' %}selected{% endif %}>Espírito Santo</option>
                                    <option value="GO" {% if client and client.estado == 'GO' %}selected{% endif %}>Goiás</option>
                                    <option value="MA" {% if client and client.estado == 'MA' %}selected{% endif %}>Maranhão</option>
                                    <option value="MT" {% if client and client.estado == 'MT' %}selected{% endif %}>Mato Grosso</option>
                                    <option value="MS" {% if client and client.estado == 'MS' %}selected{% endif %}>Mato Grosso do Sul</option>
                                    <option value="MG" {% if client and client.estado == 'MG' %}selected{% endif %}>Minas Gerais</option>
                                    <option value="PA" {% if client and client.estado == 'PA' %}selected{% endif %}>Pará</option>
                                    <option value="PB" {% if client and client.estado == 'PB' %}selected{% endif %}>Paraíba</option>
                                    <option value="PR" {% if client and client.estado == 'PR' %}selected{% endif %}>Paraná</option>
                                    <option value="PE" {% if client and client.estado == 'PE' %}selected{% endif %}>Pernambuco</option>
                                    <option value="PI" {% if client and client.estado == 'PI' %}selected{% endif %}>Piauí</option>
                                    <option value="RJ" {% if client and client.estado == 'RJ' %}selected{% endif %}>Rio de Janeiro</option>
                                    <option value="RN" {% if client and client.estado == 'RN' %}selected{% endif %}>Rio Grande do Norte</option>
                                    <option value="RS" {% if client and client.estado == 'RS' %}selected{% endif %}>Rio Grande do Sul</option>
                                    <option value="RO" {% if client and client.estado == 'RO' %}selected{% endif %}>Rondônia</option>
                                    <option value="RR" {% if client and client.estado == 'RR' %}selected{% endif %}>Roraima</option>
                                    <option value="SC" {% if client and client.estado == 'SC' %}selected{% endif %}>Santa Catarina</option>
                                    <option value="SP" {% if client and client.estado == 'SP' %}selected{% endif %}>São Paulo</option>
                                    <option value="SE" {% if client and client.estado == 'SE' %}selected{% endif %}>Sergipe</option>
                                    <option value="TO" {% if client and client.estado == 'TO' %}selected{% endif %}>Tocantins</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione o estado.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="cidade" class="form-label">
                                    <i class="bi bi-geo me-1"></i>Cidade
                                    <span class="text-danger required-field">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="cidade" name="cidade"
                                       value="{{ client.cidade if client else '' }}" required>
                                <div class="invalid-feedback">
                                    Por favor, informe a cidade.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="inscEst" class="form-label">
                                    <i class="bi bi-card-list me-1"></i>Inscrição Estadual
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="inscEst" name="inscEst"
                                       value="{{ client.inscEst if client else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe a inscrição estadual.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="inscMun" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Inscrição Municipal
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="inscMun" name="inscMun"
                                       value="{{ client.inscMun if client else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe a inscrição municipal.
                                </div>
                            </div>
                        
                        
                        <!-- Quarta linha: Segmento, Atividade Principal, Regime Estadual e Regime Federal -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="segmento" class="form-label">
                                    <i class="bi bi-tags me-1"></i>Segmento
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="segmento" name="segmento">
                                        <option value="">Selecione o segmento</option>
                                        {% for segmento in segmentos %}
                                        <option value="{{ segmento }}" {% if client and client.segmento == segmento %}selected{% endif %}>{{ segmento }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="window.open('/segmentos', '_blank')" title="Cadastrar novos segmentos">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">
                                    Por favor, selecione o segmento.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="atividade" class="form-label">
                                    <i class="bi bi-briefcase me-1"></i>Atividade Principal
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="atividade" name="atividade">
                                        <option value="">Selecione a atividade principal</option>
                                        {% for atividade in atividades %}
                                        <option value="{{ atividade }}" {% if client and client.atividade == atividade %}selected{% endif %}>{{ atividade }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="window.open('/atividades', '_blank')" title="Cadastrar novas atividades">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">
                                    Por favor, selecione a atividade principal.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="regimeEstadual" class="form-label">
                                    <i class="bi bi-bank me-1"></i>Regime Estadual
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <select class="form-select" id="regimeEstadual" name="regimeEstadual">
                                    <option value="">Selecione o regime estadual</option>
                                    <option value="SIMPLES" {% if client and client.regimeEstadual == 'SIMPLES' %}selected{% endif %}>Simples Nacional</option>
                                    <option value="NORMAL" {% if client and client.regimeEstadual == 'NORMAL' %}selected{% endif %}>Regime Normal</option>
                                    <option value="REGIME_ESPECIAL" {% if client and client.regimeEstadual == 'REGIME_ESPECIAL' %}selected{% endif %}>Regime Especial</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione o regime estadual.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="regimeFederal" class="form-label">
                                    <i class="bi bi-percent me-1"></i>Regime Federal
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <select class="form-select" id="regimeFederal" name="regimeFederal">
                                    <option value="">Selecione o regime federal</option>
                                    <option value="MEI" {% if client and client.regimeFederal == 'MEI' %}selected{% endif %}>MEI</option>
                                    <option value="SIMPLES_NACIONAL" {% if client and client.regimeFederal == 'SIMPLES_NACIONAL' or client.regimeFederal == 'SIMPLES' %}selected{% endif %}>Simples Nacional</option>
                                    <option value="LUCRO_PRESUMIDO" {% if client and client.regimeFederal == 'LUCRO_PRESUMIDO' %}selected{% endif %}>Lucro Presumido</option>
                                    <option value="LUCRO_REAL" {% if client and client.regimeFederal == 'LUCRO_REAL' %}selected{% endif %}>Lucro Real</option>
                                    <option value="REGIME_ESPECIAL" {% if client and client.regimeFederal == 'REGIME_ESPECIAL' %}selected{% endif %}>Regime Especial</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione o regime federal.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 2: Serviços Prestados pela Control -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-handshake me-2"></i>
                            Bloco 2: Serviços Prestados pela Control
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Primeira linha: Checkboxes dos serviços -->
                        <div class="row">
                            <!-- BPO Financeiro -->
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="bpoFinanceiro" name="bpoFinanceiro" 
                                           {% if client and client.bpoFinanceiro %}checked{% endif %}>
                                    <label class="form-check-label" for="bpoFinanceiro">
                                        <i class="bi bi-graph-up me-1 text-info"></i>
                                        <strong>BPO Financeiro</strong>
                                    </label>
                                </div>
                            </div>
                            <!-- Departamento Contábil (CT) -->
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="ct" name="ct" 
                                           {% if client and client.ct %}checked{% endif %}>
                                    <label class="form-check-label" for="ct">
                                        <i class="bi bi-calculator me-1" style="color: var(--control-primary);"></i>
                                        <strong>Departamento Contábil (CT)</strong>
                                    </label>
                                </div>
                            </div>
                            <!-- Departamento Fiscal (FS) -->
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="fs" name="fs" 
                                           {% if client and client.fs %}checked{% endif %}>
                                    <label class="form-check-label" for="fs">
                                        <i class="bi bi-file-text me-1" style="color: var(--control-secondary);"></i>
                                        <strong>Departamento Fiscal (FS)</strong>
                                    </label>
                                </div>
                            </div>
                            <!-- Departamento Pessoal (DP) -->
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dp" name="dp" 
                                           {% if client and client.dp %}checked{% endif %}>
                                    <label class="form-check-label" for="dp">
                                        <i class="bi bi-people me-1 text-success"></i>
                                        <strong>Departamento Pessoal (DP)</strong>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Segunda linha: Doméstica, Data de Início, Perfil do Cliente, Sistema Utilizado, Gera arquivo do Sped -->
                        <div class="row">
                            <!-- Doméstica -->
                            <div class="col-md-2 mb-3">
                                <label for="domestica" class="form-label">
                                    <i class="bi bi-house me-1"></i>
                                    Doméstica
                                </label>
                                <select class="form-select" id="domestica" name="domestica" disabled>
                                    <option value="NÃO" {% if not client or not client.domestica or client.domestica == 'NÃO' %}selected{% endif %}>NÃO</option>
                                    <option value="SIM" {% if client and client.domestica == 'SIM' %}selected{% endif %}>SIM</option>
                                </select>
                            </div>
                            
                            <!-- Data de Início dos Serviços -->
                            <div class="col-md-2 mb-3">
                                <label for="dataInicioServicos" class="form-label">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    Data de Início dos Serviços
                                </label>
                                <input type="text" class="form-control" id="dataInicioServicos" name="dataInicioServicos" 
                                       value="{{ client.dataInicioServicos if client else '' }}"
                                       placeholder="mm/aaaa" pattern="^(0[1-9]|1[0-2])\/\d{4}$" 
                                       title="Formato: MM/AAAA (Ex: 08/2025)">
                            </div>

                            <!-- Perfil do Cliente -->
                            <div class="col-md-2 mb-3">
                                <label for="perfilCliente" class="form-label">
                                    <i class="bi bi-person-badge me-1"></i>
                                    Perfil do Cliente *
                                </label>
                                <select class="form-select" id="perfilCliente" name="perfilCliente" required>
                                    <option value="">Selecione um perfil</option>
                                    <option value="A" {% if client and client.perfilCliente == 'A' %}selected{% endif %}>A</option>
                                    <option value="B" {% if client and client.perfilCliente == 'B' %}selected{% endif %}>B</option>
                                    <option value="C" {% if client and client.perfilCliente == 'C' %}selected{% endif %}>C</option>
                                    <option value="D" {% if client and client.perfilCliente == 'D' %}selected{% endif %}>D</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione o perfil do cliente.
                                </div>
                            </div>

                            <!-- Sistema Utilizado -->
                            <div class="col-md-2 mb-3">
                                <label for="sistemaUtilizado" class="form-label">
                                    <i class="bi bi-pc-display me-1"></i>
                                    Sistema Utilizado
                                </label>
                                <input type="text" class="form-control" id="sistemaUtilizado" name="sistemaUtilizado" 
                                       value="{{ client.sistemaUtilizado if client else '' }}"
                                       placeholder="Nome do sistema principal">
                            </div>

                            <!-- Gera arquivo do Sped -->
                            <div class="col-md-2 mb-3">
                                <label for="geraArquivoSped" class="form-label">
                                    <i class="bi bi-file-earmark-code me-1"></i>
                                    Gera arquivo do Sped
                                </label>
                                <select class="form-select" id="geraArquivoSped" name="geraArquivoSped">
                                    <option value="">Selecionar SIM/NÃO</option>
                                    <option value="SIM" {% if client and client.geraArquivoSped == 'SIM' %}selected{% endif %}>SIM</option>
                                    <option value="NÃO" {% if client and client.geraArquivoSped == 'NÃO' %}selected{% endif %}>NÃO</option>
                                </select>
                            </div>
                        </div>

                        <!-- Terceira linha: Códigos dos sistemas -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="codDominio" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    # Cód. Domínio
                                </label>
                                <input type="text" class="form-control numbers-only" id="codDominio" name="codDominio" 
                                       value="{{ client.codDominio if client else '' }}"
                                       placeholder="Código Domínio" pattern="[0-9]*" title="Apenas números">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codFortesCt" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    # Cód. Fortes CT
                                </label>
                                <input type="text" class="form-control numbers-only" id="codFortesCt" name="codFortesCt" 
                                       value="{{ client.codFortesCt if client else '' }}"
                                       placeholder="Código CT" pattern="[0-9]*" title="Apenas números">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codFortesFs" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    # Cód. Fortes FS
                                </label>
                                <input type="text" class="form-control numbers-only" id="codFortesFs" name="codFortesFs" 
                                       value="{{ client.codFortesFs if client else '' }}"
                                       placeholder="Código FS" pattern="[0-9]*" title="Apenas números">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codFortesPs" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    # Cód. Fortes PS
                                </label>
                                <input type="text" class="form-control numbers-only" id="codFortesPs" name="codFortesPs" 
                                       value="{{ client.codFortesPs if client else '' }}"
                                       placeholder="Código PS" pattern="[0-9]*" title="Apenas números">
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Bloco 3: Quadro Societário -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-people me-2"></i>
                            Bloco 3: Quadro Societário
                        </h5>
                    </div>
                    <div class="card-body">
            <!-- Campos removidos: E-MAIL SECUNDÁRIO, RESPONSÁVEL IMEDIATO -->
                        <div class="row">
                            <!-- BLOCO 3: QUADRO SOCIETÁRIO -->
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-people-fill me-1"></i>SÓCIOS DA EMPRESA
                                    </label>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="adicionarSocio()">
                                        <i class="bi bi-plus-circle me-1"></i>Adicionar Sócio
                                    </button>
                                </div>
                                
                                <!-- Container para os sócios -->
                                <div id="sociosContainer">
                                    <!-- Sócio 1 (sempre presente) -->
                                    <div class="card border-light mb-2 socio-card" id="socio_1">
                                        <div class="card-body py-3">
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome do Sócio</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="socio_1_nome" id="socio_1_nome"
                                                           value="{{ client.socio_1_nome if client else '' }}"
                                                           placeholder="Nome completo do sócio">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">CPF</label>
                                                    <input type="text" class="form-control form-control-sm cpf-mask" 
                                                           name="socio_1_cpf" id="socio_1_cpf"
                                                           value="{{ client.socio_1_cpf if client else '' }}"
                                                           placeholder="000.000.000-00">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">Data de Nascimento</label>
                                                    <input type="date" class="form-control form-control-sm" 
                                                           name="socio_1_data_nascimento" id="socio_1_data_nascimento"
                                                           value="{{ client.socio_1_data_nascimento if client else '' }}">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">% de Quotas</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="socio_1_participacao" id="socio_1_participacao"
                                                           value="{{ client.socio_1_participacao if client else '' }}"
                                                           placeholder="50.00" step="0.01" min="0" max="100">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input representante-legal" type="radio" 
                                                                       name="representante_legal" value="socio_1" 
                                                                       id="rep_legal_1"
                                                                       {% if client and client.socio_1_resp_legal %}checked{% endif %}>
                                                                <label class="form-check-label small" for="rep_legal_1">
                                                                    Representante Legal
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input socio-admin" type="checkbox" 
                                                                       name="socio_1_administrador" value="1" 
                                                                       id="admin_1"
                                                                       {% if client and client.socio_1_administrador %}checked{% endif %}>
                                                                <label class="form-check-label small" for="admin_1">
                                                                    Sócio Administrador
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                <!-- Campo removido: E-MAILS ADICIONAIS DOS SÓCIOS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 4: Contatos -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge me-2"></i>
                            Bloco 4: Contatos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- CONTATOS DA EMPRESA -->
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-telephone-fill me-1"></i>CONTATOS DA EMPRESA
                                    </label>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="adicionarContato()">
                                        <i class="bi bi-plus-circle me-1"></i>Adicionar Contato
                                    </button>
                                </div>
                                
                                <!-- Container para os contatos -->
                                <div id="contatosContainer">
                                    <!-- Contato 1 (sempre presente) -->
                                    <div class="card border-light mb-2 contato-card" id="contato_1">
                                        <div class="card-body py-3">
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_1_nome" id="contato_1_nome"
                                                           value="{{ client.contato_1_nome if client and client.contato_1_nome else '' }}"
                                                           placeholder="Nome completo do contato">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Cargo</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_1_cargo" id="contato_1_cargo"
                                                           value="{{ client.contato_1_cargo if client and client.contato_1_cargo else '' }}"
                                                           placeholder="Ex: Gerente, Diretor, Sócio">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Telefone</label>
                                                    <input type="tel" class="form-control form-control-sm phone-mask" 
                                                           name="contato_1_telefone" id="contato_1_telefone"
                                                           value="{{ client.contato_1_telefone if client and client.contato_1_telefone else '' }}"
                                                           placeholder="(85) 99999-9999">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">E-mail</label>
                                                    <input type="email" class="form-control form-control-sm" 
                                                           name="contato_1_email" id="contato_1_email"
                                                           value="{{ client.contato_1_email if client and client.contato_1_email else '' }}"
                                                           placeholder="contato@empresa.com">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 5: Senhas -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-key me-2"></i>Bloco 5: Senhas
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Linha 1: CPF/CNPJ SN, Código Acesso SN, Acesso EmpWeb, Senha EmpWeb -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <label for="cpfCnpjSn" class="form-label small">CPF/CNPJ SN</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="cpfCnpjSn" name="cpfCnpjSn" 
                                       value="{{ client.cpfCnpjSn if client else '' }}" 
                                       placeholder="CPF/CNPJ Simples Nacional">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="codigoAcessoSn" class="form-label small">Código Acesso SN</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="codigoAcessoSn" name="codigoAcessoSn" 
                                       value="{{ client.codigoAcessoSn if client else '' }}" 
                                       placeholder="Código de acesso">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="acessoEmpWeb" class="form-label small">Acesso EmpWeb</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoEmpWeb" name="acessoEmpWeb" 
                                       value="{{ client.acessoEmpWeb if client else '' }}" 
                                       placeholder="Login EmpWeb">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="senhaEmpWeb" class="form-label small">Senha EmpWeb</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaEmpWeb" name="senhaEmpWeb" 
                                       value="{{ client.senhaEmpWeb if client else '' }}" 
                                       placeholder="Senha EmpWeb">
                            </div>
                        </div>

                        <!-- Linha 2: Acesso ISS, Acesso SEFIN, Acesso SEUMA, Acesso SEMACE -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <label for="acessoIss" class="form-label small">Acesso ISS</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoIss" name="acessoIss" 
                                       value="{{ client.acessoIss if client else '' }}" 
                                       placeholder="Login ISS">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="acessoSefin" class="form-label small">Acesso SEFIN</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoSefin" name="acessoSefin" 
                                       value="{{ client.acessoSefin if client else '' }}" 
                                       placeholder="Login SEFIN">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="acessoSeuma" class="form-label small">Acesso SEUMA</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoSeuma" name="acessoSeuma" 
                                       value="{{ client.acessoSeuma if client else '' }}" 
                                       placeholder="Login SEUMA">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="acessoSemace" class="form-label small">Acesso SEMACE</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoSemace" name="acessoSemace" 
                                       value="{{ client.acessoSemace if client else '' }}" 
                                       placeholder="Login SEMACE">
                            </div>
                        </div>

                        <!-- Linha 3: Acesso IBAMA, Acesso FAP/INSS, Acesso CRF, Senha SEMACE -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <label for="acessoIbama" class="form-label small">Acesso IBAMA</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoIbama" name="acessoIbama" 
                                       value="{{ client.acessoIbama if client else '' }}" 
                                       placeholder="Login IBAMA">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="acessoFapInss" class="form-label small">Acesso FAP/INSS</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoFapInss" name="acessoFapInss" 
                                       value="{{ client.acessoFapInss if client else '' }}" 
                                       placeholder="Login FAP/INSS">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="acessoCrf" class="form-label small">Acesso CRF</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoCrf" name="acessoCrf" 
                                       value="{{ client.acessoCrf if client else '' }}" 
                                       placeholder="Login CRF">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="senhaSemace" class="form-label small">Senha SEMACE</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaSemace" name="senhaSemace" 
                                       value="{{ client.senhaSemace if client else '' }}" 
                                       placeholder="Senha SEMACE">
                            </div>
                        </div>

                        <!-- Linha 4: ANVISA Gestor, ANVISA Empresa -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <label for="anvisaGestor" class="form-label small">ANVISA Gestor</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="anvisaGestor" name="anvisaGestor" 
                                       value="{{ client.anvisaGestor if client else '' }}" 
                                       placeholder="ANVISA Gestor">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="anvisaEmpresa" class="form-label small">ANVISA Empresa</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="anvisaEmpresa" name="anvisaEmpresa" 
                                       value="{{ client.anvisaEmpresa if client else '' }}" 
                                       placeholder="ANVISA Empresa">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 6: Procurações -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text me-2"></i>Bloco 6: Procurações
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Procurações em uma única linha -->
                        <div class="row mb-3">
                            <!-- Proc. Receita -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procReceita" name="procReceita" 
                                           onchange="toggleProcuracaoData('procReceita', 'dataProcReceita')"
                                           {% if client and client.procReceita %}checked{% endif %}>
                                    <label class="form-check-label small" for="procReceita">
                                        <strong>Proc. Receita</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcReceita" name="dataProcReceita" 
                                       value="{{ client.dataProcReceita if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>

                            <!-- Proc. DTe -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procDte" name="procDte" 
                                           onchange="toggleProcuracaoData('procDte', 'dataProcDte')"
                                           {% if client and client.procDte %}checked{% endif %}>
                                    <label class="form-check-label small" for="procDte">
                                        <strong>Proc. DTe</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcDte" name="dataProcDte" 
                                       value="{{ client.dataProcDte if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>

                            <!-- Proc. Caixa -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procCaixa" name="procCaixa" 
                                           onchange="toggleProcuracaoData('procCaixa', 'dataProcCaixa')"
                                           {% if client and client.procCaixa %}checked{% endif %}>
                                    <label class="form-check-label small" for="procCaixa">
                                        <strong>Proc. Caixa</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcCaixa" name="dataProcCaixa" 
                                       value="{{ client.dataProcCaixa if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>

                            <!-- Proc. Emp. Web -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procEmpWeb" name="procEmpWeb" 
                                           onchange="toggleProcuracaoData('procEmpWeb', 'dataProcEmpWeb')"
                                           {% if client and client.procEmpWeb %}checked{% endif %}>
                                    <label class="form-check-label small" for="procEmpWeb">
                                        <strong>Proc. Emp. Web</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcEmpWeb" name="dataProcEmpWeb" 
                                       value="{{ client.dataProcEmpWeb if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>

                            <!-- Proc. DET -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procDet" name="procDet" 
                                           onchange="toggleProcuracaoData('procDet', 'dataProcDet')"
                                           {% if client and client.procDet %}checked{% endif %}>
                                    <label class="form-check-label small" for="procDet">
                                        <strong>Proc. DET</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcDet" name="dataProcDet" 
                                       value="{{ client.dataProcDet if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 7: Observações e Dados Adicionais -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-sticky-note me-2"></i>Bloco 7: Observações e Dados Adicionais
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Observações Gerais -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="observacoes" class="form-label">
                                    <i class="fas fa-sticky-note me-2"></i>OBSERVAÇÕES GERAIS
                                </label>
                                <textarea class="form-control" id="observacoes" name="observacoes" rows="4" 
                                          placeholder="Digite aqui observações gerais sobre o cliente...">{{ client.observacoes if client else '' }}</textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Este campo será exibido no "Ver Detalhes" do cliente para consulta rápida
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- status do cliente -->
                            <div class="col-md-6 mb-3">
                                <label for="statusCliente" class="form-label">STATUS DO CLIENTE</label>
                                <select class="form-select" id="statusCliente" name="statusCliente">
                                    <option value="ativo" {{ 'selected' if client and client.statusCliente == 'ativo' else '' }}>Ativo</option>
                                    <option value="inativo" {{ 'selected' if client and client.statusCliente == 'inativo' else '' }}>Inativo</option>
                                </select>
                            </div>
                            <!-- Data da última atualização -->
                            <div class="col-md-6 mb-3">
                                <label for="ultimaAtualizacao" class="form-label">Última atualização</label>
                                <input type="datetime-local" class="form-control" id="ultimaAtualizacao" name="ultimaAtualizacao" 
                                       value="{{ client.ultimaAtualizacao[:19] if client and client.ultimaAtualizacao else '' }}" readonly>
                                <div class="form-text">Atualizado automaticamente</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de ação -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="submit" class="btn btn-primary me-3">
                                    <i class="bi bi-check-lg me-1"></i>
                                    {% if client %}Atualizar Cliente{% else %}Salvar Cliente{% endif %}
                                </button>
                                <a href="/" class="btn btn-secondary">
                                    <i class="bi bi-x-lg me-1"></i>
                                    Cancelar
                                </a>
                            </div>
                            {% if client %}
                            <button type="button" class="btn btn-outline-danger" 
                                    onclick="confirmDelete('{{ client.id }}', '{{ client.nomeEmpresa }}')">
                                <i class="bi bi-trash me-1"></i>
                                Excluir Cliente
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmação de exclusão -->
{% if client %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o cliente <strong id="clientName">{{ client.nomeEmpresa }}</strong>?</p>
                <p class="text-muted">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" method="POST" action="/client/{{ client.id }}/delete" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Excluir
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// =============================================================================
// (Removido bloco duplicado de DOMContentLoaded; lógica consolidada abaixo)
// =============================================================================

// Aplicar máscaras aos campos existentes
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{4,5})(\d{4})$/, '$1-$2');
    }
    input.value = value;
}

// Aplicar formatação de telefone (se existir o campo específico)
const telCont = document.getElementById('telefoneContador');
if (telCont) {
    telCont.addEventListener('input', function() {
        formatPhone(this);
    });
}

// Formatação de CPF
function formatCPF(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }
    input.value = value;
}

// Formatação de Data (DD/MM/AAAA)
function formatDate(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 8) {
        value = value.replace(/(\d{2})(\d)/, '$1/$2');
        value = value.replace(/(\d{2})\/(\d{2})(\d)/, '$1/$2/$3');
    }
    input.value = value;
}

// Aplicar máscaras aos campos existentes
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM carregado - iniciando configurações');
    
    // =============================================================
    // CONFIGURAR EVENT LISTENER DO CPF/CNPJ (PRIMEIRA PRIORIDADE)
    // =============================================================
    console.log('🔗 Configurando event listener do CPF/CNPJ...');
    const cpfCnpjInput = document.getElementById('cpfCnpj');
    const domesticaSelect = document.getElementById('domestica');
    
    console.log('📍 Campo CPF/CNPJ encontrado:', !!cpfCnpjInput);
    console.log('🏠 Campo Doméstica encontrado:', !!domesticaSelect);
    
    if (cpfCnpjInput) {
        const onCpfCnpjChange = function(e) {
            console.log('🎯 CPF/CNPJ INPUT EVENT DISPARADO!');
            console.log('📝 Valor recebido:', e.target.value);
            
            let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é dígito
            console.log('🔢 Valor limpo:', value, 'Length:', value.length);
            
            if (value.length <= 11) {
                // Formato CPF: 999.999.999-99
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else if (value.length <= 14) {
                // Formato CNPJ: 99.999.999/9999-99
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            
            e.target.value = value;
            
            // Feedback visual para o usuário
            const label = document.querySelector('label[for="cpfCnpj"]');
            const cleanValue = value.replace(/\D/g, '');
            
            if (cleanValue.length === 11) {
                label.innerHTML = '<i class="bi bi-person me-1"></i>CPF <span class="text-danger">*</span>';
                console.log('👤 Label atualizado para CPF');
            } else if (cleanValue.length === 14) {
                label.innerHTML = '<i class="bi bi-building me-1"></i>CNPJ <span class="text-danger">*</span>';
                console.log('🏢 Label atualizado para CNPJ');
            } else {
                label.innerHTML = '<i class="bi bi-card-text me-1"></i>CPF/CNPJ <span class="text-danger">*</span>';
                console.log('📄 Label resetado');
            }
            
            // CONTROLE DO CAMPO DOMÉSTICA
            if (domesticaSelect) {
                const numeros = value.replace(/\D/g, '');
                console.log('🔍 Controlando Doméstica - Números:', numeros, 'Length:', numeros.length);
                
                if (numeros.length === 11) {
                    // CPF completo - Habilitar Doméstica
                    domesticaSelect.disabled = false;
                    console.log('✅ CPF COMPLETO - HABILITANDO Doméstica');
                } else if (numeros.length === 14) {
                    // CNPJ completo - Desabilitar Doméstica e forçar NÃO
                    domesticaSelect.disabled = true;
                    domesticaSelect.value = 'NÃO';
                    console.log('🏢 CNPJ COMPLETO - DESABILITANDO Doméstica');
                } else {
                    // Incompleto - Desabilitar Doméstica
                    domesticaSelect.disabled = true;
                    domesticaSelect.value = 'NÃO';
                    console.log('❌ INCOMPLETO - DESABILITANDO Doméstica');
                }
                
                console.log('📊 Estado final - disabled:', domesticaSelect.disabled, 'value:', domesticaSelect.value);
            } else {
                console.error('❌ Campo Doméstica não encontrado!');
            }
        };
        cpfCnpjInput.addEventListener('input', onCpfCnpjChange);
        cpfCnpjInput.addEventListener('change', onCpfCnpjChange);
        cpfCnpjInput.addEventListener('blur', function(){
            // Dispara com evento sintético para reaplicar regras no blur
            cpfCnpjInput.dispatchEvent(new Event('input'));
        });
        
        console.log('✅ Event listener do CPF/CNPJ configurado com sucesso!');
        
        // Configurar estado inicial baseado no valor atual (para edição)
        if (cpfCnpjInput.value) {
            console.log('🔄 Configurando estado inicial baseado no valor atual:', cpfCnpjInput.value);
            cpfCnpjInput.dispatchEvent(new Event('input'));
        }
    } else {
        console.error('❌ Campo CPF/CNPJ não encontrado!');
    }
    
    // =============================================================
    // RESTANTE DAS CONFIGURAÇÕES
    // =============================================================
    
    // Aplicar máscara de CPF
    document.querySelectorAll('.cpf-mask').forEach(function(input) {
        input.addEventListener('input', function() {
            formatCPF(this);
        });
    });
    
    // Aplicar máscara de telefone
    document.querySelectorAll('.phone-mask').forEach(function(input) {
        input.addEventListener('input', function() {
            formatPhone(this);
        });
    });

    // Aplicar máscara de data (DD/MM/AAAA)
    document.querySelectorAll('.date-mask').forEach(function(input) {
        input.addEventListener('input', function() {
            formatDate(this);
        });
    });

    // Funcionalidade para campos que só aceitam números
    document.querySelectorAll('.numbers-only').forEach(function(input) {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    });

    // Máscara para data MM/AAAA
    const dataInicioInput = document.getElementById('dataInicioServicos');
    if (dataInicioInput) {
        dataInicioInput.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, ''); // Remove tudo que não é dígito
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 6);
            }
            
            this.value = value;
        });
    }

    // Configurar controle de representante legal (apenas um pode ser selecionado)
    setTimeout(function() {
        configurarControleSocios();
    }, 100);

    // Inicializar estado dos campos de procuração
    inicializarProcuracoes();
    console.log('📋 Procurações inicializadas');

    // Inicializar validação de campos obrigatórios
    inicializarValidacaoCampos();
    console.log('✅ Validação de campos inicializada');

    // Adicionar validação no submit do formulário
    const form = document.querySelector('form.needs-validation');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('📝 Submit do formulário interceptado');
            
            // Sempre adicionar classe para mostrar validação visual
            form.classList.add('was-validated');
            
            if (!validarFormulario(this)) {
                e.preventDefault();
                e.stopPropagation();
                console.log('❌ Submit cancelado devido a erros de validação');
                return false;
            }
            
            console.log('✅ Formulário válido, enviando...');
        });
        
        console.log('✅ Event listener de submit adicionado');
    } else {
        console.error('❌ Formulário não encontrado!');
    }

    // Carregar dados dos sócios e contatos se estiver editando
    {% if client %}
    const dadosCliente = {{ client|tojson }};
    carregarSocios(dadosCliente);
    carregarContatos(dadosCliente);
    {% endif %}

    // Forçar caixa alta nos inputs
    document.querySelectorAll('.upper-input').forEach(function(input) {
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });
    console.log('✅ Inputs uppercase configurados');
});

// Função para configurar controles dos sócios
function configurarControleSocios() {
    console.log('👥 Configurando controles dos sócios');
    
    // Adicionar eventos para todos os radio buttons de representante legal existentes
    document.querySelectorAll('.representante-legal').forEach(function(radio) {
        radio.addEventListener('change', function() {
            if (this.checked) {
                console.log('✅ Representante legal selecionado:', this.value);
            }
        });
    });
    
    console.log('✅ Controles de sócios configurados');
}

// Variável global para controlar o número de sócios
let numeroSocios = 1;

// Variável global para controlar o número de contatos
let numeroContatos = 1;

// Função para adicionar novo sócio
function adicionarSocio() {
    numeroSocios++;
    const container = document.getElementById('sociosContainer');
    
    const novoSocio = document.createElement('div');
    novoSocio.className = 'card border-light mb-2 socio-card';
    novoSocio.id = `socio_${numeroSocios}`;
    
    novoSocio.innerHTML = `
        <div class="card-body py-3">
            <div class="row align-items-center">
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Nome do Sócio</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="socio_${numeroSocios}_nome" id="socio_${numeroSocios}_nome"
                           placeholder="Nome completo do sócio">
                </div>
                <div class="col-md-2 mb-2">
                    <label class="form-label small mb-1">CPF</label>
                    <input type="text" class="form-control form-control-sm cpf-mask" 
                           name="socio_${numeroSocios}_cpf" id="socio_${numeroSocios}_cpf"
                           placeholder="000.000.000-00">
                </div>
                <div class="col-md-2 mb-2">
                    <label class="form-label small mb-1">Data de Nascimento</label>
                    <input type="date" class="form-control form-control-sm" 
                           name="socio_${numeroSocios}_data_nascimento" id="socio_${numeroSocios}_data_nascimento">
                </div>
                <div class="col-md-2 mb-2">
                    <label class="form-label small mb-1">% de Quotas</label>
                    <input type="number" class="form-control form-control-sm" 
                           name="socio_${numeroSocios}_participacao" id="socio_${numeroSocios}_participacao"
                           placeholder="50.00" step="0.01" min="0" max="100">
                </div>
                <div class="col-md-2 mb-2">
                    <div class="row">
                        <div class="col-12 mb-1">
                            <div class="form-check">
                                <input class="form-check-input representante-legal" type="radio" 
                                       name="representante_legal" value="socio_${numeroSocios}" 
                                       id="rep_legal_${numeroSocios}">
                                <label class="form-check-label small" for="rep_legal_${numeroSocios}">
                                    Representante Legal
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input socio-admin" type="checkbox" 
                                       name="socio_${numeroSocios}_administrador" value="1" 
                                       id="admin_${numeroSocios}">
                                <label class="form-check-label small" for="admin_${numeroSocios}">
                                    Sócio Administrador
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-1 mb-2">
                    <label class="form-label small mb-1">&nbsp;</label>
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                            onclick="removerSocio(${numeroSocios})" title="Remover sócio">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(novoSocio);
    
    // Aplicar máscaras aos novos campos
    const novoCpfInput = novoSocio.querySelector('.cpf-mask');
    
    if (novoCpfInput) {
        novoCpfInput.addEventListener('input', function() {
            formatCPF(this);
        });
    }
    
    // Aplicar eventos para controle de representante legal
    const radioRepresentante = novoSocio.querySelector('.representante-legal');
    if (radioRepresentante) {
        radioRepresentante.addEventListener('change', function() {
            if (this.checked) {
                console.log('✅ Representante legal selecionado:', this.value);
            }
        });
    }
    
    // Animação de entrada
    novoSocio.style.opacity = '0';
    novoSocio.style.transform = 'translateY(-20px)';
    setTimeout(() => {
        novoSocio.style.transition = 'all 0.3s ease';
        novoSocio.style.opacity = '1';
        novoSocio.style.transform = 'translateY(0)';
    }, 10);
}

// Função para remover sócio
function removerSocio(numero) {
    const socio = document.getElementById(`socio_${numero}`);
    if (socio && numero > 1) { // Não permite remover o primeiro sócio
        // Animação de saída
        socio.style.transition = 'all 0.3s ease';
        socio.style.opacity = '0';
        socio.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            socio.remove();
        }, 300);
    }
}

// Função para carregar dados dos sócios (para edição)
function carregarSocios(dadosCliente) {
    if (!dadosCliente) return;
    
    // Procurar por campos de sócios nos dados do cliente
    for (let i = 1; i <= 10; i++) { // Suporte para até 10 sócios
        const nome = dadosCliente[`socio_${i}_nome`];
        if (nome) {
            if (i > 1) {
                adicionarSocio(); // Adicionar card de sócio se não for o primeiro
            }
            
            // Preencher os campos
            const nomeInput = document.getElementById(`socio_${i}_nome`);
            const cpfInput = document.getElementById(`socio_${i}_cpf`);
            const dataNascInput = document.getElementById(`socio_${i}_data_nascimento`);
            const participacaoInput = document.getElementById(`socio_${i}_participacao`);
            const repLegalInput = document.getElementById(`rep_legal_${i}`);
            const adminInput = document.getElementById(`admin_${i}`);
            
            if (nomeInput) nomeInput.value = nome || '';
            if (cpfInput) cpfInput.value = dadosCliente[`socio_${i}_cpf`] || '';
            if (dataNascInput) dataNascInput.value = dadosCliente[`socio_${i}_data_nascimento`] || '';
            if (participacaoInput) participacaoInput.value = dadosCliente[`socio_${i}_participacao`] || '';
            if (repLegalInput && dadosCliente.representante_legal === `socio_${i}`) repLegalInput.checked = true;
            if (adminInput && dadosCliente[`socio_${i}_administrador`]) adminInput.checked = true;
        }
    }
}

function carregarContatos(dadosCliente) {
    if (!dadosCliente) return;
    
    // Procurar por campos de contatos nos dados do cliente
    for (let i = 1; i <= 10; i++) { // Suporte para até 10 contatos
        const nome = dadosCliente[`contato_${i}_nome`];
        if (nome) {
            if (i > 1) {
                adicionarContato(); // Adicionar card de contato se não for o primeiro
            }
            
            // Preencher os campos
            const nomeInput = document.getElementById(`contato_${i}_nome`);
            const cargoInput = document.getElementById(`contato_${i}_cargo`);
            const telefoneInput = document.getElementById(`contato_${i}_telefone`);
            const emailInput = document.getElementById(`contato_${i}_email`);
            
            if (nomeInput) nomeInput.value = nome || '';
            if (cargoInput) cargoInput.value = dadosCliente[`contato_${i}_cargo`] || '';
            if (telefoneInput) telefoneInput.value = dadosCliente[`contato_${i}_telefone`] || '';
            if (emailInput) emailInput.value = dadosCliente[`contato_${i}_email`] || '';
        }
    }
}

// Função para confirmar exclusão
function confirmDelete(clientId, clientName) {
    document.getElementById('clientName').textContent = clientName;
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

// Funções para gerenciar contatos
function adicionarContato() {
    numeroContatos++;
    const container = document.getElementById('contatosContainer');
    
    const novoContato = document.createElement('div');
    novoContato.className = 'card border-light mb-2 contato-card';
    novoContato.id = `contato_${numeroContatos}`;
    novoContato.innerHTML = `
        <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-secondary">Contato ${numeroContatos}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerContato(${numeroContatos})" title="Remover contato">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="row align-items-center">
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Nome</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="contato_${numeroContatos}_nome" id="contato_${numeroContatos}_nome"
                           placeholder="Nome completo do contato">
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Cargo</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="contato_${numeroContatos}_cargo" id="contato_${numeroContatos}_cargo"
                           placeholder="Ex: Gerente, Diretor, Sócio">
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Telefone</label>
                    <input type="tel" class="form-control form-control-sm phone-mask" 
                           name="contato_${numeroContatos}_telefone" id="contato_${numeroContatos}_telefone"
                           placeholder="(85) 99999-9999">
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">E-mail</label>
                    <input type="email" class="form-control form-control-sm" 
                           name="contato_${numeroContatos}_email" id="contato_${numeroContatos}_email"
                           placeholder="contato@empresa.com">
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(novoContato);
    
    // Aplicar máscara ao novo campo de telefone
    const phoneInput = novoContato.querySelector('.phone-mask');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            formatPhone(this);
        });
    }
}

function removerContato(numero) {
    // Não permitir remover o primeiro contato
    if (numero === 1) {
        alert('O primeiro contato não pode ser removido!');
        return;
    }
    
    const card = document.getElementById(`contato_${numero}`);
    if (card) {
        card.remove();
    }
}

// Função para controlar habilitação/desabilitação dos campos de procuração
function toggleProcuracaoData(checkboxId, dataInputId) {
    console.log('🔄 toggleProcuracaoData chamada:', checkboxId, dataInputId);
    
    const checkbox = document.getElementById(checkboxId);
    const dataInput = document.getElementById(dataInputId);
    
    console.log('📦 Elementos encontrados:', {
        checkbox: checkbox ? 'SIM' : 'NÃO',
        dataInput: dataInput ? 'SIM' : 'NÃO',
        checkboxChecked: checkbox ? checkbox.checked : 'N/A'
    });
    
    if (checkbox && dataInput) {
        if (checkbox.checked) {
            dataInput.disabled = false;
            dataInput.focus();
            console.log('✅ Campo habilitado:', dataInputId);
        } else {
            dataInput.disabled = true;
            dataInput.value = '';
            console.log('❌ Campo desabilitado:', dataInputId);
        }
    } else {
        console.error('⚠️ Elementos não encontrados!', {checkboxId, dataInputId});
    }
}

// Função para inicializar o estado dos campos de procuração
function inicializarProcuracoes() {
    console.log('🚀 Inicializando procurações...');
    
    const procuracoes = [
        ['procReceita', 'dataProcReceita'],
        ['procDte', 'dataProcDte'],
        ['procCaixa', 'dataProcCaixa'],
        ['procEmpWeb', 'dataProcEmpWeb'],
        ['procDet', 'dataProcDet']
    ];
    
    procuracoes.forEach(function([checkboxId, dataInputId]) {
        const checkbox = document.getElementById(checkboxId);
        const dataInput = document.getElementById(dataInputId);
        
        console.log(`🔍 Verificando ${checkboxId}:`, {
            checkbox: checkbox ? 'ENCONTRADO' : 'NÃO ENCONTRADO',
            dataInput: dataInput ? 'ENCONTRADO' : 'NÃO ENCONTRADO',
            checked: checkbox ? checkbox.checked : 'N/A'
        });
        
        if (checkbox && dataInput) {
            // Definir estado inicial baseado no checkbox
            dataInput.disabled = !checkbox.checked;
            console.log(`✅ ${dataInputId} inicializado - disabled: ${dataInput.disabled}`);
        } else {
            console.error(`❌ Erro ao encontrar elementos para ${checkboxId}/${dataInputId}`);
        }
    });
    
    console.log('✅ Inicialização de procurações concluída');
}

// Função para inicializar todas as validações de campos
function inicializarValidacaoCampos() {
    console.log('🔧 Inicializando validações de campos...');
    
    const cpfCnpjInput = document.getElementById('cpfCnpj');
    const conditionalFields = document.querySelectorAll('.conditional-required');
    
    function updateRequiredFields() {
    const value = cpfCnpjInput.value.replace(/\D/g, '');
    const isCPF = value.length === 11;
    const isCNPJ = value.length === 14;
        
        console.log('🔄 Atualizando campos obrigatórios:', {
            value: value,
            length: value.length,
            isCPF: isCPF
        });
        
        // Se for CPF (11 dígitos), só obrigar: Nome da Empresa, CPF, Estado, Cidade
        if (isCPF) {
            // Ocultar asteriscos condicionais
            conditionalFields.forEach(span => {
                span.style.display = 'none';
            });
            
            // Remover required dos campos condicionais
            ['razaoSocialReceita', 'nomeFantasiaReceita', 'inscEst', 'inscMun', 
             'segmento', 'atividade', 'regimeEstadual', 'regimeFederal'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.removeAttribute('required');
            });
            
            console.log('👤 Modo CPF: campos opcionais configurados');
        } else if (isCNPJ) {
            // Se for CNPJ (14 dígitos), todos os campos são obrigatórios
            conditionalFields.forEach(span => {
                span.style.display = 'inline';
            });
            
            // Adicionar required aos campos condicionais
            ['razaoSocialReceita', 'nomeFantasiaReceita', 'inscEst', 'inscMun', 
             'segmento', 'atividade', 'regimeEstadual', 'regimeFederal'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.setAttribute('required', 'required');
            });
            
            console.log('🏢 Modo CNPJ: todos os campos obrigatórios');
        } else {
            // Incompleto: manter sem obrigatoriedade extra e ocultar asteriscos
            conditionalFields.forEach(span => {
                span.style.display = 'none';
            });
            ['razaoSocialReceita', 'nomeFantasiaReceita', 'inscEst', 'inscMun', 
             'segmento', 'atividade', 'regimeEstadual', 'regimeFederal'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.removeAttribute('required');
            });
            console.log('⏳ CPF/CNPJ incompleto: requisitos condicionais desativados');
        }
    }
    
    // Executar ao carregar a página
    if (cpfCnpjInput) {
        updateRequiredFields();
        
        // Adicionar evento para atualizar quando CPF/CNPJ mudar
        cpfCnpjInput.addEventListener('input', updateRequiredFields);
        console.log('✅ Event listener do CPF/CNPJ adicionado');
    } else {
        console.error('❌ Campo CPF/CNPJ não encontrado!');
    }
}

// Função para validar formulário antes do submit
function validarFormulario(form) {
    console.log('🔍 Validando formulário...');
    
    const cpfCnpjInput = document.getElementById('cpfCnpj');
    const nomeEmpresaInput = document.getElementById('nomeEmpresa');
    const estadoSelect = document.getElementById('estado');
    const cidadeSelect = document.getElementById('cidade');
    
    let erros = [];
    
    // Validar Nome da Empresa (sempre obrigatório)
    if (!nomeEmpresaInput.value.trim()) {
        erros.push('Nome da Empresa é obrigatório');
        nomeEmpresaInput.classList.add('is-invalid');
        nomeEmpresaInput.classList.remove('is-valid');
    } else {
        nomeEmpresaInput.classList.remove('is-invalid');
        nomeEmpresaInput.classList.add('is-valid');
    }
    
    // Validar CPF/CNPJ (sempre obrigatório)
    const cpfCnpjValue = cpfCnpjInput.value.replace(/\D/g, '');
    if (!cpfCnpjValue || (cpfCnpjValue.length !== 11 && cpfCnpjValue.length !== 14)) {
        erros.push('CPF/CNPJ é obrigatório e deve estar completo');
        cpfCnpjInput.classList.add('is-invalid');
        cpfCnpjInput.classList.remove('is-valid');
    } else {
        cpfCnpjInput.classList.remove('is-invalid');
        cpfCnpjInput.classList.add('is-valid');
    }
    
    // Validar Estado (sempre obrigatório)
    if (!estadoSelect.value) {
        erros.push('Estado é obrigatório');
        estadoSelect.classList.add('is-invalid');
        estadoSelect.classList.remove('is-valid');
    } else {
        estadoSelect.classList.remove('is-invalid');
        estadoSelect.classList.add('is-valid');
    }
    
    // Validar Cidade (sempre obrigatório)
    if (!cidadeSelect.value) {
        erros.push('Cidade é obrigatória');
        cidadeSelect.classList.add('is-invalid');
        cidadeSelect.classList.remove('is-valid');
    } else {
        cidadeSelect.classList.remove('is-invalid');
        cidadeSelect.classList.add('is-valid');
    }
    
    // Validações condicionais para CNPJ
    const isCNPJ = cpfCnpjValue.length === 14;
    if (isCNPJ) {
        const camposObrigatoriosCNPJ = [
            {id: 'razaoSocialReceita', nome: 'Razão Social'},
            {id: 'nomeFantasiaReceita', nome: 'Nome Fantasia'},
            {id: 'inscEst', nome: 'Inscrição Estadual'},
            {id: 'inscMun', nome: 'Inscrição Municipal'},
            {id: 'segmento', nome: 'Segmento'},
            {id: 'atividade', nome: 'Atividade'},
            {id: 'regimeEstadual', nome: 'Regime Estadual'},
            {id: 'regimeFederal', nome: 'Regime Federal'}
        ];
        
        camposObrigatoriosCNPJ.forEach(campo => {
            const input = document.getElementById(campo.id);
            if (input && !input.value.trim()) {
                erros.push(`${campo.nome} é obrigatório para CNPJ`);
                input.classList.add('is-invalid');
            } else if (input) {
                input.classList.remove('is-invalid');
            }
        });
    }
    
    if (erros.length > 0) {
        console.error('❌ Erros de validação:', erros);
        
        // Mostrar alerta com os erros
        const mensagem = 'Por favor, corrija os seguintes erros:\n\n' + erros.join('\n');
        alert(mensagem);
        
        // Rolar para o primeiro campo com erro
        const primeiroErro = form.querySelector('.is-invalid');
        if (primeiroErro) {
            primeiroErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
            primeiroErro.focus();
        }
        
        return false;
    }
    
    console.log('✅ Formulário validado com sucesso');
    return true;
}

// Função para alternar a visibilidade das senhas
function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        button.title = 'Ocultar senha';
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        button.title = 'Mostrar senha';
    }
}

// === NOVOS SCRIPTS PARA LAYOUT E REGRAS ===

// CSS para caixa alta
const style = document.createElement('style');
style.textContent = `
    .upper-input { text-transform: uppercase; }
    .conditional-required { display: none; }
`;
document.head.appendChild(style);
</script>
{% endblock %}
