{% extends "base.html" %}
{% block title %}{% if view_mode %}Visualizar Cliente{% elif client %}Editar Cliente{% else %}Novo Cliente{% endif %}{% endblock %}

{% block head %}
<script>
console.log('üö® DIAGN√ìSTICO SOCIOS - CARREGAMENTO INICIADO');
console.log('üïê Timestamp:', new Date().toISOString());
console.log('üåê URL:', window.location.href);
</script>
<style>
.socio-card {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.socio-card:hover {
    background-color: #e9ecef;
    border-color: #dee2e6;
}

.socio-card .form-control-sm {
    font-size: 0.875rem;
}

.socio-card .form-label.small {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 2px;
}

#sociosContainer {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
    background-color: #ffffff;
}

.btn-outline-primary.btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.btn-outline-danger.btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* Estilos para os bot√µes de visualiza√ß√£o de senha */
.toggle-password-btn {
    border-left: none;
}

.toggle-password-btn:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
}

.toggle-password-btn:focus {
    box-shadow: none;
    border-color: #80bdff;
}

/* Estilos para modo de visualiza√ß√£o */
.view-mode input[readonly], 
.view-mode select[readonly], 
.view-mode textarea[readonly] {
    background-color: #f8f9fa !important;
    border-color: #e9ecef !important;
    cursor: default !important;
}

.view-mode input[type="checkbox"]:disabled,
.view-mode input[type="radio"]:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.view-mode .btn:not(.view-mode-show) {
    display: none !important;
}

.view-mode-banner {
    background: linear-gradient(135deg, #17a2b8, #007bff);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    font-weight: 500;
}
</style>
{% endblock %}

{% block scripts %}
<script>
console.log('üîç DEBUG: view_mode =', {{ view_mode|tojson }});
console.log('üîç DEBUG: client =', {{ client is defined }});
{% if view_mode %}
console.log('‚úÖ MODO VISUALIZA√á√ÉO ATIVO');
{% else %}
console.log('‚úèÔ∏è MODO EDI√á√ÉO/CRIA√á√ÉO ATIVO');
{% endif %}

// ===== FUN√á√ïES DE FORMATA√á√ÉO (DEFINIDAS NO IN√çCIO) =====
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{4,5})(\d{4})$/, '$1-$2');
    }
    input.value = value;
}

function formatCPF(input) {
    // Salvar posi√ß√£o do cursor
    const cursorPos = input.selectionStart;
    const valueLength = input.value.length;
    
    // Remover tudo que n√£o √© d√≠gito
    let value = input.value.replace(/\D/g, '');
    
    // Aplicar formata√ß√£o apenas se tiver d√≠gitos
    if (value.length > 0) {
        // Limitar a 11 d√≠gitos (CPF)
        if (value.length > 11) {
            value = value.substring(0, 11);
        }
        
        // Aplicar m√°scara CPF: 000.000.000-00
        if (value.length <= 3) {
            // 123
            value = value;
        } else if (value.length <= 6) {
            // 123.456
            value = value.replace(/(\d{3})(\d+)/, '$1.$2');
        } else if (value.length <= 9) {
            // 123.456.789
            value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1.$2.$3');
        } else {
            // 123.456.789-01
            value = value.replace(/(\d{3})(\d{3})(\d{3})(\d+)/, '$1.$2.$3-$4');
        }
    }
    
    input.value = value;
    console.log('‚úÖ CPF formatado:', value);
    
    // Restaurar posi√ß√£o do cursor (aproximada)
    const newLength = value.length;
    const newCursorPos = Math.min(cursorPos + (newLength - valueLength), newLength);
    input.setSelectionRange(newCursorPos, newCursorPos);
}

// ===== FUN√á√ÉO INLINE SIMPLES PARA CPF/CNPJ =====
function formatarCpfCnpjInline(input) {
    console.log('üéØ FUN√á√ÉO INLINE CHAMADA:', input.value);
    
    // Remove todos os caracteres n√£o num√©ricos
    const valor = input.value.replace(/\D/g, '');
    const domesticaSelect = document.getElementById('domestica');
    const labelCpfCnpj = document.querySelector('label[for="cpfCnpj"]');
    
    console.log('üìã Valor limpo:', valor, 'Length:', valor.length);
    
    // Formata√ß√£o progressiva
    let valorFormatado = '';
    
    if (valor.length === 0) {
        // Campo vazio - resetar para estado inicial
        valorFormatado = '';
        if (labelCpfCnpj) {
            labelCpfCnpj.innerHTML = '<i class="bi bi-card-text me-1"></i>CPF/CNPJ <span class="text-danger required-field">*</span>';
        }
        if (domesticaSelect) {
            domesticaSelect.disabled = true;
            domesticaSelect.value = 'N√ÉO';
        }
        input.placeholder = '';
    } else if (valor.length <= 11) {
        // Formata√ß√£o para CPF: 000.000.000-00
        if (valor.length <= 3) {
            valorFormatado = valor;
        } else if (valor.length <= 6) {
            valorFormatado = valor.replace(/(\d{3})(\d+)/, '$1.$2');
        } else if (valor.length <= 9) {
            valorFormatado = valor.replace(/(\d{3})(\d{3})(\d+)/, '$1.$2.$3');
        } else {
            valorFormatado = valor.replace(/(\d{3})(\d{3})(\d{3})(\d+)/, '$1.$2.$3-$4');
        }
        
        // Se tem 11 d√≠gitos, √© um CPF completo
        if (valor.length === 11) {
            console.log('üë§ CPF completo - habilitando Dom√©stica');
            if (labelCpfCnpj) {
                labelCpfCnpj.innerHTML = '<i class="bi bi-person me-1"></i>CPF <span class="text-danger required-field">*</span>';
            }
            if (domesticaSelect) {
                domesticaSelect.disabled = false;
            }
            input.placeholder = '000.000.000-00';
        } else {
            // CPF incompleto
            if (labelCpfCnpj) {
                labelCpfCnpj.innerHTML = '<i class="bi bi-person me-1"></i>CPF <span class="text-danger required-field">*</span>';
            }
            if (domesticaSelect) {
                domesticaSelect.disabled = true;
                domesticaSelect.value = 'N√ÉO';
            }
            input.placeholder = '000.000.000-00';
        }
    } else {
        // Formata√ß√£o para CNPJ: 00.000.000/0000-00
        if (valor.length <= 2) {
            valorFormatado = valor;
        } else if (valor.length <= 5) {
            valorFormatado = valor.replace(/(\d{2})(\d+)/, '$1.$2');
        } else if (valor.length <= 8) {
            valorFormatado = valor.replace(/(\d{2})(\d{3})(\d+)/, '$1.$2.$3');
        } else if (valor.length <= 12) {
            valorFormatado = valor.replace(/(\d{2})(\d{3})(\d{3})(\d+)/, '$1.$2.$3/$4');
        } else {
            valorFormatado = valor.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d+)/, '$1.$2.$3/$4-$5');
        }
        
        // Se tem 14 d√≠gitos, √© um CNPJ completo
        if (valor.length === 14) {
            console.log('üè¢ CNPJ completo - desabilitando Dom√©stica');
            if (labelCpfCnpj) {
                labelCpfCnpj.innerHTML = '<i class="bi bi-building me-1"></i>CNPJ <span class="text-danger required-field">*</span>';
            }
            if (domesticaSelect) {
                domesticaSelect.disabled = true;
                domesticaSelect.value = 'N√ÉO';
            }
            input.placeholder = '00.000.000/0000-00';
        } else {
            // CNPJ incompleto
            if (labelCpfCnpj) {
                labelCpfCnpj.innerHTML = '<i class="bi bi-building me-1"></i>CNPJ <span class="text-danger required-field">*</span>';
            }
            if (domesticaSelect) {
                domesticaSelect.disabled = true;
                domesticaSelect.value = 'N√ÉO';
            }
            input.placeholder = '00.000.000/0000-00';
        }
    }
    
    input.value = valorFormatado;
    console.log('‚úÖ Valor formatado:', valorFormatado);
    console.log('‚úÖ Fun√ß√£o inline conclu√≠da');
}

document.addEventListener('DOMContentLoaded', function() {
    // ===== INICIALIZA√á√ÉO PRIORIT√ÅRIA =====
    console.log('üöÄ DOM Carregado - Inicializando valida√ß√µes CPF/CNPJ PRIMEIRO');
    
    // ===== CONFIGURA√á√ÉO INICIAL DO CAMPO DOM√âSTICA =====
    function configurarCampoDomesticaInicial() {
        const cpfCnpjInput = document.getElementById('cpfCnpj');
        const domesticaSelect = document.getElementById('domestica');
        
        console.log('üè† Configurando campo Dom√©stica inicial...');
        
        if (cpfCnpjInput && domesticaSelect) {
            // Se h√° valor inicial no CPF/CNPJ, processar com a fun√ß√£o principal
            if (cpfCnpjInput.value) {
                console.log('ÔøΩ Valor inicial encontrado, aplicando formata√ß√£o...');
                formatarCpfCnpjInline(cpfCnpjInput);
            } else {
                // Novo cadastro - configurar estado inicial
                console.log('üÜï Novo cadastro - configurando estado inicial');
                domesticaSelect.disabled = true;
                domesticaSelect.value = 'N√ÉO';
            }
        }
    }
    
    // Executar configura√ß√£o inicial imediatamente
    configurarCampoDomesticaInicial();
    
    // Aguardar um pouco para garantir que o DOM est√° 100% pronto
    setTimeout(function() {
        console.log('üîß Configurando CPF/CNPJ e Dom√©stica...');
        const cpfCnpjInput = document.getElementById('cpfCnpj');
        const domesticaSelect = document.getElementById('domestica');
        
        if (cpfCnpjInput && domesticaSelect) {
            console.log('‚úÖ Campos encontrados - configurando event listener');
            
            // Event listener combinado
            cpfCnpjInput.addEventListener('input', function() {
                console.log('üìã Input detectado:', this.value);
                // Chamar ambas as funcionalidades
                try {
                    if (typeof atualizarCpfCnpjEDomestica === 'function') {
                        atualizarCpfCnpjEDomestica();
                    } else {
                        console.log('‚ö†Ô∏è Fun√ß√£o atualizarCpfCnpjEDomestica n√£o definida ainda');
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao executar atualizarCpfCnpjEDomestica:', e);
                }
            });
            
            console.log('‚úÖ CPF/CNPJ configurado com sucesso!');
        } else {
            console.error('‚ùå Campos CPF/CNPJ ou Dom√©stica n√£o encontrados!');
        }
    }, 100); // 100ms de delay
    
    // ===== RESTO DAS FUNCIONALIDADES =====
    function atualizarCpfRepresentanteLegal() {
        console.log('üîç Atualizando CPF do Representante Legal...');
        
        // Procura o radio selecionado para representante legal
        const radios = document.querySelectorAll('.representante-legal');
        let cpf = '';
        let socioSelecionado = '';
        
        radios.forEach(function(radio) {
            if (radio.checked) {
                // O id do s√≥cio est√° no value (ex: socio_1)
                const socioId = radio.value;
                socioSelecionado = socioId;
                
                // Busca o input de CPF do s√≥cio (compat√≠vel com s√≥cios din√¢micos)
                const cpfInput = document.querySelector(`#${socioId}_cpf, [name='${socioId}_cpf']`);
                if (cpfInput) {
                    cpf = cpfInput.value;
                    console.log(`‚úÖ Representante Legal selecionado: ${socioId}`);
                    console.log(`üìã CPF encontrado: ${cpf}`);
                } else {
                    console.log(`‚ùå Campo CPF n√£o encontrado para: ${socioId}`);
                }
            }
        });
        
        // Preenche o campo CPF do Representante Legal
        const cpfRepLegal = document.getElementById('cpfRepLegal');
        if (cpfRepLegal) {
            cpfRepLegal.value = cpf;
            console.log(`üéØ CPF do Representante Legal atualizado: '${cpf}'`);
            
            if (!socioSelecionado) {
                console.log('‚ö†Ô∏è Nenhum Representante Legal selecionado - Campo limpo');
            }
        } else {
            console.error('‚ùå Campo CPF do Representante Legal n√£o encontrado!');
        }
        
        console.log('‚úÖ Atualiza√ß√£o do CPF do Representante Legal conclu√≠da');
    }

    // Atualiza ao selecionar representante legal
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('representante-legal')) {
            atualizarCpfRepresentanteLegal();
        }
    });
    // Atualiza ao digitar CPF do s√≥cio
    document.addEventListener('input', function(e) {
        if (e.target && e.target.id && e.target.id.endsWith('_cpf')) {
            atualizarCpfRepresentanteLegal();
        }
    });
    // Atualiza ao carregar a p√°gina
    atualizarCpfRepresentanteLegal();
    
    {% if view_mode %}
    // Aplicar readonly para todos os campos no modo visualiza√ß√£o
    document.querySelectorAll('input, select, textarea').forEach(function(field) {
        if (field.type !== 'hidden') {
            field.readOnly = true;
            field.disabled = false; // Manter habilitado para scroll e sele√ß√£o de texto
        }
    });
    
    // Desabilitar checkboxes e radios
    document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(function(field) {
        field.disabled = true;
    });
    
    // Remover event listeners de bot√µes din√¢micos
    document.querySelectorAll('button').forEach(function(btn) {
        if (!btn.classList.contains('view-mode-show')) {
            btn.style.display = 'none';
        }
    });
    {% endif %}
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Mensagens Flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            {% if view_mode %}
            <!-- Banner de modo visualiza√ß√£o -->
            <div class="view-mode-banner d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-eye me-2"></i>
                    <strong>Modo Visualiza√ß√£o</strong> - Dados somente para leitura
                </div>
                <div>
                    <a href="{{ url_for('edit_client', client_id=client.id) }}" 
                       class="btn btn-light btn-sm view-mode-show">
                        <i class="bi bi-pencil me-1"></i>Editar
                    </a>
                </div>
            </div>
            {% endif %}
            <!-- Formul√°rio Principal -->
            {% if view_mode %}
            <!-- Formul√°rio em modo visualiza√ß√£o (readonly) -->
            <form class="needs-validation view-mode" novalidate>
            {% else %}
            <!-- Formul√°rio em modo edi√ß√£o/cria√ß√£o -->
            <form method="POST" action="{{ url_for('save_client') }}" class="needs-validation" novalidate>
            {% endif %}
                <!-- Campo hidden para ID do cliente -->
                {% if client %}
                <input type="hidden" name="id" value="{{ client.id }}">
                {% if client._row_number %}
                <input type="hidden" name="row_number" value="{{ client._row_number }}">
                {% endif %}
                {% endif %}
                <!-- Bloco 1: Informa√ß√µes da Pessoa F√≠sica / Jur√≠dica -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-vcard me-2"></i>
                            Informa√ß√µes da Pessoa F√≠sica / Jur√≠dica
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Primeira linha: Nome da Empresa e Raz√£o Social -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nomeEmpresa" class="form-label">
                                    <i class="bi bi-building me-1"></i>Nome da Empresa
                                    <span class="text-danger required-field">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="nomeEmpresa" name="nomeEmpresa" 
                                       value="{{ client.nomeEmpresa if client else '' }}" required
                                       {% if view_mode %}readonly{% endif %}>
                                <div class="invalid-feedback">
                                    Por favor, informe o nome da empresa.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="razaoSocialReceita" class="form-label">
                                    <i class="bi bi-file-text me-1"></i>Raz√£o Social (Receita)
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="razaoSocialReceita" name="razaoSocialReceita"
                                       value="{{ client.razaoSocialReceita if client else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe a raz√£o social.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Segunda linha: Nome Fantasia e CPF/CNPJ -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nomeFantasiaReceita" class="form-label">
                                    <i class="bi bi-shop me-1"></i>Nome Fantasia (Receita)
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="nomeFantasiaReceita" name="nomeFantasiaReceita"
                                       value="{{ client.nomeFantasiaReceita if client else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe o nome fantasia.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cpfCnpj" class="form-label">
                                    <i class="bi bi-card-text me-1"></i>CPF/CNPJ
                                    <span class="text-danger required-field">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="cpfCnpj" name="cpfCnpj"
                                       value="{{ client.cpfCnpj if client else '' }}" 
                                       placeholder="" required
                                       oninput="formatarCpfCnpjInline(this)"
                                       onblur="formatarCpfCnpjInline(this)"
                                       onchange="formatarCpfCnpjInline(this)">
                                <div class="invalid-feedback">
                                    Por favor, informe o CPF ou CNPJ.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terceira linha: Estado, Cidade, Inscri√ß√£o Estadual, Inscri√ß√£o Municipal -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="estado" class="form-label">
                                    <i class="bi bi-map me-1"></i>Estado
                                    <span class="text-danger required-field">*</span>
                                </label>
                                <select class="form-select" id="estado" name="estado" required>
                                    <option value="">Selecione o estado</option>
                                    <option value="AC" {% if client and client.estado == 'AC' %}selected{% endif %}>ACRE</option>
                                    <option value="AL" {% if client and client.estado == 'AL' %}selected{% endif %}>ALAGOAS</option>
                                    <option value="AP" {% if client and client.estado == 'AP' %}selected{% endif %}>AMAP√Å</option>
                                    <option value="AM" {% if client and client.estado == 'AM' %}selected{% endif %}>AMAZONAS</option>
                                    <option value="BA" {% if client and client.estado == 'BA' %}selected{% endif %}>BAHIA</option>
                                    <option value="CE" {% if client and client.estado == 'CE' %}selected{% endif %}>CEAR√Å</option>
                                    <option value="DF" {% if client and client.estado == 'DF' %}selected{% endif %}>DISTRITO FEDERAL</option>
                                    <option value="ES" {% if client and client.estado == 'ES' %}selected{% endif %}>ESP√çRITO SANTO</option>
                                    <option value="GO" {% if client and client.estado == 'GO' %}selected{% endif %}>GOI√ÅS</option>
                                    <option value="MA" {% if client and client.estado == 'MA' %}selected{% endif %}>MARANH√ÉO</option>
                                    <option value="MT" {% if client and client.estado == 'MT' %}selected{% endif %}>MATO GROSSO</option>
                                    <option value="MS" {% if client and client.estado == 'MS' %}selected{% endif %}>MATO GROSSO DO SUL</option>
                                    <option value="MG" {% if client and client.estado == 'MG' %}selected{% endif %}>MINAS GERAIS</option>
                                    <option value="PA" {% if client and client.estado == 'PA' %}selected{% endif %}>PAR√Å</option>
                                    <option value="PB" {% if client and client.estado == 'PB' %}selected{% endif %}>PARA√çBA</option>
                                    <option value="PR" {% if client and client.estado == 'PR' %}selected{% endif %}>PARAN√Å</option>
                                    <option value="PE" {% if client and client.estado == 'PE' %}selected{% endif %}>PERNAMBUCO</option>
                                    <option value="PI" {% if client and client.estado == 'PI' %}selected{% endif %}>PIAU√ç</option>
                                    <option value="RJ" {% if client and client.estado == 'RJ' %}selected{% endif %}>RIO DE JANEIRO</option>
                                    <option value="RN" {% if client and client.estado == 'RN' %}selected{% endif %}>RIO GRANDE DO NORTE</option>
                                    <option value="RS" {% if client and client.estado == 'RS' %}selected{% endif %}>RIO GRANDE DO SUL</option>
                                    <option value="RO" {% if client and client.estado == 'RO' %}selected{% endif %}>ROND√îNIA</option>
                                    <option value="RR" {% if client and client.estado == 'RR' %}selected{% endif %}>RORAIMA</option>
                                    <option value="SC" {% if client and client.estado == 'SC' %}selected{% endif %}>SANTA CATARINA</option>
                                    <option value="SP" {% if client and client.estado == 'SP' %}selected{% endif %}>S√ÉO PAULO</option>
                                    <option value="SE" {% if client and client.estado == 'SE' %}selected{% endif %}>SERGIPE</option>
                                    <option value="TO" {% if client and client.estado == 'TO' %}selected{% endif %}>TOCANTINS</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione o estado.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="cidade" class="form-label">
                                    <i class="bi bi-geo me-1"></i>Cidade
                                    <span class="text-danger required-field">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="cidade" name="cidade"
                                       value="{{ client.cidade if client else '' }}" required>
                                <div class="invalid-feedback">
                                    Por favor, informe a cidade.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="inscEst" class="form-label">
                                    <i class="bi bi-card-list me-1"></i>Inscri√ß√£o Estadual
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="inscEst" name="inscEst"
                                       value="{{ client.inscEst if client else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe a inscri√ß√£o estadual.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="inscMun" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Inscri√ß√£o Municipal
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <input type="text" class="form-control upper-input" id="inscMun" name="inscMun"
                                       value="{{ client.inscMun if client else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe a inscri√ß√£o municipal.
                                </div>
                            </div>
                        
                        
                        <!-- Quarta linha: Segmento, Atividade Principal, Regime Estadual e Regime Federal -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="segmento" class="form-label">
                                    <i class="bi bi-tags me-1"></i>Segmento
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="segmento" name="segmento">
                                        <option value="">Selecione o segmento</option>
                                        {% for segmento in segmentos %}
                                        <option value="{{ segmento.nome if segmento.nome else segmento }}" 
                                                {% if client and client.segmento == (segmento.nome if segmento.nome else segmento) %}selected{% endif %}>
                                            {{ segmento.nome if segmento.nome else segmento }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="window.open('/segmentos', '_blank')" title="Cadastrar novos segmentos">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">
                                    Por favor, selecione o segmento.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="atividade" class="form-label">
                                    <i class="bi bi-briefcase me-1"></i>Atividade Principal
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="atividade" name="atividade">
                                        <option value="">Selecione a atividade principal</option>
                                        {% for atividade in atividades %}
                                        <option value="{{ atividade.nome if atividade.nome else atividade }}" 
                                                {% if client and client.atividade == (atividade.nome if atividade.nome else atividade) %}selected{% endif %}>
                                            {{ atividade.nome if atividade.nome else atividade }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="window.open('/atividades', '_blank')" title="Cadastrar novas atividades">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">
                                    Por favor, selecione a atividade principal.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="regimeEstadual" class="form-label">
                                    <i class="bi bi-bank me-1"></i>Regime Estadual
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <select class="form-select" id="regimeEstadual" name="regimeEstadual">
                                    <option value="">Selecione o regime estadual</option>
                                    <option value="SIMPLES" {% if client and client.regimeEstadual == 'SIMPLES' %}selected{% endif %}>SIMPLES NACIONAL</option>
                                    <option value="NORMAL" {% if client and client.regimeEstadual == 'NORMAL' %}selected{% endif %}>REGIME NORMAL</option>
                                    <option value="REGIME_ESPECIAL" {% if client and client.regimeEstadual == 'REGIME_ESPECIAL' %}selected{% endif %}>REGIME ESPECIAL</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione o regime estadual.
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="regimeFederal" class="form-label">
                                    <i class="bi bi-percent me-1"></i>Regime Federal
                                    <span class="text-danger conditional-required">*</span>
                                </label>
                                <select class="form-select" id="regimeFederal" name="regimeFederal">
                                    <option value="">Selecione o regime federal</option>
                                    <option value="MEI" {% if client and client.regimeFederal == 'MEI' %}selected{% endif %}>MEI</option>
                                    <option value="SIMPLES_NACIONAL" {% if client and client.regimeFederal == 'SIMPLES_NACIONAL' or client.regimeFederal == 'SIMPLES' %}selected{% endif %}>SIMPLES NACIONAL</option>
                                    <option value="LUCRO_PRESUMIDO" {% if client and client.regimeFederal == 'LUCRO_PRESUMIDO' %}selected{% endif %}>LUCRO PRESUMIDO</option>
                                    <option value="LUCRO_REAL" {% if client and client.regimeFederal == 'LUCRO_REAL' %}selected{% endif %}>LUCRO REAL</option>
                                    <option value="REGIME_ESPECIAL" {% if client and client.regimeFederal == 'REGIME_ESPECIAL' %}selected{% endif %}>REGIME ESPECIAL</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione o regime federal.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 2: Servi√ßos Prestados pela Control -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-handshake me-2"></i>
                            Servi√ßos Prestados pela Control
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Primeira linha: Checkboxes dos servi√ßos -->
                        <div class="row">
                            <!-- BPO Financeiro -->
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="bpoFinanceiro" name="bpoFinanceiro" 
                                           {% if client and client.bpoFinanceiro %}checked{% endif %}>
                                    <label class="form-check-label" for="bpoFinanceiro">
                                        <i class="bi bi-graph-up me-1 text-info"></i>
                                        <strong>BPO Financeiro</strong>
                                    </label>
                                </div>
                            </div>
                            <!-- Departamento Cont√°bil (CT) -->
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="ct" name="ct" 
                                           {% if client and client.ct %}checked{% endif %}>
                                    <label class="form-check-label" for="ct">
                                        <i class="bi bi-calculator me-1" style="color: var(--control-primary);"></i>
                                        <strong>Departamento Cont√°bil (CT)</strong>
                                    </label>
                                </div>
                            </div>
                            <!-- Departamento Fiscal (FS) -->
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="fs" name="fs" 
                                           {% if client and client.fs %}checked{% endif %}>
                                    <label class="form-check-label" for="fs">
                                        <i class="bi bi-file-text me-1" style="color: var(--control-secondary);"></i>
                                        <strong>Departamento Fiscal (FS)</strong>
                                    </label>
                                </div>
                            </div>
                            <!-- Departamento Pessoal (DP) -->
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dp" name="dp" 
                                           {% if client and client.dp %}checked{% endif %}>
                                    <label class="form-check-label" for="dp">
                                        <i class="bi bi-people me-1 text-success"></i>
                                        <strong>Departamento Pessoal (DP)</strong>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Segunda linha: Dom√©stica, Data de In√≠cio, Perfil do Cliente, Sistema Utilizado, Gera arquivo do Sped -->
                        <div class="row">
                            <!-- Dom√©stica -->
                            <div class="col-md-2 mb-3">
                                <label for="domestica" class="form-label">
                                    <i class="bi bi-house me-1"></i>
                                    Dom√©stica
                                </label>
                                <select class="form-select" id="domestica" name="domestica">
                                    <option value="N√ÉO" {% if not client or not client.domestica or client.domestica == 'N√ÉO' %}selected{% endif %}>N√ÉO</option>
                                    <option value="SIM" {% if client and client.domestica == 'SIM' %}selected{% endif %}>SIM</option>
                                </select>
                            </div>
                            
                            <!-- Data de In√≠cio dos Servi√ßos -->
                            <div class="col-md-2 mb-3">
                                <label for="dataInicioServicos" class="form-label">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    Data de In√≠cio dos Servi√ßos
                                </label>
                                <input type="text" class="form-control" id="dataInicioServicos" name="dataInicioServicos" 
                                       value="{{ client.dataInicioServicos if client else '' }}"
                                       placeholder="MM/AAAA" pattern="^(0[1-9]|1[0-2])\/\d{4}$" maxlength="7"
                                       title="Formato: MM/AAAA (Ex: 08/2025)"
                                       data-bs-toggle="tooltip" data-bs-placement="top" 
                                       data-bs-title="Digite apenas n√∫meros. Formato: MM/AAAA">
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Exemplo: 08/2025 para Agosto de 2025
                                    </small>
                                </div>
                            </div>

                            <!-- Perfil do Cliente -->
                            <div class="col-md-2 mb-3">
                                <label for="perfilCliente" class="form-label">
                                    <i class="bi bi-person-badge me-1"></i>
                                    Perfil do Cliente *
                                </label>
                                <select class="form-select" id="perfilCliente" name="perfilCliente" required>
                                    <option value="">Selecione um perfil</option>
                                    <option value="A" {% if client and client.perfilCliente == 'A' %}selected{% endif %}>A</option>
                                    <option value="B" {% if client and client.perfilCliente == 'B' %}selected{% endif %}>B</option>
                                    <option value="C" {% if client and client.perfilCliente == 'C' %}selected{% endif %}>C</option>
                                    <option value="D" {% if client and client.perfilCliente == 'D' %}selected{% endif %}>D</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione o perfil do cliente.
                                </div>
                            </div>

                            <!-- Sistema Utilizado -->
                            <div class="col-md-2 mb-3">
                                <label for="sistemaUtilizado" class="form-label">
                                    <i class="bi bi-pc-display me-1"></i>
                                    Sistema Utilizado
                                </label>
                                <select class="form-select" id="sistemaUtilizado" name="sistemaUtilizado">
                                    <option value="">Selecione o sistema</option>
                                    {% if sistemas %}
                                        {% for sistema in sistemas %}
                                        <option value="{{ sistema.nome if sistema.nome else sistema }}" {% if client and client.sistemaUtilizado == (sistema.nome if sistema.nome else sistema) %}selected{% endif %}>{{ sistema.nome if sistema.nome else sistema }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="FORTES" {% if client and client.sistemaUtilizado == 'FORTES' %}selected{% endif %}>FORTES</option>
                                        <option value="DOM√çNIO" {% if client and client.sistemaUtilizado == 'DOM√çNIO' %}selected{% endif %}>DOM√çNIO</option>
                                        <option value="SAGE" {% if client and client.sistemaUtilizado == 'SAGE' %}selected{% endif %}>SAGE</option>
                                        <option value="ALTERDATA" {% if client and client.sistemaUtilizado == 'ALTERDATA' %}selected{% endif %}>ALTERDATA</option>
                                        <option value="OUTROS" {% if client and client.sistemaUtilizado == 'OUTROS' %}selected{% endif %}>OUTROS</option>
                                    {% endif %}
                                </select>
                            </div>

                            <!-- Gera arquivo do Sped -->
                            <div class="col-md-2 mb-3">
                                <label for="geraArquivoSped" class="form-label">
                                    <i class="bi bi-file-earmark-code me-1"></i>
                                    Gera arquivo do Sped
                                </label>
                                <select class="form-select" id="geraArquivoSped" name="geraArquivoSped">
                                    <option value="">Selecionar SIM/N√ÉO</option>
                                    <option value="SIM" {% if client and client.geraArquivoSped == 'SIM' %}selected{% endif %}>SIM</option>
                                    <option value="N√ÉO" {% if client and client.geraArquivoSped == 'N√ÉO' %}selected{% endif %}>N√ÉO</option>
                                </select>
                            </div>
                        </div>

                        <!-- Terceira linha: C√≥digos dos sistemas -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="codDominio" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    # C√≥d. Dom√≠nio
                                </label>
                                <input type="text" class="form-control numbers-only" id="codDominio" name="codDominio" 
                                       value="{{ client.codDominio if client else '' }}"
                                       placeholder="C√≥digo Dom√≠nio" pattern="[0-9]*" title="Apenas n√∫meros">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codFortesCt" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    # C√≥d. Fortes CT
                                </label>
                                <input type="text" class="form-control numbers-only" id="codFortesCt" name="codFortesCt" 
                                       value="{{ client.codFortesCt if client else '' }}"
                                       placeholder="C√≥digo CT" pattern="[0-9]*" title="Apenas n√∫meros">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codFortesFs" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    # C√≥d. Fortes FS
                                </label>
                                <input type="text" class="form-control numbers-only" id="codFortesFs" name="codFortesFs" 
                                       value="{{ client.codFortesFs if client else '' }}"
                                       placeholder="C√≥digo FS" pattern="[0-9]*" title="Apenas n√∫meros">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codFortesPs" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    # C√≥d. Fortes PS
                                </label>
                                <input type="text" class="form-control numbers-only" id="codFortesPs" name="codFortesPs" 
                                       value="{{ client.codFortesPs if client else '' }}"
                                       placeholder="C√≥digo PS" pattern="[0-9]*" title="Apenas n√∫meros">
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Bloco 3: Quadro Societ√°rio -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-people me-2"></i>
                            Quadro Societ√°rio
                        </h5>
                    </div>
                    <div class="card-body">
            <!-- Campos removidos: E-MAIL SECUND√ÅRIO, RESPONS√ÅVEL IMEDIATO -->
                        <div class="row">
                            <!-- BLOCO 3: QUADRO SOCIET√ÅRIO -->
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-people-fill me-1"></i>S√ìCIOS DA EMPRESA
                                    </label>
                                    <button type="button" 
                                            class="btn btn-outline-primary btn-sm" 
                                            id="btnAdicionarSocio"
                                            onclick="
                                                console.log('üî¥ [CORRE√á√ÉO 09] BOT√ÉO CLICADO - Verificando s√≥cios ocultos');
                                                
                                                // CORRE√á√ÉO 09: Primeiro verificar se h√° s√≥cios est√°ticos ocultos (2-5)
                                                var sociosEstaticosOcultos = [];
                                                for (var i = 2; i <= 5; i++) {
                                                    var socioEstatico = document.getElementById('socio_' + i);
                                                    if (socioEstatico && socioEstatico.style.display === 'none') {
                                                        sociosEstaticosOcultos.push(i);
                                                    }
                                                }
                                                
                                                if (sociosEstaticosOcultos.length > 0) {
                                                    // Mostrar o primeiro s√≥cio oculto
                                                    var proximoSocio = sociosEstaticosOcultos[0];
                                                    var socioElement = document.getElementById('socio_' + proximoSocio);
                                                    socioElement.style.display = 'block';
                                                    console.log('‚úÖ [CORRE√á√ÉO 09] S√≥cio', proximoSocio, 'revelado (estava oculto)');
                                                    
                                                    // Aplicar m√°scara CPF ao s√≥cio revelado
                                                    var cpfInput = socioElement.querySelector('.cpf-mask');
                                                    if (cpfInput) {
                                                        if (cpfInput.value && cpfInput.value.length > 0) {
                                                            formatCPF(cpfInput);
                                                            console.log('üîß [CORRE√á√ÉO 09] CPF formatado no s√≥cio revelado:', cpfInput.value);
                                                        }
                                                    }
                                                    
                                                    // Focar no primeiro campo do s√≥cio revelado
                                                    var firstInput = socioElement.querySelector('input');
                                                    if (firstInput) firstInput.focus();
                                                    
                                                    return; // Sair da fun√ß√£o - n√£o criar s√≥cio din√¢mico
                                                }
                                                
                                                // Se chegou aqui, todos os s√≥cios est√°ticos (2-5) j√° est√£o vis√≠veis
                                                // Proceder com cria√ß√£o de s√≥cio din√¢mico (6+)
                                                console.log('üîß [CORRE√á√ÉO 09] Todos s√≥cios est√°ticos vis√≠veis - criando din√¢mico');
                                                
                                                var container = document.getElementById('sociosContainer');
                                                if (!container) {
                                                    alert('Container n√£o encontrado!');
                                                    return;
                                                }
                                                console.log('‚úÖ Container encontrado');
                                                var socios = container.querySelectorAll('.socio-card');
                                                var total = socios.length;
                                                console.log('üìä Total s√≥cios:', total);
                                                if (total >= 10) {
                                                    alert('M√°ximo 10 s√≥cios!');
                                                    return;
                                                }
                                                var num = total + 1;
                                                var div = document.createElement('div');
                                                div.className = 'card border-light mb-2 socio-card';
                                                div.id = 'socio_' + num;
                                                div.innerHTML = '<div class=\&quot;card-body py-3\&quot;><div class=\&quot;d-flex justify-content-between align-items-center mb-2\&quot;><span class=\&quot;badge bg-primary\&quot;>S√≥cio ' + num + '</span><button type=\&quot;button\&quot; class=\&quot;btn btn-sm btn-outline-danger\&quot; onclick=\&quot;this.closest(\\\&quot;.socio-card\\\&quot;).remove();\&quot;>‚ùå</button></div><div class=\&quot;row align-items-center\&quot;><div class=\&quot;col-md-3 mb-2\&quot;><label class=\&quot;form-label small mb-1\&quot;>Nome do S√≥cio</label><input type=\&quot;text\&quot; class=\&quot;form-control form-control-sm\&quot; name=\&quot;socio_' + num + '_nome\&quot; onkeyup=\&quot;this.value=this.value.toUpperCase()\&quot; placeholder=\&quot;Nome completo do s√≥cio\&quot;></div><div class=\&quot;col-md-2 mb-2\&quot;><label class=\&quot;form-label small mb-1\&quot;>CPF</label><input type=\&quot;text\&quot; class=\&quot;form-control form-control-sm cpf-mask\&quot; name=\&quot;socio_' + num + '_cpf\&quot; placeholder=\&quot;000.000.000-00\&quot;></div><div class=\&quot;col-md-2 mb-2\&quot;><label class=\&quot;form-label small mb-1\&quot;>Data de Nascimento</label><input type=\&quot;date\&quot; class=\&quot;form-control form-control-sm\&quot; name=\&quot;socio_' + num + '_data_nascimento\&quot;></div><div class=\&quot;col-md-2 mb-2\&quot;><label class=\&quot;form-label small mb-1\&quot;>% de Quotas</label><input type=\&quot;number\&quot; class=\&quot;form-control form-control-sm\&quot; name=\&quot;socio_' + num + '_participacao\&quot; placeholder=\&quot;50.00\&quot; step=\&quot;0.01\&quot; min=\&quot;0\&quot; max=\&quot;100\&quot;></div><div class=\&quot;col-md-3 mb-2\&quot;><div class=\&quot;row\&quot;><div class=\&quot;col-6\&quot;><div class=\&quot;form-check\&quot;><input class=\&quot;form-check-input representante-legal\&quot; type=\&quot;radio\&quot; name=\&quot;representante_legal\&quot; value=\&quot;socio_' + num + '\&quot; id=\&quot;rep_legal_' + num + '\&quot;><label class=\&quot;form-check-label small\&quot; for=\&quot;rep_legal_' + num + '\&quot;>Representante Legal</label></div></div><div class=\&quot;col-6\&quot;><div class=\&quot;form-check\&quot;><input class=\&quot;form-check-input socio-admin\&quot; type=\&quot;checkbox\&quot; name=\&quot;socio_' + num + '_administrador\&quot; value=\&quot;1\&quot; id=\&quot;admin_' + num + '\&quot;><label class=\&quot;form-check-label small\&quot; for=\&quot;admin_' + num + '\&quot;>S√≥cio Administrador</label></div></div></div></div></div></div>';
                                                container.appendChild(div);
                                                
                                                // CORRE√á√ÉO 07: Reaplicar m√°scaras aos novos campos CPF
                                                console.log('üîß [CORRE√á√ÉO 07] Aplicando m√°scara CPF ao s√≥cio', num);
                                                var cpfInput = div.querySelector('.cpf-mask');
                                                if (cpfInput) {
                                                    // Event listener para input em tempo real
                                                    cpfInput.addEventListener('input', function() {
                                                        formatCPF(this);
                                                    });
                                                    
                                                    // Event listener para blur (quando sai do campo)
                                                    cpfInput.addEventListener('blur', function() {
                                                        if (this.value && this.value.length > 0) {
                                                            formatCPF(this);
                                                        }
                                                    });
                                                    
                                                    // Formatar se j√° tiver valor
                                                    if (cpfInput.value && cpfInput.value.length > 0) {
                                                        formatCPF(cpfInput);
                                                    }
                                                    
                                                    console.log('‚úÖ [CORRE√á√ÉO 07] M√°scara CPF aplicada ao s√≥cio', num);
                                                } else {
                                                    console.error('‚ùå [CORRE√á√ÉO 07] Campo CPF n√£o encontrado no s√≥cio', num);
                                                }
                                                
                                                // Aplicar event listener para atualizar CPF do Representante Legal
                                                var radioInput = div.querySelector('.representante-legal');
                                                if (radioInput) {
                                                    radioInput.addEventListener('change', function() {
                                                        if (this.checked) {
                                                            atualizarCpfRepresentanteLegal();
                                                        }
                                                    });
                                                }
                                                
                                                // Aplicar event listener para atualizar CPF quando digitado
                                                if (cpfInput) {
                                                    cpfInput.addEventListener('input', function() {
                                                        // Verificar se este s√≥cio √© o representante legal selecionado
                                                        var radio = div.querySelector('.representante-legal');
                                                        if (radio && radio.checked) {
                                                            atualizarCpfRepresentanteLegal();
                                                        }
                                                    });
                                                }
                                                
                                                console.log('‚úÖ [CORRE√á√ÉO 09] S√≥cio din√¢mico', num, 'adicionado com TODOS os campos e m√°scaras!');
                                                
                                                // CORRE√á√ÉO 07: For√ßar reaplica√ß√£o da formata√ß√£o CPF ap√≥s adicionar s√≥cio
                                                setTimeout(function() {
                                                    reaplicarFormatacaoCPF();
                                                    console.log('üîß [CORRE√á√ÉO 07] Formata√ß√£o CPF reaplicada ap√≥s adicionar s√≥cio', num);
                                                }, 50);
                                                
                                                var input = div.querySelector('input');
                                                if (input) input.focus();
                                            ">
                                        <i class="bi bi-plus-circle me-1"></i>Adicionar S√≥cio
                                    </button>
                                </div>
                                
                                <!-- Container para os s√≥cios -->
                                <div id="sociosContainer">
                                    <!-- S√≥cio 1 (sempre presente) -->
                                    <div class="card border-light mb-2 socio-card" id="socio_1">
                                        <div class="card-body py-3">
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome do S√≥cio</label>
                                                    <input type="text" class="form-control form-control-sm upper-input" 
                                                           name="socio_1_nome" id="socio_1_nome"
                                                           value="{{ client.socio_1_nome if client else '' }}"
                                                           placeholder="Nome completo do s√≥cio">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">CPF</label>
                                                    <input type="text" class="form-control form-control-sm cpf-mask" 
                                                           name="socio_1_cpf" id="socio_1_cpf"
                                                           value="{{ (client.socio_1_cpf | format_cpf) if client else '' }}"
                                                           placeholder="000.000.000-00">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">Data de Nascimento</label>
                                                    <input type="date" class="form-control form-control-sm" 
                                                           name="socio_1_data_nascimento" id="socio_1_data_nascimento"
                                                           value="{{ client.socio_1_data_nascimento if client else '' }}">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">% de Quotas</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="socio_1_participacao" id="socio_1_participacao"
                                                           value="{{ client.socio_1_participacao if client else '' }}"
                                                           placeholder="50.00" step="0.01" min="0" max="100">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input representante-legal" type="radio" 
                                                                       name="representante_legal" value="socio_1" 
                                                                       id="rep_legal_1"
                                                                       {% if client and client.socio_1_resp_legal %}checked{% endif %}>
                                                                <label class="form-check-label small" for="rep_legal_1">
                                                                    Representante Legal
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input socio-admin" type="checkbox" 
                                                                       name="socio_1_administrador" value="1" 
                                                                       id="admin_1"
                                                                       {% if client and client.socio_1_administrador %}checked{% endif %}>
                                                                <label class="form-check-label small" for="admin_1">
                                                                    S√≥cio Administrador
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- S√≥cio 2 (CORRE√á√ÉO 09: inicialmente oculto) -->
                                    <div class="card border-light mb-2 socio-card" id="socio_2" style="display: none;">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">S√≥cio 2</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="this.closest('.socio-card').remove()">‚ùå</button>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome do S√≥cio</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="socio_2_nome" id="socio_2_nome"
                                                           value="{{ client.socio_2_nome if client else '' }}"
                                                           onkeyup="this.value=this.value.toUpperCase()"
                                                           placeholder="Nome completo do s√≥cio">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">CPF</label>
                                                    <input type="text" class="form-control form-control-sm cpf-mask" 
                                                           name="socio_2_cpf" id="socio_2_cpf"
                                                           value="{{ (client.socio_2_cpf | format_cpf) if client else '' }}"
                                                           placeholder="000.000.000-00">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">Data de Nascimento</label>
                                                    <input type="date" class="form-control form-control-sm" 
                                                           name="socio_2_data_nascimento" id="socio_2_data_nascimento"
                                                           value="{{ client.socio_2_data_nascimento if client else '' }}">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">% de Quotas</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="socio_2_participacao" id="socio_2_participacao"
                                                           value="{{ client.socio_2_participacao if client else '' }}"
                                                           placeholder="50.00" step="0.01" min="0" max="100">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input representante-legal" type="radio" 
                                                                       name="representante_legal" value="socio_2" 
                                                                       id="rep_legal_2"
                                                                       {% if client and client.representante_legal == 'socio_2' %}checked{% endif %}>
                                                                <label class="form-check-label small" for="rep_legal_2">
                                                                    Representante Legal
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input socio-admin" type="checkbox" 
                                                                       name="socio_2_administrador" value="1" 
                                                                       id="admin_2"
                                                                       {% if client and client.socio_2_administrador %}checked{% endif %}>
                                                                <label class="form-check-label small" for="admin_2">
                                                                    S√≥cio Administrador
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- S√≥cio 3 (CORRE√á√ÉO 09: inicialmente oculto) -->
                                    <div class="card border-light mb-2 socio-card" id="socio_3" style="display: none;">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">S√≥cio 3</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="this.closest('.socio-card').remove()">‚ùå</button>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome do S√≥cio</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="socio_3_nome" id="socio_3_nome"
                                                           value="{{ client.socio_3_nome if client else '' }}"
                                                           onkeyup="this.value=this.value.toUpperCase()"
                                                           placeholder="Nome completo do s√≥cio">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">CPF</label>
                                                    <input type="text" class="form-control form-control-sm cpf-mask" 
                                                           name="socio_3_cpf" id="socio_3_cpf"
                                                           value="{{ (client.socio_3_cpf | format_cpf) if client else '' }}"
                                                           placeholder="000.000.000-00">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">Data de Nascimento</label>
                                                    <input type="date" class="form-control form-control-sm" 
                                                           name="socio_3_data_nascimento" id="socio_3_data_nascimento"
                                                           value="{{ client.socio_3_data_nascimento if client else '' }}">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">% de Quotas</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="socio_3_participacao" id="socio_3_participacao"
                                                           value="{{ client.socio_3_participacao if client else '' }}"
                                                           placeholder="50.00" step="0.01" min="0" max="100">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input representante-legal" type="radio" 
                                                                       name="representante_legal" value="socio_3" 
                                                                       id="rep_legal_3"
                                                                       {% if client and client.representante_legal == 'socio_3' %}checked{% endif %}>
                                                                <label class="form-check-label small" for="rep_legal_3">
                                                                    Representante Legal
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input socio-admin" type="checkbox" 
                                                                       name="socio_3_administrador" value="1" 
                                                                       id="admin_3"
                                                                       {% if client and client.socio_3_administrador %}checked{% endif %}>
                                                                <label class="form-check-label small" for="admin_3">
                                                                    S√≥cio Administrador
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- S√≥cio 4 (CORRE√á√ÉO 09: inicialmente oculto) -->
                                    <div class="card border-light mb-2 socio-card" id="socio_4" style="display: none;">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">S√≥cio 4</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="this.closest('.socio-card').remove()">‚ùå</button>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome do S√≥cio</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="socio_4_nome" id="socio_4_nome"
                                                           value="{{ client.socio_4_nome if client else '' }}"
                                                           onkeyup="this.value=this.value.toUpperCase()"
                                                           placeholder="Nome completo do s√≥cio">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">CPF</label>
                                                    <input type="text" class="form-control form-control-sm cpf-mask" 
                                                           name="socio_4_cpf" id="socio_4_cpf"
                                                           value="{{ (client.socio_4_cpf | format_cpf) if client else '' }}"
                                                           placeholder="000.000.000-00">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">Data de Nascimento</label>
                                                    <input type="date" class="form-control form-control-sm" 
                                                           name="socio_4_data_nascimento" id="socio_4_data_nascimento"
                                                           value="{{ client.socio_4_data_nascimento if client else '' }}">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">% de Quotas</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="socio_4_participacao" id="socio_4_participacao"
                                                           value="{{ client.socio_4_participacao if client else '' }}"
                                                           placeholder="50.00" step="0.01" min="0" max="100">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input representante-legal" type="radio" 
                                                                       name="representante_legal" value="socio_4" 
                                                                       id="rep_legal_4"
                                                                       {% if client and client.representante_legal == 'socio_4' %}checked{% endif %}>
                                                                <label class="form-check-label small" for="rep_legal_4">
                                                                    Representante Legal
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input socio-admin" type="checkbox" 
                                                                       name="socio_4_administrador" value="1" 
                                                                       id="admin_4"
                                                                       {% if client and client.socio_4_administrador %}checked{% endif %}>
                                                                <label class="form-check-label small" for="admin_4">
                                                                    S√≥cio Administrador
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- S√≥cio 5 (CORRE√á√ÉO 09: inicialmente oculto) -->
                                    <div class="card border-light mb-2 socio-card" id="socio_5" style="display: none;">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">S√≥cio 5</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="this.closest('.socio-card').remove()">‚ùå</button>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome do S√≥cio</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="socio_5_nome" id="socio_5_nome"
                                                           value="{{ client.socio_5_nome if client else '' }}"
                                                           onkeyup="this.value=this.value.toUpperCase()"
                                                           placeholder="Nome completo do s√≥cio">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">CPF</label>
                                                    <input type="text" class="form-control form-control-sm cpf-mask" 
                                                           name="socio_5_cpf" id="socio_5_cpf"
                                                           value="{{ (client.socio_5_cpf | format_cpf) if client else '' }}"
                                                           placeholder="000.000.000-00">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">Data de Nascimento</label>
                                                    <input type="date" class="form-control form-control-sm" 
                                                           name="socio_5_data_nascimento" id="socio_5_data_nascimento"
                                                           value="{{ client.socio_5_data_nascimento if client else '' }}">
                                                </div>
                                                <div class="col-md-2 mb-2">
                                                    <label class="form-label small mb-1">% de Quotas</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="socio_5_participacao" id="socio_5_participacao"
                                                           value="{{ client.socio_5_participacao if client else '' }}"
                                                           placeholder="50.00" step="0.01" min="0" max="100">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input representante-legal" type="radio" 
                                                                       name="representante_legal" value="socio_5" 
                                                                       id="rep_legal_5"
                                                                       {% if client and client.representante_legal == 'socio_5' %}checked{% endif %}>
                                                                <label class="form-check-label small" for="rep_legal_5">
                                                                    Representante Legal
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input socio-admin" type="checkbox" 
                                                                       name="socio_5_administrador" value="1" 
                                                                       id="admin_5"
                                                                       {% if client and client.socio_5_administrador %}checked{% endif %}>
                                                                <label class="form-check-label small" for="admin_5">
                                                                    S√≥cio Administrador
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                <!-- Campo removido: E-MAILS ADICIONAIS DOS S√ìCIOS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 4: Contatos -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge me-2"></i>
                            Contatos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- CONTATOS DA EMPRESA -->
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-telephone-fill me-1"></i>CONTATOS DA EMPRESA
                                    </label>
                                    <button type="button" 
                                            class="btn btn-outline-primary btn-sm" 
                                            id="btnAdicionarContato"
                                            onclick="
                                                console.log('üî¥ [CONTATOS] BOT√ÉO CLICADO - Verificando contatos ocultos');
                                                
                                                // Primeiro verificar se h√° contatos est√°ticos ocultos (2-3)
                                                var contatosEstaticosOcultos = [];
                                                for (var i = 2; i <= 3; i++) {
                                                    var contatoEstatico = document.getElementById('contato_' + i);
                                                    if (contatoEstatico && contatoEstatico.style.display === 'none') {
                                                        contatosEstaticosOcultos.push(i);
                                                    }
                                                }
                                                
                                                if (contatosEstaticosOcultos.length > 0) {
                                                    // Mostrar o primeiro contato oculto
                                                    var proximoContato = contatosEstaticosOcultos[0];
                                                    var contatoElement = document.getElementById('contato_' + proximoContato);
                                                    contatoElement.style.display = 'block';
                                                    console.log('‚úÖ [CONTATOS] Contato', proximoContato, 'revelado (estava oculto)');
                                                    
                                                    // Aplicar m√°scara telefone ao contato revelado
                                                    var phoneInput = contatoElement.querySelector('.phone-mask');
                                                    if (phoneInput) {
                                                        if (phoneInput.value && phoneInput.value.length > 0) {
                                                            formatPhone(phoneInput);
                                                            console.log('üîß [CONTATOS] Telefone formatado no contato revelado:', phoneInput.value);
                                                        }
                                                    }
                                                    
                                                    // Focar no primeiro campo do contato revelado
                                                    var firstInput = contatoElement.querySelector('input');
                                                    if (firstInput) firstInput.focus();
                                                    
                                                    return; // Sair da fun√ß√£o - n√£o criar contato din√¢mico
                                                }
                                                
                                                // Se chegou aqui, todos os contatos est√°ticos (2-3) j√° est√£o vis√≠veis
                                                // Proceder com cria√ß√£o de contato din√¢mico (4+)
                                                console.log('üîß [CONTATOS] Todos contatos est√°ticos vis√≠veis - criando din√¢mico');
                                                
                                                var container = document.getElementById('contatosContainer');
                                                if (!container) {
                                                    alert('Container de contatos n√£o encontrado!');
                                                    return;
                                                }
                                                console.log('‚úÖ Container de contatos encontrado');
                                                var contatos = container.querySelectorAll('.contato-card');
                                                var total = contatos.length;
                                                console.log('üìä Total contatos:', total);
                                                if (total >= 10) {
                                                    alert('M√°ximo 10 contatos!');
                                                    return;
                                                }
                                                var num = total + 1;
                                                var div = document.createElement('div');
                                                div.className = 'card border-light mb-2 contato-card';
                                                div.id = 'contato_' + num;
                                                div.innerHTML = '<div class=\&quot;card-body py-3\&quot;><div class=\&quot;d-flex justify-content-between align-items-center mb-2\&quot;><span class=\&quot;badge bg-success\&quot;>Contato ' + num + '</span><button type=\&quot;button\&quot; class=\&quot;btn btn-sm btn-outline-danger\&quot; onclick=\&quot;this.closest(\\\&quot;.contato-card\\\&quot;).remove();\&quot;>‚ùå</button></div><div class=\&quot;row align-items-center\&quot;><div class=\&quot;col-md-3 mb-2\&quot;><label class=\&quot;form-label small mb-1\&quot;>Nome</label><input type=\&quot;text\&quot; class=\&quot;form-control form-control-sm\&quot; name=\&quot;contato_' + num + '_nome\&quot; onkeyup=\&quot;this.value=this.value.toUpperCase()\&quot; placeholder=\&quot;Nome completo do contato\&quot;></div><div class=\&quot;col-md-3 mb-2\&quot;><label class=\&quot;form-label small mb-1\&quot;>Cargo</label><input type=\&quot;text\&quot; class=\&quot;form-control form-control-sm\&quot; name=\&quot;contato_' + num + '_cargo\&quot; placeholder=\&quot;Ex: Gerente, Diretor, S√≥cio\&quot;></div><div class=\&quot;col-md-3 mb-2\&quot;><label class=\&quot;form-label small mb-1\&quot;>Telefone</label><input type=\&quot;tel\&quot; class=\&quot;form-control form-control-sm phone-mask\&quot; name=\&quot;contato_' + num + '_telefone\&quot; placeholder=\&quot;(85) 99999-9999\&quot;></div><div class=\&quot;col-md-3 mb-2\&quot;><label class=\&quot;form-label small mb-1\&quot;>E-mail</label><input type=\&quot;email\&quot; class=\&quot;form-control form-control-sm\&quot; name=\&quot;contato_' + num + '_email\&quot; placeholder=\&quot;contato@empresa.com\&quot;></div></div></div>';
                                                container.appendChild(div);
                                                
                                                // Aplicar m√°scaras aos novos campos
                                                console.log('üîß [CONTATOS] Aplicando m√°scara telefone ao contato', num);
                                                var phoneInput = div.querySelector('.phone-mask');
                                                if (phoneInput) {
                                                    // Event listener para input em tempo real
                                                    phoneInput.addEventListener('input', function() {
                                                        formatPhone(this);
                                                    });
                                                    
                                                    // Event listener para blur (quando sai do campo)
                                                    phoneInput.addEventListener('blur', function() {
                                                        if (this.value && this.value.length > 0) {
                                                            formatPhone(this);
                                                        }
                                                    });
                                                    
                                                    // Formatar se j√° tiver valor
                                                    if (phoneInput.value && phoneInput.value.length > 0) {
                                                        formatPhone(phoneInput);
                                                    }
                                                    
                                                    console.log('‚úÖ [CONTATOS] M√°scara telefone aplicada ao contato', num);
                                                } else {
                                                    console.error('‚ùå [CONTATOS] Campo telefone n√£o encontrado no contato', num);
                                                }
                                                
                                                console.log('‚úÖ [CONTATOS] Contato din√¢mico', num, 'adicionado com TODOS os campos e m√°scaras!');
                                                
                                                // Reaplicar formata√ß√£o de telefone ap√≥s adicionar contato
                                                setTimeout(function() {
                                                    reaplicarFormatacaoTelefone();
                                                    console.log('üîß [CONTATOS] Formata√ß√£o telefone reaplicada ap√≥s adicionar contato', num);
                                                }, 50);
                                                
                                                var input = div.querySelector('input');
                                                if (input) input.focus();
                                            ">
                                        <i class="bi bi-plus-circle me-1"></i>Adicionar Contato
                                    </button>
                                </div>
                                
                                <!-- Container para os contatos -->
                                <div id="contatosContainer">
                                    <!-- Contato 1 (sempre presente) -->
                                    <div class="card border-light mb-2 contato-card" id="contato_1">
                                        <div class="card-body py-3">
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_1_nome" id="contato_1_nome"
                                                           value="{{ client.contato_1_nome if client and client.contato_1_nome else '' }}"
                                                           placeholder="Nome completo do contato">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Cargo</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_1_cargo" id="contato_1_cargo"
                                                           value="{{ client.contato_1_cargo if client and client.contato_1_cargo else '' }}"
                                                           placeholder="Ex: Gerente, Diretor, S√≥cio">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Telefone</label>
                                                    <input type="tel" class="form-control form-control-sm phone-mask" 
                                                           name="contato_1_telefone" id="contato_1_telefone"
                                                           value="{{ client.contato_1_telefone if client and client.contato_1_telefone else '' }}"
                                                           placeholder="(85) 99999-9999">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">E-mail</label>
                                                    <input type="email" class="form-control form-control-sm" 
                                                           name="contato_1_email" id="contato_1_email"
                                                           value="{{ client.contato_1_email if client and client.contato_1_email else '' }}"
                                                           placeholder="contato@empresa.com">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contato 2 (CORRE√á√ÉO 09: inicialmente oculto) -->
                                    <div class="card border-light mb-2 contato-card" id="contato_2" style="display: none;">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-success">Contato 2</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="this.closest('.contato-card').remove()">‚ùå</button>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_2_nome" id="contato_2_nome"
                                                           value="{{ client.contato_2_nome if client and client.contato_2_nome else '' }}"
                                                           placeholder="Nome completo do contato">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Cargo</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_2_cargo" id="contato_2_cargo"
                                                           value="{{ client.contato_2_cargo if client and client.contato_2_cargo else '' }}"
                                                           placeholder="Ex: Gerente, Diretor, S√≥cio">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Telefone</label>
                                                    <input type="tel" class="form-control form-control-sm phone-mask" 
                                                           name="contato_2_telefone" id="contato_2_telefone"
                                                           value="{{ client.contato_2_telefone if client and client.contato_2_telefone else '' }}"
                                                           placeholder="(85) 99999-9999">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">E-mail</label>
                                                    <input type="email" class="form-control form-control-sm" 
                                                           name="contato_2_email" id="contato_2_email"
                                                           value="{{ client.contato_2_email if client and client.contato_2_email else '' }}"
                                                           placeholder="contato@empresa.com">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contato 3 (CORRE√á√ÉO 09: inicialmente oculto) -->
                                    <div class="card border-light mb-2 contato-card" id="contato_3" style="display: none;">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-success">Contato 3</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="this.closest('.contato-card').remove()">‚ùå</button>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_3_nome" id="contato_3_nome"
                                                           value="{{ client.contato_3_nome if client and client.contato_3_nome else '' }}"
                                                           placeholder="Nome completo do contato">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Cargo</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_3_cargo" id="contato_3_cargo"
                                                           value="{{ client.contato_3_cargo if client and client.contato_3_cargo else '' }}"
                                                           placeholder="Ex: Gerente, Diretor, S√≥cio">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Telefone</label>
                                                    <input type="tel" class="form-control form-control-sm phone-mask" 
                                                           name="contato_3_telefone" id="contato_3_telefone"
                                                           value="{{ client.contato_3_telefone if client and client.contato_3_telefone else '' }}"
                                                           placeholder="(85) 99999-9999">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">E-mail</label>
                                                    <input type="email" class="form-control form-control-sm" 
                                                           name="contato_3_email" id="contato_3_email"
                                                           value="{{ client.contato_3_email if client and client.contato_3_email else '' }}"
                                                           placeholder="contato@empresa.com">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contato 4 (CORRE√á√ÉO 09: inicialmente oculto) -->
                                    <div class="card border-light mb-2 contato-card" id="contato_4" style="display: none;">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-success">Contato 4</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="this.closest('.contato-card').remove()">‚ùå</button>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_4_nome" id="contato_4_nome"
                                                           value="{{ client.contato_4_nome if client and client.contato_4_nome else '' }}"
                                                           placeholder="Nome completo do contato">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Cargo</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_4_cargo" id="contato_4_cargo"
                                                           value="{{ client.contato_4_cargo if client and client.contato_4_cargo else '' }}"
                                                           placeholder="Ex: Gerente, Diretor, S√≥cio">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Telefone</label>
                                                    <input type="tel" class="form-control form-control-sm phone-mask" 
                                                           name="contato_4_telefone" id="contato_4_telefone"
                                                           value="{{ client.contato_4_telefone if client and client.contato_4_telefone else '' }}"
                                                           placeholder="(85) 99999-9999">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">E-mail</label>
                                                    <input type="email" class="form-control form-control-sm" 
                                                           name="contato_4_email" id="contato_4_email"
                                                           value="{{ client.contato_4_email if client and client.contato_4_email else '' }}"
                                                           placeholder="contato@empresa.com">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contato 5 (CORRE√á√ÉO 09: inicialmente oculto) -->
                                    <div class="card border-light mb-2 contato-card" id="contato_5" style="display: none;">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-success">Contato 5</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="this.closest('.contato-card').remove()">‚ùå</button>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Nome</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_5_nome" id="contato_5_nome"
                                                           value="{{ client.contato_5_nome if client and client.contato_5_nome else '' }}"
                                                           placeholder="Nome completo do contato">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Cargo</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           name="contato_5_cargo" id="contato_5_cargo"
                                                           value="{{ client.contato_5_cargo if client and client.contato_5_cargo else '' }}"
                                                           placeholder="Ex: Gerente, Diretor, S√≥cio">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">Telefone</label>
                                                    <input type="tel" class="form-control form-control-sm phone-mask" 
                                                           name="contato_5_telefone" id="contato_5_telefone"
                                                           value="{{ client.contato_5_telefone if client and client.contato_5_telefone else '' }}"
                                                           placeholder="(85) 99999-9999">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small mb-1">E-mail</label>
                                                    <input type="email" class="form-control form-control-sm" 
                                                           name="contato_5_email" id="contato_5_email"
                                                           value="{{ client.contato_5_email if client and client.contato_5_email else '' }}"
                                                           placeholder="contato@empresa.com">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 5: Senhas -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-key me-2"></i>Senhas
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Linha 1: CNPJ Acesso Simples Nacional, CPF do Representante Legal, C√≥digo de Acesso Simples Nacional, Senha ISS -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <label for="cnpjAcessoSn" class="form-label small">CNPJ Acesso Simples Nacional</label>
                                <input type="text" class="form-control form-control-sm cnpj-mask" 
                                       id="cnpjAcessoSn" name="cnpjAcessoSn" 
                                       value="{{ client.cnpjAcessoSn if client else '' }}" 
                                       placeholder="00.000.000/0001-00">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="cpfRepLegal" class="form-label small">CPF do Representante Legal</label>
                                <input type="text" class="form-control form-control-sm cpf-mask" 
                                       id="cpfRepLegal" name="cpfRepLegal" 
                                       value="{{ client.cpfRepLegal if client else '' }}" 
                                       placeholder="000.000.000-00">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="codigoAcessoSn" class="form-label small">C√≥digo de Acesso Simples Nacional</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="codigoAcessoSn" name="codigoAcessoSn" 
                                       value="{{ client.codigoAcessoSn if client else '' }}" 
                                       placeholder="C√≥digo de Acesso">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="senhaIss" class="form-label small">Senha ISS</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaIss" name="senhaIss" 
                                       value="{{ client.senhaIss if client else '' }}" 
                                       placeholder="Senha ISS">
                            </div>
                        </div>

                        <!-- Linha 2: Senha SEFIN, Senha SEUMA, Acesso EmpWeb, Senha EmpWeb -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <label for="senhaSefin" class="form-label small">Senha SEFIN</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaSefin" name="senhaSefin" 
                                       value="{{ client.senhaSefin if client else '' }}" 
                                       placeholder="Senha SEFIN">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="senhaSeuma" class="form-label small">Senha SEUMA</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaSeuma" name="senhaSeuma" 
                                       value="{{ client.senhaSeuma if client else '' }}" 
                                       placeholder="Senha SEUMA">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="acessoEmpWeb" class="form-label small">Acesso EmpWeb</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoEmpWeb" name="acessoEmpWeb" 
                                       value="{{ client.acessoEmpWeb if client else '' }}" 
                                       placeholder="Login EmpWeb">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="senhaEmpWeb" class="form-label small">Senha EmpWeb</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaEmpWeb" name="senhaEmpWeb" 
                                       value="{{ client.senhaEmpWeb if client else '' }}" 
                                       placeholder="Senha EmpWeb">
                            </div>
                        </div>

                        <!-- Linha 3: Login ANVISA Empresa, Senha ANVISA Empresa, Login ANVISA Gestor, Senha ANVISA Gestor -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <label for="anvisaEmpresa" class="form-label small">Login ANVISA Empresa</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="anvisaEmpresa" name="anvisaEmpresa" 
                                       value="{{ client.anvisaEmpresa if client else '' }}" 
                                       placeholder="Login ANVISA Empresa">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="senhaAnvisaEmpresa" class="form-label small">Senha ANVISA Empresa</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaAnvisaEmpresa" name="senhaAnvisaEmpresa" 
                                       value="{{ client.senhaAnvisaEmpresa if client else '' }}" 
                                       placeholder="Senha ANVISA Empresa">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="anvisaGestor" class="form-label small">Login ANVISA Gestor</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="anvisaGestor" name="anvisaGestor" 
                                       value="{{ client.anvisaGestor if client else '' }}" 
                                       placeholder="Login ANVISA Gestor">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="senhaAnvisaGestor" class="form-label small">Senha ANVISA Gestor</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaAnvisaGestor" name="senhaAnvisaGestor" 
                                       value="{{ client.senhaAnvisaGestor if client else '' }}" 
                                       placeholder="Senha ANVISA Gestor">
                            </div>
                        </div>

                        <!-- Linha 4: Acesso CRF, Senha FAP/INSS -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <label for="acessoCrf" class="form-label small">Acesso CRF</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="acessoCrf" name="acessoCrf" 
                                       value="{{ client.acessoCrf if client else '' }}" 
                                       placeholder="CRF do Respons√°vel">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="senhaFapInss" class="form-label small">Senha FAP/INSS</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="senhaFapInss" name="senhaFapInss" 
                                       value="{{ client.senhaFapInss if client else '' }}" 
                                       placeholder="Senha FAP/INSS">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 6: Procura√ß√µes -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text me-2"></i>Procura√ß√µes
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Procura√ß√µes em uma √∫nica linha -->
                        <div class="row mb-3">
                            <!-- Proc. Receita -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procReceita" name="procReceita" 
                                           onchange="toggleProcuracaoData('procReceita', 'dataProcReceita')"
                                           {% if client and client.procReceita %}checked{% endif %}>
                                    <label class="form-check-label small" for="procReceita">
                                        <strong>Proc. Receita</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcReceita" name="dataProcReceita" 
                                       value="{{ client.dataProcReceita if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>

                            <!-- Proc. DTe -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procDte" name="procDte" 
                                           onchange="toggleProcuracaoData('procDte', 'dataProcDte')"
                                           {% if client and client.procDte %}checked{% endif %}>
                                    <label class="form-check-label small" for="procDte">
                                        <strong>Proc. DTe</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcDte" name="dataProcDte" 
                                       value="{{ client.dataProcDte if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>

                            <!-- Proc. Caixa -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procCaixa" name="procCaixa" 
                                           onchange="toggleProcuracaoData('procCaixa', 'dataProcCaixa')"
                                           {% if client and client.procCaixa %}checked{% endif %}>
                                    <label class="form-check-label small" for="procCaixa">
                                        <strong>Proc. Caixa</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcCaixa" name="dataProcCaixa" 
                                       value="{{ client.dataProcCaixa if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>

                            <!-- Proc. Emp. Web -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procEmpWeb" name="procEmpWeb" 
                                           onchange="toggleProcuracaoData('procEmpWeb', 'dataProcEmpWeb')"
                                           {% if client and client.procEmpWeb %}checked{% endif %}>
                                    <label class="form-check-label small" for="procEmpWeb">
                                        <strong>Proc. Emp. Web</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcEmpWeb" name="dataProcEmpWeb" 
                                       value="{{ client.dataProcEmpWeb if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>

                            <!-- Proc. DET -->
                            <div class="col-md mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           id="procDet" name="procDet" 
                                           onchange="toggleProcuracaoData('procDet', 'dataProcDet')"
                                           {% if client and client.procDet %}checked{% endif %}>
                                    <label class="form-check-label small" for="procDet">
                                        <strong>Proc. DET</strong>
                                    </label>
                                </div>
                                <input type="text" class="form-control form-control-sm date-mask" 
                                       id="dataProcDet" name="dataProcDet" 
                                       value="{{ client.dataProcDet if client else '' }}" 
                                       placeholder="DD/MM/AAAA">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloco 7: Observa√ß√µes e Dados Adicionais -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-chat-left-text me-2"></i>Observa√ß√µes e Dados Adicionais
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Observa√ß√µes Gerais -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="observacoes" class="form-label">
                                    <i class="fas fa-sticky-note me-2"></i>OBSERVA√á√ïES GERAIS
                                </label>
                                <textarea class="form-control" id="observacoes" name="observacoes" rows="4" 
                                          placeholder="Digite aqui observa√ß√µes gerais sobre o cliente...">{{ client.observacoes if client else '' }}</textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Este campo ser√° exibido no "Ver Detalhes" do cliente para consulta r√°pida
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- status do cliente -->
                            <div class="col-md-6 mb-3">
                                <label for="statusCliente" class="form-label">STATUS DO CLIENTE</label>
                                <select class="form-select" id="statusCliente" name="statusCliente">
                                    <option value="ativo" {{ 'selected' if client and client.statusCliente == 'ativo' else '' }}>Ativo</option>
                                    <option value="inativo" {{ 'selected' if client and client.statusCliente == 'inativo' else '' }}>Inativo</option>
                                </select>
                            </div>
                            <!-- Data da √∫ltima atualiza√ß√£o -->
                            <div class="col-md-6 mb-3">
                                <label for="ultimaAtualizacao" class="form-label">√öltima atualiza√ß√£o</label>
                                <input type="datetime-local" class="form-control" id="ultimaAtualizacao" name="ultimaAtualizacao" 
                                       value="{{ client.ultimaAtualizacao[:19] if client and client.ultimaAtualizacao else '' }}" readonly>
                                <div class="form-text">Atualizado automaticamente</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de a√ß√£o -->
                {% if not view_mode %}
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="submit" class="btn btn-primary me-3">
                                    <i class="bi bi-check-lg me-1"></i>
                                    {% if client %}Atualizar Cliente{% else %}Salvar Cliente{% endif %}
                                </button>
                                <a href="/" class="btn btn-secondary">
                                    <i class="bi bi-x-lg me-1"></i>
                                    Cancelar
                                </a>
                            </div>
                            {% if client %}
                            <button type="button" class="btn btn-outline-danger" 
                                    onclick="confirmDelete('{{ client.id }}', '{{ client.nomeEmpresa }}')">
                                <i class="bi bi-trash me-1"></i>
                                Excluir Cliente
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Bot√µes de visualiza√ß√£o -->
                <div class="card">
                    <div class="card-body text-center">
                        <a href="{{ url_for('edit_client', client_id=client.id) }}" class="btn btn-primary me-3">
                            <i class="bi bi-pencil me-1"></i>
                            Editar Cliente
                        </a>
                        <a href="/" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-1"></i>
                            Voltar
                        </a>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirma√ß√£o de exclus√£o -->
{% if client %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Confirmar Exclus√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o cliente <strong id="clientName">{{ client.nomeEmpresa }}</strong>?</p>
                <p class="text-muted">Esta a√ß√£o n√£o pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" method="POST" action="/client/{{ client.id }}/delete" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Excluir
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// =============================================================================
// (Removido bloco duplicado de DOMContentLoaded; l√≥gica consolidada abaixo)
// =============================================================================

// CORRE√á√ÉO 07: Fun√ß√£o utilit√°ria para reaplicar formata√ß√£o CPF em todos os campos
function reaplicarFormatacaoCPF() {
    console.log('üîß [CORRE√á√ÉO 07] Reaplicando formata√ß√£o CPF em todos os campos...');
    
    const camposCpf = document.querySelectorAll('.cpf-mask, input[name*="_cpf"]');
    let contador = 0;
    
    camposCpf.forEach(function(input) {
        if (input.value && input.value.length > 0) {
            const valorAntes = input.value;
            formatCPF(input);
            
            if (valorAntes !== input.value) {
                console.log('‚úÖ [CORRE√á√ÉO 07] CPF reformatado:', input.name || input.id, valorAntes, '‚Üí', input.value);
                contador++;
            }
        }
        
        // Garantir que tem event listeners
        if (!input.hasAttribute('data-cpf-listener')) {
            input.addEventListener('input', function() {
                formatCPF(this);
            });
            
            input.addEventListener('blur', function() {
                if (this.value && this.value.length > 0) {
                    formatCPF(this);
                }
            });
            
            input.setAttribute('data-cpf-listener', 'true');
        }
    });
    
    console.log(`‚úÖ [CORRE√á√ÉO 07] Reaplica√ß√£o conclu√≠da: ${contador} campos reformatados de ${camposCpf.length} encontrados`);
    return contador;
}

// Fun√ß√£o para reaplicar formata√ß√£o de telefone em todos os campos
function reaplicarFormatacaoTelefone() {
    console.log('üîß [CONTATOS] Reaplicando formata√ß√£o telefone em todos os campos...');
    
    const camposTelefone = document.querySelectorAll('.phone-mask, input[name*="_telefone"]');
    let contador = 0;
    
    camposTelefone.forEach(function(input) {
        if (input.value && input.value.length > 0) {
            const valorAntes = input.value;
            formatPhone(input);
            
            if (valorAntes !== input.value) {
                console.log('‚úÖ [CONTATOS] Telefone reformatado:', input.name || input.id, valorAntes, '‚Üí', input.value);
                contador++;
            }
        }
        
        // Garantir que tem event listeners
        if (!input.hasAttribute('data-phone-listener')) {
            input.addEventListener('input', function() {
                formatPhone(this);
            });
            
            input.addEventListener('blur', function() {
                if (this.value && this.value.length > 0) {
                    formatPhone(this);
                }
            });
            
            input.setAttribute('data-phone-listener', 'true');
        }
    });
    
    console.log(`‚úÖ [CONTATOS] Reaplica√ß√£o conclu√≠da: ${contador} campos reformatados de ${camposTelefone.length} encontrados`);
    return contador;
}

// Formata√ß√£o de CNPJ
function formatCNPJ(input) {
    // Salvar posi√ß√£o do cursor
    const cursorPos = input.selectionStart;
    const valueLength = input.value.length;
    
    // Remover tudo que n√£o √© d√≠gito
    let value = input.value.replace(/\D/g, '');
    
    // Aplicar formata√ß√£o apenas se tiver d√≠gitos
    if (value.length > 0) {
        // Limitar a 14 d√≠gitos
        if (value.length > 14) {
            value = value.substring(0, 14);
        }
        
        // Aplicar formata√ß√£o progressiva para CNPJ: 00.000.000/0000-00
        if (value.length >= 3) {
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
        }
        if (value.length >= 6) {
            value = value.replace(/^(\d{2}\.\d{3})(\d)/, '$1.$2');
        }
        if (value.length >= 9) {
            value = value.replace(/^(\d{2}\.\d{3}\.\d{3})(\d)/, '$1/$2');
        }
        if (value.length >= 13) {
            value = value.replace(/^(\d{2}\.\d{3}\.\d{3}\/\d{4})(\d)/, '$1-$2');
        }
    }
    
    // Atualizar valor
    input.value = value;
    
    // Calcular nova posi√ß√£o do cursor baseado na diferen√ßa de tamanho
    const lengthDiff = value.length - valueLength;
    const newCursorPos = Math.min(Math.max(cursorPos + lengthDiff, 0), value.length);
    
    // Restaurar posi√ß√£o do cursor
    if (input.setSelectionRange) {
        setTimeout(() => {
            input.setSelectionRange(newCursorPos, newCursorPos);
        }, 0);
    }
}

// Formata√ß√£o din√¢mica de CPF/CNPJ
function formatCPFCNPJ(input) {
    const value = input.value.replace(/\D/g, '');
    
    if (value.length <= 11) {
        // Formatar como CPF
        formatCPF(input);
    } else {
        // Formatar como CNPJ
        formatCNPJ(input);
    }
}

// Formata√ß√£o de Data (DD/MM/AAAA)
function formatDate(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 8) {
        value = value.replace(/(\d{2})(\d)/, '$1/$2');
        value = value.replace(/(\d{2})\/(\d{2})(\d)/, '$1/$2/$3');
    }
    input.value = value;
}

// Aplicar m√°scaras aos campos existentes
document.addEventListener('DOMContentLoaded', function() {
    // =============================================================
    // CORRE√á√ÉO: CPF/CNPJ -> Label + Dom√©stica (IMPLEMENTA√á√ÉO SIMPLES)
    // =============================================================
    console.log('ÔøΩ DOM carregado - configurando CPF/CNPJ e Dom√©stica');
    
    function atualizarCpfCnpjEDomestica() {
        const cpfCnpjInput = document.getElementById('cpfCnpj');
        const domesticaSelect = document.getElementById('domestica');
        const labelCpfCnpj = document.querySelector('label[for="cpfCnpj"]');
        
        if (!cpfCnpjInput || !domesticaSelect) {
            console.log('‚ùå Campos n√£o encontrados');
            return;
        }
        
        // Aplicar formata√ß√£o din√¢mica primeiro
        formatCPFCNPJ(cpfCnpjInput);
        
        const valor = cpfCnpjInput.value.replace(/\D/g, ''); // Remove n√£o-d√≠gitos
        console.log('üìã Processando:', valor, '- Length:', valor.length);
        
        // Atualizar label e controlar Dom√©stica
        if (valor.length === 11) {
            // √â CPF
            console.log('üë§ CPF detectado - 11 d√≠gitos');
            if (labelCpfCnpj) {
                labelCpfCnpj.innerHTML = '<i class="bi bi-person me-1"></i>CPF <span class="text-danger">*</span>';
            }
            domesticaSelect.disabled = false;
            console.log('‚úÖ DOM√âSTICA HABILITADA para CPF');
        } else if (valor.length === 14) {
            // √â CNPJ
            console.log('üè¢ CNPJ detectado - 14 d√≠gitos');
            if (labelCpfCnpj) {
                labelCpfCnpj.innerHTML = '<i class="bi bi-building me-1"></i>CNPJ <span class="text-danger">*</span>';
            }
            domesticaSelect.disabled = true;
            domesticaSelect.value = 'N√ÉO';
            console.log('üè¢ Dom√©stica desabilitada para CNPJ');
        } else {
            // Incompleto
            console.log('‚è≥ Documento incompleto');
            if (labelCpfCnpj) {
                labelCpfCnpj.innerHTML = '<i class="bi bi-card-text me-1"></i>CPF/CNPJ <span class="text-danger">*</span>';
            }
            domesticaSelect.disabled = true;
            domesticaSelect.value = 'N√ÉO';
            console.log('‚ùå Dom√©stica desabilitada - incompleto');
        }
        
        console.log('üìä Estado final: disabled =', domesticaSelect.disabled, 'valor:', domesticaSelect.value);
    }
    
    // CONFIGURA√á√ÉO INICIAL CPF/CNPJ E DOM√âSTICA
    // Nota: Event listeners est√£o configurados na se√ß√£o updateRequiredFields para evitar conflitos
    console.log('‚úÖ Fun√ß√µes CPF/CNPJ carregadas - event listeners configurados automaticamente');
    
    // =============================================================
    // RESTANTE DAS CONFIGURA√á√ïES
    // =============================================================
    
    // CORRE√á√ÉO 07: Aplicar m√°scara de CPF melhorada
    document.querySelectorAll('.cpf-mask').forEach(function(input) {
        // Formatar valores j√° preenchidos (dados existentes)
        if (input.value && input.value.length > 0) {
            formatCPF(input);
            console.log('üîß [CORRE√á√ÉO 07] CPF formatado em campo preexistente:', input.name, '‚Üí', input.value);
        }
        
        // Remover event listeners duplicados se existirem
        if (input.hasAttribute('data-cpf-listener')) {
            return; // J√° tem listeners aplicados
        }
        
        // Aplicar event listener para formata√ß√£o em tempo real
        input.addEventListener('input', function(e) {
            formatCPF(this);
        });
        
        // Aplicar event listener para formata√ß√£o quando sai do campo
        input.addEventListener('blur', function(e) {
            if (this.value && this.value.length > 0) {
                formatCPF(this);
                console.log('üîß [CORRE√á√ÉO 07] CPF formatado no blur:', this.name, '‚Üí', this.value);
            }
        });
        
        // Aplicar event listener para formata√ß√£o ao colar
        input.addEventListener('paste', function(e) {
            setTimeout(() => {
                formatCPF(this);
                console.log('üîß [CORRE√á√ÉO 07] CPF formatado ap√≥s paste:', this.name, '‚Üí', this.value);
            }, 10);
        });
        
        // Marcar como processado
        input.setAttribute('data-cpf-listener', 'true');
    });
    
    // Aplicar m√°scara de telefone
    document.querySelectorAll('.phone-mask').forEach(function(input) {
        input.addEventListener('input', function() {
            formatPhone(this);
        });
    });

    // Aplicar m√°scara de data (DD/MM/AAAA)
    document.querySelectorAll('.date-mask').forEach(function(input) {
        input.addEventListener('input', function() {
            formatDate(this);
        });
    });

    // Funcionalidade para campos que s√≥ aceitam n√∫meros
    document.querySelectorAll('.numbers-only').forEach(function(input) {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    });

    // M√°scara para data MM/AAAA - CORRE√á√ÉO 05
    const dataInicioInput = document.getElementById('dataInicioServicos');
    if (dataInicioInput) {
        // Fun√ß√£o para aplicar m√°scara MM/AAAA
        function aplicarMascaraMMAAAA(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© d√≠gito
            
            // Limita a 6 d√≠gitos (MMAAAA)
            value = value.substring(0, 6);
            
            // Aplica m√°scara MM/AAAA
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 6);
            }
            
            return value;
        }
        
        // Event listeners para capturar todas as formas de entrada
        dataInicioInput.addEventListener('input', function() {
            this.value = aplicarMascaraMMAAAA(this);
            console.log('üîç [CORRE√á√ÉO 05] M√°scara aplicada:', this.value);
        });
        
        dataInicioInput.addEventListener('keyup', function() {
            this.value = aplicarMascaraMMAAAA(this);
        });
        
        dataInicioInput.addEventListener('paste', function(e) {
            setTimeout(() => {
                this.value = aplicarMascaraMMAAAA(this);
            }, 10);
        });
        
        // Valida√ß√£o adicional
        dataInicioInput.addEventListener('blur', function() {
            const value = this.value;
            if (value && !value.match(/^(0[1-9]|1[0-2])\/\d{4}$/)) {
                console.warn('‚ö†Ô∏è [CORRE√á√ÉO 05] Formato inv√°lido:', value);
            }
        });
        
        console.log('‚úÖ [CORRE√á√ÉO 05] M√°scara MM/AAAA configurada');
    }

    // Configurar controle de representante legal (apenas um pode ser selecionado)
    setTimeout(function() {
        configurarControleSocios();
    }, 100);

    // Inicializar estado dos campos de procura√ß√£o
    inicializarProcuracoes();
    console.log('üìã Procura√ß√µes inicializadas');

    // Inicializar valida√ß√£o de campos obrigat√≥rios
    inicializarValidacaoCampos();
    console.log('‚úÖ Valida√ß√£o de campos inicializada');

    // Adicionar valida√ß√£o no submit do formul√°rio
    const form = document.querySelector('form.needs-validation');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üìù Submit do formul√°rio interceptado');
            console.log('üîç URL de a√ß√£o:', form.action);
            console.log('üîç M√©todo:', form.method);
            
            // Verificar se √© edi√ß√£o ou cria√ß√£o
            const idField = document.querySelector('input[name="id"]');
            const clientId = idField ? idField.value : '';
            console.log('üîç ID do cliente:', clientId || 'NOVO CLIENTE');
            console.log('üîç Tipo de opera√ß√£o:', clientId ? 'EDI√á√ÉO' : 'CRIA√á√ÉO');
            
            // Sempre adicionar classe para mostrar valida√ß√£o visual
            form.classList.add('was-validated');
            
            if (!validarFormulario(this)) {
                e.preventDefault();
                e.stopPropagation();
                console.log('‚ùå Submit cancelado devido a erros de valida√ß√£o');
                return false;
            }
            
            console.log('‚úÖ Formul√°rio v√°lido, enviando...');
        });
        
        console.log('‚úÖ Event listener de submit adicionado');
    } else {
        console.error('‚ùå Formul√°rio n√£o encontrado!');
    }

    // =============================================================
    // CORRE√á√ÉO 09: Controle de Visibilidade dos S√≥cios
    // =============================================================
    console.log('üîß [CORRE√á√ÉO 09] Configurando visibilidade inicial dos s√≥cios');
    
    // Fun√ß√£o para mostrar s√≥cios com dados
    function mostrarSociosComDados() {
        {% if client %}
        const dadosCliente = {{ client|tojson }};
        console.log('üîç [CORRE√á√ÉO 09] Verificando dados dos s√≥cios...');
        console.log('üîç [CORRE√á√ÉO 09] Dados completos do cliente:', dadosCliente);
        
        // Verificar s√≥cios 2-5 e mostrar apenas os que t√™m dados
        for (var i = 2; i <= 5; i++) {
            var nomeKey = 'socio_' + i + '_nome';
            var cpfKey = 'socio_' + i + '_cpf';
            var participacaoKey = 'socio_' + i + '_participacao';
            var nascimentoKey = 'socio_' + i + '_data_nascimento';
            var adminKey = 'socio_' + i + '_administrador';
            
            var temNome = dadosCliente[nomeKey] && dadosCliente[nomeKey].trim() !== '';
            var temCpf = dadosCliente[cpfKey] && dadosCliente[cpfKey].trim() !== '';
            var temParticipacao = dadosCliente[participacaoKey] && dadosCliente[participacaoKey] !== '' && dadosCliente[participacaoKey] !== null;
            var temNascimento = dadosCliente[nascimentoKey] && dadosCliente[nascimentoKey].trim() !== '';
            var temAdmin = dadosCliente[adminKey] && dadosCliente[adminKey] !== '' && dadosCliente[adminKey] !== null;
            
            console.log(`üîç [CORRE√á√ÉO 09] S√≥cio ${i}:`, {
                nome: temNome ? dadosCliente[nomeKey] : 'vazio',
                cpf: temCpf ? dadosCliente[cpfKey] : 'vazio',
                participacao: temParticipacao ? dadosCliente[participacaoKey] : 'vazio',
                nascimento: temNascimento ? dadosCliente[nascimentoKey] : 'vazio',
                admin: temAdmin ? dadosCliente[adminKey] : 'vazio'
            });
            
            // Se tem pelo menos um campo preenchido, mostrar o s√≥cio
            if (temNome || temCpf || temParticipacao || temNascimento || temAdmin) {
                var socioElement = document.getElementById('socio_' + i);
                if (socioElement) {
                    socioElement.style.display = 'block';
                    console.log('‚úÖ [CORRE√á√ÉO 09] S√≥cio', i, 'mostrado (tem dados)');
                    
                    // Aplicar formata√ß√£o CPF se necess√°rio
                    var cpfInput = socioElement.querySelector('.cpf-mask');
                    if (cpfInput && cpfInput.value && cpfInput.value.length > 0) {
                        formatCPF(cpfInput);
                        console.log('üîß [CORRE√á√ÉO 09] CPF formatado no s√≥cio', i);
                    }
                } else {
                    console.warn('‚ö†Ô∏è [CORRE√á√ÉO 09] Elemento socio_' + i + ' n√£o encontrado');
                }
            } else {
                console.log('üìù [CORRE√á√ÉO 09] S√≥cio', i, 'mantido oculto (sem dados)');
            }
        }
        {% else %}
        console.log('üìù [CORRE√á√ÉO 09] Novo cliente - apenas S√≥cio 1 vis√≠vel');
        {% endif %}
    }
    
    // Fun√ß√£o para mostrar contatos com dados
    function mostrarContatosComDados() {
        {% if client %}
        const dadosCliente = {{ client|tojson }};
        console.log('üîç [CORRE√á√ÉO 09] Verificando dados dos contatos...');
        console.log('üîç [CORRE√á√ÉO 09] Dados completos do cliente (contatos):', dadosCliente);
        
        // Verificar contatos 2-5 e mostrar apenas os que t√™m dados
        for (var i = 2; i <= 5; i++) {
            var nomeKey = 'contato_' + i + '_nome';
            var cargoKey = 'contato_' + i + '_cargo';
            var telefoneKey = 'contato_' + i + '_telefone';
            var emailKey = 'contato_' + i + '_email';
            
            var temNome = dadosCliente[nomeKey] && dadosCliente[nomeKey].trim() !== '';
            var temCargo = dadosCliente[cargoKey] && dadosCliente[cargoKey].trim() !== '';
            var temTelefone = dadosCliente[telefoneKey] && dadosCliente[telefoneKey].trim() !== '';
            var temEmail = dadosCliente[emailKey] && dadosCliente[emailKey].trim() !== '';
            
            console.log(`üîç [CORRE√á√ÉO 09] Contato ${i}:`, {
                nome: temNome ? dadosCliente[nomeKey] : 'vazio',
                cargo: temCargo ? dadosCliente[cargoKey] : 'vazio',
                telefone: temTelefone ? dadosCliente[telefoneKey] : 'vazio',
                email: temEmail ? dadosCliente[emailKey] : 'vazio'
            });
            
            // Se tem pelo menos um campo preenchido, mostrar o contato
            if (temNome || temCargo || temTelefone || temEmail) {
                var contatoElement = document.getElementById('contato_' + i);
                if (contatoElement) {
                    contatoElement.style.display = 'block';
                    console.log('‚úÖ [CORRE√á√ÉO 09] Contato', i, 'mostrado (tem dados)');
                    
                    // Aplicar formata√ß√£o telefone se necess√°rio
                    var phoneInput = contatoElement.querySelector('.phone-mask');
                    if (phoneInput && phoneInput.value && phoneInput.value.length > 0) {
                        formatPhone(phoneInput);
                        console.log('üîß [CORRE√á√ÉO 09] Telefone formatado no contato', i);
                    }
                } else {
                    console.warn('‚ö†Ô∏è [CORRE√á√ÉO 09] Elemento contato_' + i + ' n√£o encontrado');
                }
            } else {
                console.log('üìù [CORRE√á√ÉO 09] Contato', i, 'mantido oculto (sem dados)');
            }
        }
        {% else %}
        console.log('üìù [CORRE√á√ÉO 09] Novo cliente - apenas Contato 1 vis√≠vel');
        {% endif %}
    }
    
    // Executar ap√≥s um pequeno delay para garantir que DOM esteja totalmente carregado
    setTimeout(mostrarSociosComDados, 50);
    setTimeout(mostrarContatosComDados, 60);

    // Carregar dados dos s√≥cios e contatos se estiver editando
    {% if client %}
    console.log('üöÄ [IN√çCIO] CARREGANDO S√ìCIOS E CONTATOS EXISTENTES');
    const dadosCliente = {{ client|tojson }};
    console.log('üîç [IN√çCIO] DADOS DO CLIENTE RECEBIDOS:', dadosCliente);
    console.log('üîç [IN√çCIO] S√≥cio 2 nome:', dadosCliente.socio_2_nome);
    console.log('üîç [IN√çCIO] Contato 2 nome:', dadosCliente.contato_2_nome);
    
    // Delay para garantir que DOM esteja carregado
    setTimeout(function() {
        console.log('ÔøΩ EXECUTANDO carregarSocios...');
        carregarSocios(dadosCliente);
        
        console.log('üîç EXECUTANDO carregarContatos...');
        carregarContatos(dadosCliente);
    }, 1000);
    {% endif %}

    // For√ßar caixa alta nos inputs
    document.querySelectorAll('.upper-input').forEach(function(input) {
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });
    console.log('‚úÖ Inputs uppercase configurados');
    
    // CORRE√á√ÉO 07: Reaplicar formata√ß√£o CPF ap√≥s carregamento completo
    setTimeout(function() {
        reaplicarFormatacaoCPF();
        console.log('üîß [CORRE√á√ÉO 07] Formata√ß√£o CPF reaplicada ap√≥s carregamento completo');
    }, 2000);

    // Carregar dados dos s√≥cios e contatos se estiver editando
    {% if client %}
    console.log('üöÄ [IN√çCIO] CARREGANDO S√ìCIOS E CONTATOS EXISTENTES');
    const dadosCliente = {{ client|tojson }};
    console.log('üîç [IN√çCIO] DADOS DO CLIENTE RECEBIDOS:', dadosCliente);
    console.log('üîç [IN√çCIO] S√≥cio 2 nome:', dadosCliente.socio_2_nome);
    console.log('üîç [IN√çCIO] Contato 2 nome:', dadosCliente.contato_2_nome);
    
    // Delay para garantir que DOM esteja carregado
    setTimeout(function() {
        console.log('üîÑ EXECUTANDO carregarSocios...');
        carregarSocios(dadosCliente);
        
        console.log('üîç EXECUTANDO carregarContatos...');
        carregarContatos(dadosCliente);
    }, 1000);
    {% endif %}
});

// Fun√ß√£o para configurar controles dos s√≥cios
function configurarControleSocios() {
    console.log('üë• Configurando controles dos s√≥cios');
    
    // TESTE: Verificar se fun√ß√£o adicionarSocio est√° acess√≠vel
    console.log('üß™ TESTE: Fun√ß√£o adicionarSocio existe?', typeof adicionarSocio === 'function');
    console.log('üß™ TESTE: numeroSocios inicial:', numeroSocios);
    
    // Adicionar eventos para todos os radio buttons de representante legal existentes
    document.querySelectorAll('.representante-legal').forEach(function(radio) {
        radio.addEventListener('change', function() {
            if (this.checked) {
                console.log('‚úÖ Representante legal selecionado:', this.value);
            }
        });
    });
    
    console.log('‚úÖ Controles de s√≥cios configurados');
}

// Vari√°vel global para controlar o n√∫mero de s√≥cios
let numeroSocios = 1;

// Vari√°vel global para controlar o n√∫mero de contatos
let numeroContatos = 1;

    // üîç SISTEMA SIMPLIFICADO - Bot√£o com JavaScript inline
    console.log('‚úÖ Sistema b√°sico carregado');

// Fun√ß√£o para remover s√≥cio (CORRIGIDA)
    // ‚úÖ Sistema pronto para uso
    const container = document.getElementById('sociosContainer');
    if (!container) return;
    
    const sociosCards = container.querySelectorAll('[id^="socio_"]');
    numeroSocios = sociosCards.length;
    
    console.log(`üîÑ Numera√ß√£o atualizada - Total de s√≥cios: ${numeroSocios}`);
}

// FOCO NO PROBLEMA: QUADRO SOCIET√ÅRIO - VERS√ÉO ULTRA SIMPLES
function carregarSocios(dadosCliente) {
    console.log('üöÄ [CARREGAMENTO CORRIGIDO] CARREGANDO TODOS OS S√ìCIOS');
    console.log('üîç [DEBUG] dadosCliente recebido:', dadosCliente);
    
    if (!dadosCliente) {
        console.error('‚ùå ERRO: Dados do cliente n√£o fornecidos');
        return;
    }
    
    // Preencher e mostrar s√≥cios que t√™m dados (s√≥cios 1-5 apenas)
    for (let i = 1; i <= 5; i++) {
        const nome = dadosCliente[`socio_${i}_nome`];
        
        console.log(`üîç [DEBUG] Verificando s√≥cio ${i}: nome = "${nome}"`);
        
        if (nome && nome.trim() !== '') {
            console.log(`‚úÖ Carregando s√≥cio ${i}: ${nome}`);
            
            // Buscar o elemento do s√≥cio
            const socioElement = document.getElementById(`socio_${i}`);
            console.log(`üîç [DEBUG] Elemento socio_${i} encontrado:`, socioElement);
            
            if (socioElement) {
                // Mostrar o s√≥cio
                socioElement.style.display = 'block';
                console.log(`üëÄ [DEBUG] S√≥cio ${i} mostrado (display = block)`);
                
                // Preencher os campos
                const inputNome = socioElement.querySelector(`input[name="socio_${i}_nome"]`);
                const inputCpf = socioElement.querySelector(`input[name="socio_${i}_cpf"]`);
                const inputNasc = socioElement.querySelector(`input[name="socio_${i}_data_nascimento"]`);
                const inputPart = socioElement.querySelector(`input[name="socio_${i}_participacao"]`);
                const checkboxAdmin = socioElement.querySelector(`input[name="socio_${i}_administrador"]`);
                
                console.log(`üîç [DEBUG] Inputs encontrados para s√≥cio ${i}:`, {
                    nome: inputNome,
                    cpf: inputCpf,
                    nasc: inputNasc,
                    part: inputPart,
                    admin: checkboxAdmin
                });
                
                if (inputNome) {
                    inputNome.value = nome;
                    console.log(`‚úèÔ∏è [DEBUG] Nome preenchido: ${nome}`);
                }
                if (inputCpf) {
                    inputCpf.value = dadosCliente[`socio_${i}_cpf`] || '';
                    console.log(`‚úèÔ∏è [DEBUG] CPF preenchido: ${dadosCliente[`socio_${i}_cpf`] || 'vazio'}`);
                }
                if (inputNasc) {
                    inputNasc.value = dadosCliente[`socio_${i}_data_nascimento`] || '';
                    console.log(`‚úèÔ∏è [DEBUG] Data nasc preenchida: ${dadosCliente[`socio_${i}_data_nascimento`] || 'vazio'}`);
                }
                if (inputPart) {
                    inputPart.value = dadosCliente[`socio_${i}_participacao`] || '';
                    console.log(`‚úèÔ∏è [DEBUG] Participa√ß√£o preenchida: ${dadosCliente[`socio_${i}_participacao`] || 'vazio'}`);
                }
                if (checkboxAdmin) {
                    checkboxAdmin.checked = dadosCliente[`socio_${i}_administrador`] || false;
                    console.log(`‚úèÔ∏è [DEBUG] Admin checkbox: ${dadosCliente[`socio_${i}_administrador`] || false}`);
                }
                
                console.log(`‚úÖ S√≥cio ${i} carregado e mostrado: ${nome}`);
            } else {
                console.warn(`‚ö†Ô∏è Elemento socio_${i} n√£o encontrado no HTML`);
            }
        } else {
            console.log(`‚ûñ S√≥cio ${i} vazio, mantendo oculto`);
        }
    }
    
    console.log('‚úÖ [CARREGAMENTO CORRIGIDO] TODOS OS S√ìCIOS PROCESSADOS!');
    
    // CORRE√á√ÉO 07: Reaplicar formata√ß√£o CPF ap√≥s carregar s√≥cios
    setTimeout(function() {
        reaplicarFormatacaoCPF();
        console.log('üîß [CARREGAMENTO CORRIGIDO] Formata√ß√£o CPF reaplicada');
    }, 200);
}

function preencherFormularioSocio(numero, dadosSocio) {
    console.log(`üìù Preenchendo formul√°rio s√≥cio ${numero}:`, dadosSocio);
    
    // Preencher os campos
    const campos = {
        [`socio_${numero}_nome`]: dadosSocio.nome,
        [`socio_${numero}_cpf`]: dadosSocio.cpf,
        [`socio_${numero}_data_nascimento`]: dadosSocio.nascimento,
        [`socio_${numero}_participacao`]: dadosSocio.participacao
    };
    
    for (const [campo, valor] of Object.entries(campos)) {
        const input = document.querySelector(`input[name="${campo}"]`);
        if (input && valor) {
            input.value = valor;
            console.log(`‚úÖ Preenchido ${campo}: ${valor}`);
        }
    }
    
    // Checkboxes
    const adminCheckbox = document.querySelector(`input[name="socio_${numero}_administrador"]`);
    if (adminCheckbox) {
        adminCheckbox.checked = dadosSocio.admin;
    }
    
    const respLegalCheckbox = document.querySelector(`input[name="socio_${numero}_resp_legal"]`);
    if (respLegalCheckbox) {
        respLegalCheckbox.checked = dadosSocio.respLegal;
    }
}

function criarCardSocio(numero, dadosSocio) {
    const container = document.getElementById('socios-container');
    
    const cardHtml = `
    <div class="card socio-card mb-3" id="socio_${numero}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">S√≥cio ${numero}</h6>
            <button type="button" class="btn btn-danger btn-sm" onclick="removerSocio(${numero})">
                <i class="fas fa-trash"></i> Remover
            </button>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Nome do S√≥cio ${numero}:</label>
                    <input type="text" class="form-control upper-input" name="socio_${numero}_nome" value="${dadosSocio.nome}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">CPF do S√≥cio ${numero}:</label>
                    <input type="text" class="form-control" name="socio_${numero}_cpf" value="${dadosSocio.cpf}">
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-4">
                    <label class="form-label">Data de Nascimento:</label>
                    <input type="date" class="form-control" name="socio_${numero}_data_nascimento" value="${dadosSocio.nascimento}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Participa√ß√£o (%):</label>
                    <input type="text" class="form-control" name="socio_${numero}_participacao" value="${dadosSocio.participacao}">
                </div>
                <div class="col-md-4">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" name="socio_${numero}_administrador" ${dadosSocio.admin ? 'checked' : ''}>
                        <label class="form-check-label">Administrador</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="socio_${numero}_resp_legal" ${dadosSocio.respLegal ? 'checked' : ''}>
                        <label class="form-check-label">Respons√°vel Legal</label>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
    
    container.insertAdjacentHTML('beforeend', cardHtml);
    console.log(`‚úÖ Card do s√≥cio ${numero} criado e inserido`);
}
    if (!dadosCliente) {
        console.log('‚ùå Dados do cliente n√£o fornecidos');
function carregarContatos(dadosCliente) {
    console.log('üöÄ [CARREGAMENTO CORRIGIDO] CARREGANDO TODOS OS CONTATOS');
    console.log('üîç [DEBUG] dadosCliente recebido:', dadosCliente);
    
    if (!dadosCliente) {
        console.log('‚ùå Dados do cliente n√£o fornecidos');
        return;
    }
    
    // Preencher e mostrar contatos que t√™m dados (contatos 1-5)
    for (let i = 1; i <= 5; i++) {
        const nome = dadosCliente[`contato_${i}_nome`];
        
        console.log(`üîç [DEBUG] Verificando contato ${i}: nome = "${nome}"`);
        
        if (nome && nome.trim() !== '') {
            console.log(`‚úÖ Carregando contato ${i}: ${nome}`);
            
            // Buscar o elemento do contato
            const contatoElement = document.getElementById(`contato_${i}`);
            console.log(`üîç [DEBUG] Elemento contato_${i} encontrado:`, contatoElement);
            
            if (contatoElement) {
                // Mostrar o contato
                contatoElement.style.display = 'block';
                console.log(`üëÄ [DEBUG] Contato ${i} mostrado (display = block)`);
                
                // Preencher os campos
                const inputNome = contatoElement.querySelector(`input[name="contato_${i}_nome"]`);
                const inputCargo = contatoElement.querySelector(`input[name="contato_${i}_cargo"]`);
                const inputTelefone = contatoElement.querySelector(`input[name="contato_${i}_telefone"]`);
                const inputEmail = contatoElement.querySelector(`input[name="contato_${i}_email"]`);
                
                console.log(`üîç [DEBUG] Inputs encontrados para contato ${i}:`, {
                    nome: inputNome,
                    cargo: inputCargo,
                    telefone: inputTelefone,
                    email: inputEmail
                });
                
                if (inputNome) {
                    inputNome.value = nome;
                    console.log(`‚úèÔ∏è [DEBUG] Nome preenchido: ${nome}`);
                }
                if (inputCargo) {
                    inputCargo.value = dadosCliente[`contato_${i}_cargo`] || '';
                    console.log(`‚úèÔ∏è [DEBUG] Cargo preenchido: ${dadosCliente[`contato_${i}_cargo`] || 'vazio'}`);
                }
                if (inputTelefone) {
                    inputTelefone.value = dadosCliente[`contato_${i}_telefone`] || '';
                    console.log(`‚úèÔ∏è [DEBUG] Telefone preenchido: ${dadosCliente[`contato_${i}_telefone`] || 'vazio'}`);
                }
                if (inputEmail) {
                    inputEmail.value = dadosCliente[`contato_${i}_email`] || '';
                    console.log(`‚úèÔ∏è [DEBUG] Email preenchido: ${dadosCliente[`contato_${i}_email`] || 'vazio'}`);
                }
                
                console.log(`‚úÖ Contato ${i} carregado e mostrado: ${nome}`);
            } else {
                console.warn(`‚ö†Ô∏è Elemento contato_${i} n√£o encontrado no HTML`);
            }
        } else {
            console.log(`‚ûñ Contato ${i} vazio, mantendo oculto`);
        }
    }
    
    console.log('‚úÖ [CARREGAMENTO CORRIGIDO] TODOS OS CONTATOS PROCESSADOS!');
}

function preencherFormularioContato(numero, dadosContato) {
    console.log(`üìù Preenchendo formul√°rio contato ${numero}:`, dadosContato);
    
    // Preencher os campos
    const campos = {
        [`contato_${numero}_nome`]: dadosContato.nome,
        [`contato_${numero}_cargo`]: dadosContato.cargo,
        [`contato_${numero}_telefone`]: dadosContato.telefone,
        [`contato_${numero}_email`]: dadosContato.email
    };
    
    for (const [campo, valor] of Object.entries(campos)) {
        const input = document.querySelector(`input[name="${campo}"]`);
        if (input && valor) {
            input.value = valor;
            console.log(`‚úÖ Preenchido ${campo}: ${valor}`);
        }
    }
}

function criarCardContato(numero, dadosContato) {
    const container = document.getElementById('contatos-container');
    
    const cardHtml = `
    <div class="card contato-card mb-3" id="contato_${numero}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Contato ${numero}</h6>
            <button type="button" class="btn btn-danger btn-sm" onclick="removerContato(${numero})">
                <i class="fas fa-trash"></i> Remover
            </button>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Nome do Contato:</label>
                    <input type="text" class="form-control upper-input" name="contato_${numero}_nome" value="${dadosContato.nome}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Cargo:</label>
                    <input type="text" class="form-control upper-input" name="contato_${numero}_cargo" value="${dadosContato.cargo}">
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <label class="form-label">Telefone:</label>
                    <input type="text" class="form-control" name="contato_${numero}_telefone" value="${dadosContato.telefone}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email:</label>
                    <input type="email" class="form-control" name="contato_${numero}_email" value="${dadosContato.email}">
                </div>
            </div>
        </div>
    </div>`;
    
    container.insertAdjacentHTML('beforeend', cardHtml);
    console.log(`‚úÖ Card do contato ${numero} criado e inserido`);
}
    
    console.log('üîç Total de propriedades no dadosCliente:', Object.keys(dadosCliente).length);
    
    // Debug espec√≠fico: mostrar TODOS os campos de contatos que existem
    console.log('üîç =====DEBUG CAMPOS CONTATOS=====');
    for (let i = 1; i <= 10; i++) {
        const nome = dadosCliente[`contato_${i}_nome`];
        const cargo = dadosCliente[`contato_${i}_cargo`];
        const telefone = dadosCliente[`contato_${i}_telefone`];
        const email = dadosCliente[`contato_${i}_email`];
        console.log(`Contato ${i}: nome='${nome}', cargo='${cargo}', tel='${telefone}', email='${email}'`);
    }
    console.log('üîç =============================');
    
    // Primeiro, identificar quantos contatos existem
    let contatosEncontrados = [];
    for (let i = 1; i <= 10; i++) {
        const nome = dadosCliente[`contato_${i}_nome`];
        if (nome && nome.trim() !== '') {
            contatosEncontrados.push(i);
            console.log(`‚úÖ Contato ${i} encontrado: ${nome}`);
        }
    }
    
    console.log(`üîç Total de contatos encontrados: ${contatosEncontrados.length}`);
    console.log(`üîç Lista de contatos: [${contatosEncontrados.join(', ')}]`);
    
    // VERIFICA√á√ÉO CR√çTICA: Verificar se contatosContainer existe
    const contatosContainer = document.getElementById('contatosContainer');
    console.log('üîç VERIFICA√á√ÉO CR√çTICA: contatosContainer existe?', !!contatosContainer);
    
    if (!contatosContainer) {
        console.error('‚ùå ERRO CR√çTICO: contatosContainer N√ÉO existe! O JavaScript n√£o pode adicionar contatos.');
        console.log('üîç Elementos com ID que cont√©m "contato":', 
            Array.from(document.querySelectorAll('[id*="contato"]')).map(el => el.id));
        return; // Para a execu√ß√£o se n√£o encontrar o container
    }
    
    // Adicionar cards para todos os contatos que n√£o seja o primeiro (que j√° existe no HTML)
    console.log('üîß INICIANDO CRIA√á√ÉO DE CARDS DE CONTATOS...');
    contatosEncontrados.forEach(numeroContato => {
        if (numeroContato > 1) {
            console.log(`‚ûï Adicionando card para contato ${numeroContato}...`);
            
            // Verificar se o card j√° existe
            const cardExiste = document.getElementById(`contato_${numeroContato}`);
            console.log(`üîç Card do contato ${numeroContato} existe? ${!!cardExiste}`);
            
            if (!cardExiste) {
                console.log(`üìù Chamando adicionarContato() para criar card ${numeroContato}...`);
                console.log(`üîß Estado ANTES da chamada - numeroContatos: ${numeroContatos}`);
                adicionarContato(); // Adicionar card de contato
                console.log(`üîß Estado DEPOIS da chamada - numeroContatos: ${numeroContatos}`);
                
                // PROBLEMA: adicionarContato() incrementa numeroContatos, mas pode n√£o estar alinhado
                // com o numeroContato que precisamos. Vamos for√ßar o alinhamento:
                if (numeroContatos !== numeroContato) {
                    console.log(`‚ö†Ô∏è CORRE√á√ÉO: numeroContatos (${numeroContatos}) != numeroContato esperado (${numeroContato})`);
                    
                    // Renomear o card criado para o n√∫mero correto
                    const cardCriado = document.getElementById(`contato_${numeroContatos}`);
                    if (cardCriado) {
                        cardCriado.id = `contato_${numeroContato}`;
                        
                        // Renomear todos os campos dentro do card
                        const inputs = cardCriado.querySelectorAll('input');
                        inputs.forEach(input => {
                            if (input.name) {
                                input.name = input.name.replace(`_${numeroContatos}_`, `_${numeroContato}_`);
                            }
                            if (input.id) {
                                input.id = input.id.replace(`_${numeroContatos}`, `_${numeroContato}`);
                            }
                        });
                        
                        // Corrigir bot√£o de remo√ß√£o
                        const btnRemover = cardCriado.querySelector('button[onclick*="removerContato"]');
                        if (btnRemover) {
                            btnRemover.onclick = () => removerContato(numeroContato);
                        }
                        
                        console.log(`‚úÖ Card renomeado de contato_${numeroContatos} para contato_${numeroContato}`);
                    }
                }
                
                console.log(`‚úÖ Card adicionado para contato ${numeroContato}`);
            } else {
                console.log(`‚ÑπÔ∏è Card do contato ${numeroContato} j√° existe`);
            }
        }
    });
    
    // Aguardar um momento para que os elementos sejam criados no DOM
    console.log('‚è≥ Aguardando cria√ß√£o dos elementos de contatos no DOM...');
    setTimeout(() => {
        console.log('üîç Preenchendo dados dos contatos...');
        
        // Verificar estado do DOM ap√≥s timeout
        console.log('üîç Estado do DOM ap√≥s timeout:');
        for (let i = 1; i <= 10; i++) {
            const card = document.getElementById(`contato_${i}`);
            console.log(`   Card contato ${i}: ${!!card ? 'EXISTE' : 'N√ÉO EXISTE'}`);
        }
        
        // Preencher os campos de todos os contatos
        contatosEncontrados.forEach(numeroContato => {
            const nome = dadosCliente[`contato_${numeroContato}_nome`];
            console.log(`üîç Preenchendo contato ${numeroContato}: ${nome}`);
            
            // Preencher os campos
            const nomeInput = document.getElementById(`contato_${numeroContato}_nome`);
            const cargoInput = document.getElementById(`contato_${numeroContato}_cargo`);
            const telefoneInput = document.getElementById(`contato_${numeroContato}_telefone`);
            const emailInput = document.getElementById(`contato_${numeroContato}_email`);
            
            console.log(`üîç Elementos encontrados para contato ${numeroContato}:`, {
                nome: !!nomeInput,
                cargo: !!cargoInput,
                telefone: !!telefoneInput,
                email: !!emailInput
            });
            
            if (nomeInput) nomeInput.value = nome || '';
            if (cargoInput) cargoInput.value = dadosCliente[`contato_${numeroContato}_cargo`] || '';
            if (telefoneInput) telefoneInput.value = dadosCliente[`contato_${numeroContato}_telefone`] || '';
            if (emailInput) emailInput.value = dadosCliente[`contato_${numeroContato}_email`] || '';
            
            console.log(`‚úÖ Contato ${numeroContato} preenchido com sucesso`);
        });
        
        console.log('‚úÖ CARREGAR CONTATOS FINALIZADO');
    }, 500); // Delay aumentado para garantir que os elementos foram criados
}

// Fun√ß√£o para confirmar exclus√£o
function confirmDelete(clientId, clientName) {
    document.getElementById('clientName').textContent = clientName;
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

// Fun√ß√µes para gerenciar contatos
function adicionarContato() {
    console.log(`üîß [CORRE√á√ÉO 09] CONTATOS: Iniciando... numeroContatos atual: ${numeroContatos}`);
    
    // CORRE√á√ÉO 09: Primeiro verificar se h√° contatos est√°ticos ocultos (2-5)
    var contatosEstaticosOcultos = [];
    for (var i = 2; i <= 5; i++) {
        var contatoEstatico = document.getElementById('contato_' + i);
        if (contatoEstatico && contatoEstatico.style.display === 'none') {
            contatosEstaticosOcultos.push(i);
        }
    }
    
    if (contatosEstaticosOcultos.length > 0) {
        // Mostrar o primeiro contato oculto
        var proximoContato = contatosEstaticosOcultos[0];
        var contatoElement = document.getElementById('contato_' + proximoContato);
        contatoElement.style.display = 'block';
        console.log('‚úÖ [CORRE√á√ÉO 09] Contato', proximoContato, 'revelado (estava oculto)');
        
        // Aplicar m√°scara telefone ao contato revelado
        var phoneInput = contatoElement.querySelector('.phone-mask');
        if (phoneInput) {
            if (phoneInput.value && phoneInput.value.length > 0) {
                formatPhone(phoneInput);
                console.log('üîß [CORRE√á√ÉO 09] Telefone formatado no contato revelado:', phoneInput.value);
            }
        }
        
        // Focar no primeiro campo do contato revelado
        var firstInput = contatoElement.querySelector('input');
        if (firstInput) firstInput.focus();
        
        return; // Sair da fun√ß√£o - n√£o criar contato din√¢mico
    }
    
    // Se chegou aqui, todos os contatos est√°ticos (2-5) j√° est√£o vis√≠veis
    // Proceder com cria√ß√£o de contato din√¢mico (6+)
    console.log('üîß [CORRE√á√ÉO 09] Todos contatos est√°ticos vis√≠veis - criando din√¢mico');
    
    // VERIFICA√á√ÉO CR√çTICA: Container existe?
    const container = document.getElementById('contatosContainer');
    if (!container) {
        console.error('‚ùå ERRO CR√çTICO: contatosContainer n√£o encontrado na fun√ß√£o adicionarContato!');
        return false; // Para a fun√ß√£o
    }
    
    numeroContatos++;
    console.log(`üîß [CORRE√á√ÉO 09] CONTATOS: Incrementado para: ${numeroContatos}`);
    console.log(`üîß [CORRE√á√ÉO 09] CONTATOS: Container encontrado:`, !!container);
    
    try {
        const novoContato = document.createElement('div');
        novoContato.className = 'card border-light mb-2 contato-card';
        novoContato.id = `contato_${numeroContatos}`;
        console.log(`üîß [CORRE√á√ÉO 09] CONTATOS: Criando card din√¢mico com ID: contato_${numeroContatos}`);
    
    // Reutilizar a mesma vari√°vel novoContato
    novoContato.innerHTML = `
        <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-secondary">Contato ${numeroContatos}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerContato(${numeroContatos})" title="Remover contato">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="row align-items-center">
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Nome</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="contato_${numeroContatos}_nome" id="contato_${numeroContatos}_nome"
                           placeholder="Nome completo do contato">
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Cargo</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="contato_${numeroContatos}_cargo" id="contato_${numeroContatos}_cargo"
                           placeholder="Ex: Gerente, Diretor, S√≥cio">
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Telefone</label>
                    <input type="tel" class="form-control form-control-sm phone-mask" 
                           name="contato_${numeroContatos}_telefone" id="contato_${numeroContatos}_telefone"
                           placeholder="(85) 99999-9999">
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">E-mail</label>
                    <input type="email" class="form-control form-control-sm" 
                           name="contato_${numeroContatos}_email" id="contato_${numeroContatos}_email"
                           placeholder="contato@empresa.com">
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(novoContato);
    
    // Aplicar m√°scara ao novo campo de telefone
    const phoneInput = novoContato.querySelector('.phone-mask');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            formatPhone(this);
        });
    }
    
    console.log(`‚úÖ [CORRE√á√ÉO 09] CONTATOS: Card din√¢mico contato_${numeroContatos} criado e adicionado ao DOM`);
    
    // Verificar se o elemento foi realmente adicionado
    setTimeout(() => {
        const verificar = document.getElementById(`contato_${numeroContatos}`);
        console.log(`üîç [CORRE√á√ÉO 09] CONTATOS: Verifica√ß√£o ap√≥s 100ms - Card existe? ${!!verificar}`);
    }, 100);
    
    } catch (error) {
        console.error('‚ùå ERRO na fun√ß√£o adicionarContato:', error);
        return false;
    }
}

function removerContato(numero) {
    // N√£o permitir remover o primeiro contato
    if (numero === 1) {
        alert('O primeiro contato n√£o pode ser removido!');
        return;
    }
    
    const card = document.getElementById(`contato_${numero}`);
    if (card) {
        card.remove();
    }
}

// Fun√ß√£o para controlar habilita√ß√£o/desabilita√ß√£o dos campos de procura√ß√£o
function toggleProcuracaoData(checkboxId, dataInputId) {
    console.log('üîÑ toggleProcuracaoData chamada:', checkboxId, dataInputId);
    
    const checkbox = document.getElementById(checkboxId);
    const dataInput = document.getElementById(dataInputId);
    
    console.log('üì¶ Elementos encontrados:', {
        checkbox: checkbox ? 'SIM' : 'N√ÉO',
        dataInput: dataInput ? 'SIM' : 'N√ÉO',
        checkboxChecked: checkbox ? checkbox.checked : 'N/A'
    });
    
    if (checkbox && dataInput) {
        if (checkbox.checked) {
            dataInput.disabled = false;
            dataInput.focus();
            console.log('‚úÖ Campo habilitado:', dataInputId);
        } else {
            dataInput.disabled = true;
            dataInput.value = '';
            console.log('‚ùå Campo desabilitado:', dataInputId);
        }
    } else {
        console.error('‚ö†Ô∏è Elementos n√£o encontrados!', {checkboxId, dataInputId});
    }
}

// Fun√ß√£o para inicializar o estado dos campos de procura√ß√£o
function inicializarProcuracoes() {
    console.log('üöÄ Inicializando procura√ß√µes...');
    
    const procuracoes = [
        ['procReceita', 'dataProcReceita'],
        ['procDte', 'dataProcDte'],
        ['procCaixa', 'dataProcCaixa'],
        ['procEmpWeb', 'dataProcEmpWeb'],
        ['procDet', 'dataProcDet']
    ];
    
    procuracoes.forEach(function([checkboxId, dataInputId]) {
        const checkbox = document.getElementById(checkboxId);
        const dataInput = document.getElementById(dataInputId);
        
        console.log(`üîç Verificando ${checkboxId}:`, {
            checkbox: checkbox ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO',
            dataInput: dataInput ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO',
            checked: checkbox ? checkbox.checked : 'N/A'
        });
        
        if (checkbox && dataInput) {
            // Definir estado inicial baseado no checkbox
            dataInput.disabled = !checkbox.checked;
            console.log(`‚úÖ ${dataInputId} inicializado - disabled: ${dataInput.disabled}`);
        } else {
            console.error(`‚ùå Erro ao encontrar elementos para ${checkboxId}/${dataInputId}`);
        }
    });
    
    console.log('‚úÖ Inicializa√ß√£o de procura√ß√µes conclu√≠da');
}

// Fun√ß√£o para inicializar todas as valida√ß√µes de campos
function inicializarValidacaoCampos() {
    console.log('üîß Inicializando valida√ß√µes de campos...');
    
    const cpfCnpjInput = document.getElementById('cpfCnpj');
    const conditionalFields = document.querySelectorAll('.conditional-required');
    
    function updateRequiredFields() {
        // CORRE√á√ÉO: Verificar se o campo existe antes de us√°-lo
        if (!cpfCnpjInput) {
            console.log('‚ö†Ô∏è Campo CPF/CNPJ ainda n√£o dispon√≠vel');
            return;
        }
        
        const value = cpfCnpjInput.value.replace(/\D/g, '');
        const isCPF = value.length === 11;
        const isCNPJ = value.length === 14;
        
        console.log('üîÑ Atualizando campos obrigat√≥rios:', {
            value: value,
            length: value.length,
            isCPF: isCPF
        });
        
        // Se for CPF (11 d√≠gitos), s√≥ obrigar: Nome da Empresa, CPF, Estado, Cidade
        if (isCPF) {
            // Ocultar asteriscos condicionais
            conditionalFields.forEach(span => {
                span.style.display = 'none';
            });
            
            // Remover required dos campos condicionais
            ['razaoSocialReceita', 'nomeFantasiaReceita', 'inscEst', 'inscMun', 
             'segmento', 'atividade', 'regimeEstadual', 'regimeFederal'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.removeAttribute('required');
            });
            
            console.log('üë§ Modo CPF: campos opcionais configurados');
        } else if (isCNPJ) {
            // Se for CNPJ (14 d√≠gitos), todos os campos s√£o obrigat√≥rios
            conditionalFields.forEach(span => {
                span.style.display = 'inline';
            });
            
            // Adicionar required aos campos condicionais
            ['razaoSocialReceita', 'nomeFantasiaReceita', 'inscEst', 'inscMun', 
             'segmento', 'atividade', 'regimeEstadual', 'regimeFederal'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.setAttribute('required', 'required');
            });
            
            console.log('üè¢ Modo CNPJ: todos os campos obrigat√≥rios');
        } else {
            // Incompleto: manter sem obrigatoriedade extra e ocultar asteriscos
            conditionalFields.forEach(span => {
                span.style.display = 'none';
            });
            ['razaoSocialReceita', 'nomeFantasiaReceita', 'inscEst', 'inscMun', 
             'segmento', 'atividade', 'regimeEstadual', 'regimeFederal'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.removeAttribute('required');
            });
            console.log('‚è≥ CPF/CNPJ incompleto: requisitos condicionais desativados');
        }
    }
    
    // Executar ao carregar a p√°gina
    if (cpfCnpjInput) {
        updateRequiredFields();
        
        // CORRE√á√ÉO: Combinar ambas as funcionalidades em um √∫nico event listener
        cpfCnpjInput.addEventListener('input', function() {
            // 1. Atualizar campos obrigat√≥rios (fun√ß√£o original)
            updateRequiredFields();
            // 2. Atualizar CPF/CNPJ e Dom√©stica (nova funcionalidade)
            atualizarCpfCnpjEDomestica();
        });
        console.log('‚úÖ Event listener combinado do CPF/CNPJ adicionado');
    } else {
        console.error('‚ùå Campo CPF/CNPJ n√£o encontrado!');
    }
}

// Fun√ß√£o para validar formul√°rio antes do submit
function validarFormulario(form) {
    console.log('üîç Validando formul√°rio...');
    
    const cpfCnpjInput = document.getElementById('cpfCnpj');
    const nomeEmpresaInput = document.getElementById('nomeEmpresa');
    const estadoSelect = document.getElementById('estado');
    const cidadeSelect = document.getElementById('cidade');
    
    // Verificar se √© edi√ß√£o de cliente existente
    const clientIdInput = form.querySelector('input[name="id"]');
    const isEditing = clientIdInput && clientIdInput.value;
    
    console.log(`üîç Modo: ${isEditing ? 'Editando cliente existente' : 'Novo cliente'}`);
    
    let erros = [];
    
    // Para cliente existente, apenas valida√ß√µes b√°sicas
    if (isEditing) {
        // Permitir edi√ß√£o parcial - apenas validar se campos obrigat√≥rios est√£o preenchidos quando presentes
        if (nomeEmpresaInput && nomeEmpresaInput.value && !nomeEmpresaInput.value.trim()) {
            erros.push('Nome da Empresa n√£o pode estar vazio se preenchido');
            nomeEmpresaInput.classList.add('is-invalid');
        } else if (nomeEmpresaInput) {
            nomeEmpresaInput.classList.remove('is-invalid');
        }
        
        // Valida√ß√£o relaxada para CPF/CNPJ em edi√ß√£o
        if (cpfCnpjInput && cpfCnpjInput.value) {
            const cpfCnpjValue = cpfCnpjInput.value.replace(/\D/g, '');
            if (cpfCnpjValue.length !== 11 && cpfCnpjValue.length !== 14) {
                erros.push('CPF/CNPJ deve ter formato v√°lido se preenchido');
                cpfCnpjInput.classList.add('is-invalid');
            } else {
                cpfCnpjInput.classList.remove('is-invalid');
            }
        }
        
        console.log('‚úÖ Valida√ß√£o relaxada para edi√ß√£o - permitindo salvar');
        
        // Para edi√ß√£o, retornar verdadeiro se n√£o h√° erros cr√≠ticos
        if (erros.length === 0) {
            console.log('‚úÖ Formul√°rio validado com sucesso (modo edi√ß√£o)');
            return true;
        } else {
            console.log('‚ùå Erros em modo edi√ß√£o:', erros);
            // Mostrar alerta com os erros
            const mensagem = 'Por favor, corrija os seguintes erros:\n\n' + erros.join('\n');
            alert(mensagem);
            return false;
        }
        
    } else {
        // Valida√ß√µes rigorosas para novo cliente
        // Validar Nome da Empresa (sempre obrigat√≥rio)
        if (!nomeEmpresaInput.value.trim()) {
            erros.push('Nome da Empresa √© obrigat√≥rio');
            nomeEmpresaInput.classList.add('is-invalid');
            nomeEmpresaInput.classList.remove('is-valid');
        } else {
            nomeEmpresaInput.classList.remove('is-invalid');
            nomeEmpresaInput.classList.add('is-valid');
        }
        
        // Validar CPF/CNPJ (sempre obrigat√≥rio)
        const cpfCnpjValue = cpfCnpjInput.value.replace(/\D/g, '');
        if (!cpfCnpjValue || (cpfCnpjValue.length !== 11 && cpfCnpjValue.length !== 14)) {
            erros.push('CPF/CNPJ √© obrigat√≥rio e deve estar completo');
            cpfCnpjInput.classList.add('is-invalid');
            cpfCnpjInput.classList.remove('is-valid');
        } else {
            cpfCnpjInput.classList.remove('is-invalid');
            cpfCnpjInput.classList.add('is-valid');
        }
        
        // Validar Estado (sempre obrigat√≥rio)
        if (!estadoSelect.value) {
            erros.push('Estado √© obrigat√≥rio');
            estadoSelect.classList.add('is-invalid');
            estadoSelect.classList.remove('is-valid');
        } else {
            estadoSelect.classList.remove('is-invalid');
            estadoSelect.classList.add('is-valid');
        }
        
        // Validar Cidade (sempre obrigat√≥rio)
        if (!cidadeSelect.value) {
            erros.push('Cidade √© obrigat√≥ria');
            cidadeSelect.classList.add('is-invalid');
            cidadeSelect.classList.remove('is-valid');
        } else {
            cidadeSelect.classList.remove('is-invalid');
            cidadeSelect.classList.add('is-valid');
        }
        
        // Valida√ß√µes condicionais para CNPJ
        const isCNPJ = cpfCnpjValue.length === 14;
        if (isCNPJ) {
            const camposObrigatoriosCNPJ = [
                {id: 'razaoSocialReceita', nome: 'Raz√£o Social'},
                {id: 'nomeFantasiaReceita', nome: 'Nome Fantasia'},
                {id: 'inscEst', nome: 'Inscri√ß√£o Estadual'},
                {id: 'inscMun', nome: 'Inscri√ß√£o Municipal'},
                {id: 'segmento', nome: 'Segmento'},
                {id: 'atividade', nome: 'Atividade'},
                {id: 'regimeEstadual', nome: 'Regime Estadual'},
                {id: 'regimeFederal', nome: 'Regime Federal'}
            ];
            
            camposObrigatoriosCNPJ.forEach(campo => {
                const input = document.getElementById(campo.id);
                if (input && !input.value.trim()) {
                    erros.push(`${campo.nome} √© obrigat√≥rio para CNPJ`);
                    input.classList.add('is-invalid');
                } else if (input) {
                    input.classList.remove('is-invalid');
                }
            });
        }
    }
    
    if (erros.length > 0) {
        console.error('‚ùå Erros de valida√ß√£o:', erros);
        
        // Mostrar alerta com os erros
        const mensagem = 'Por favor, corrija os seguintes erros:\n\n' + erros.join('\n');
        alert(mensagem);
        
        // Rolar para o primeiro campo com erro
        const primeiroErro = form.querySelector('.is-invalid');
        if (primeiroErro) {
            primeiroErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
            primeiroErro.focus();
        }
        
        return false;
    }
    
    console.log('‚úÖ Formul√°rio validado com sucesso');
    return true;
}

// Fun√ß√£o para alternar a visibilidade das senhas
function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        button.title = 'Ocultar senha';
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        button.title = 'Mostrar senha';
    }
}

// === NOVOS SCRIPTS PARA LAYOUT E REGRAS ===

// CSS para caixa alta
const style = document.createElement('style');
style.textContent = `
    .upper-input { 
        text-transform: uppercase; 
        background-color: #f8f9fa;
        border: 1px solid #28a745;
    }
    .upper-input:focus { 
        background-color: #ffffff;
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    .conditional-required { display: none; }
`;
document.head.appendChild(style);

// === FUN√á√ÉO PARA MAI√öSCULAS OBRIGAT√ìRIAS ===
function setupUppercaseFields() {
    // Lista de campos que devem ficar sempre em mai√∫sculas
    const uppercaseFields = [
        'sistemaUtilizado'   // Sistema Utilizado
    ];
    
    // Configurar campos de input de texto
    uppercaseFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            // Adicionar classe CSS para mai√∫sculas
            field.classList.add('upper-input');
            
            // Event listener para converter em tempo real
            field.addEventListener('input', function(e) {
                const cursorPos = e.target.selectionStart;
                e.target.value = e.target.value.toUpperCase();
                e.target.setSelectionRange(cursorPos, cursorPos);
            });
        }
    });
    
    // Configurar campos select para mai√∫sculas obrigat√≥rias
    const selectFields = ['estado', 'regimeEstadual', 'regimeFederal'];
    selectFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            // Adicionar classe CSS para mai√∫sculas
            field.classList.add('upper-input');
            
            // Event listener para converter em tempo real (select options j√° v√™m em mai√∫sculas do HTML)
            field.addEventListener('change', function(e) {
                // Para selects, o value j√° vem correto do HTML, mas garantimos mai√∫scula
                if (e.target.value) {
                    e.target.value = e.target.value.toUpperCase();
                }
            });
        }
    });
}

// === FUN√á√ÉO PARA NOMES DE S√ìCIOS DIN√ÇMICOS ===
function setupSocioUppercase(socioNumber) {
    const nomeField = document.getElementById(`socio_${socioNumber}_nome`);
    if (nomeField) {
        nomeField.classList.add('upper-input');
        
        nomeField.addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            e.target.value = e.target.value.toUpperCase();
            e.target.setSelectionRange(cursorPos, cursorPos);
        });
        
        // Tamb√©m for√ßar mai√∫scula ao sair do campo
        nomeField.addEventListener('blur', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    }
}

// Executar configura√ß√£o quando p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    setupUppercaseFields();
    
    // Configurar campos existentes de s√≥cios (1-10)
    for (let i = 1; i <= 10; i++) {
        setupSocioUppercase(i);
    }
});

// Observador para novos s√≥cios adicionados dinamicamente
const sociosContainer = document.getElementById('sociosContainer');
if (sociosContainer) {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    // Procurar por campos de nome de s√≥cio no novo elemento
                    const nomeInputs = node.querySelectorAll('input[name*="_nome"]');
                    nomeInputs.forEach(input => {
                        input.classList.add('upper-input');
                        input.addEventListener('input', function(e) {
                            const cursorPos = e.target.selectionStart;
                            e.target.value = e.target.value.toUpperCase();
                            e.target.setSelectionRange(cursorPos, cursorPos);
                        });
                    });
                }
            });
        });
    });
    
    observer.observe(sociosContainer, {
        childList: true,
        subtree: true
    });
}

// CORRE√á√ÉO 14: NOVA FUN√á√ÉO SIMPLES PARA CONTATOS - SEM ALERTAS BLOQUEANTES
function carregarContatosSimples(dadosCliente) {
    console.log('üîß [CORRE√á√ÉO 14] CARREGANDO CONTATOS - VERS√ÉO SIMPLES (SEM ALERTAS)');
    
    if (!dadosCliente) {
        console.error('‚ùå ERRO: Dados do cliente n√£o fornecidos');
        return;
    }
    
    // FOR√áAR cria√ß√£o imediata dos cards
    setTimeout(() => {
        // Card 2
        if (dadosCliente.contato_2_nome) {
            adicionarContato();
            setTimeout(() => {
                const nome2 = document.querySelector('input[name="contato_2_nome"]');
                const cargo2 = document.querySelector('input[name="contato_2_cargo"]');
                const tel2 = document.querySelector('input[name="contato_2_telefone"]');
                const email2 = document.querySelector('input[name="contato_2_email"]');
                
                if (nome2) nome2.value = dadosCliente.contato_2_nome;
                if (cargo2) cargo2.value = dadosCliente.contato_2_cargo || '';
                if (tel2) tel2.value = dadosCliente.contato_2_telefone || '';
                if (email2) email2.value = dadosCliente.contato_2_email || '';
                
                console.log(`‚úÖ Contato 2 preenchido: ${dadosCliente.contato_2_nome}`);
            }, 100);
        }
        
        // Card 3
        if (dadosCliente.contato_3_nome) {
            setTimeout(() => {
                adicionarContato();
                setTimeout(() => {
                    const nome3 = document.querySelector('input[name="contato_3_nome"]');
                    const cargo3 = document.querySelector('input[name="contato_3_cargo"]');
                    const tel3 = document.querySelector('input[name="contato_3_telefone"]');
                    const email3 = document.querySelector('input[name="contato_3_email"]');
                    
                    if (nome3) nome3.value = dadosCliente.contato_3_nome;
                    if (cargo3) cargo3.value = dadosCliente.contato_3_cargo || '';
                    if (tel3) tel3.value = dadosCliente.contato_3_telefone || '';
                    if (email3) email3.value = dadosCliente.contato_3_email || '';
                    
                    console.log(`‚úÖ Contato 3 preenchido: ${dadosCliente.contato_3_nome}`);
                }, 100);
            }, 200);
        }
    }, 500);
    
    // Preencher primeiro contato (j√° existe)
    const nome1 = document.querySelector('input[name="contato_1_nome"]');
    const cargo1 = document.querySelector('input[name="contato_1_cargo"]');
    const tel1 = document.querySelector('input[name="contato_1_telefone"]');
    const email1 = document.querySelector('input[name="contato_1_email"]');
    
    if (nome1 && dadosCliente.contato_1_nome) {
        nome1.value = dadosCliente.contato_1_nome;
        if (cargo1) cargo1.value = dadosCliente.contato_1_cargo || '';
        if (tel1) tel1.value = dadosCliente.contato_1_telefone || '';
        if (email1) email1.value = dadosCliente.contato_1_email || '';
        console.log(`‚úÖ Contato 1 preenchido: ${dadosCliente.contato_1_nome}`);
    }
    
    console.log('‚úÖ [CORRE√á√ÉO 14] CONTATOS SIMPLES CARREGADOS!');
}

// ===== CARREGAMENTO FOR√áADO E DIRETO (MODO EDI√á√ÉO) =====
{% if client %}
console.log('üöÄ CARREGAMENTO FOR√áADO - CLIENTE DETECTADO');
const clienteData = {{ client|tojson }};
console.log('üìã Dados do cliente:', clienteData);

// Delay maior para garantir que tudo carregou
setTimeout(function() {
    console.log('üîÑ EXECUTANDO CARREGAMENTO FOR√áADO...');
    
    // Verificar se s√≥cio 2 tem dados
    if (clienteData.socio_2_nome) {
        console.log('‚úÖ S√≥cio 2 detectado:', clienteData.socio_2_nome);
        const socio2Element = document.getElementById('socio_2');
        if (socio2Element) {
            socio2Element.style.display = 'block';
            const nome2Input = socio2Element.querySelector('input[name="socio_2_nome"]');
            if (nome2Input) {
                nome2Input.value = clienteData.socio_2_nome;
                console.log('‚úÖ S√≥cio 2 carregado:', clienteData.socio_2_nome);
            }
        }
    }
    
    // Verificar se contato 2 tem dados
    if (clienteData.contato_2_nome) {
        console.log('‚úÖ Contato 2 detectado:', clienteData.contato_2_nome);
        const contato2Element = document.getElementById('contato_2');
        if (contato2Element) {
            contato2Element.style.display = 'block';
            const nomeContato2Input = contato2Element.querySelector('input[name="contato_2_nome"]');
            if (nomeContato2Input) {
                nomeContato2Input.value = clienteData.contato_2_nome;
                console.log('‚úÖ Contato 2 carregado:', clienteData.contato_2_nome);
            }
        }
    }
    
    // Verificar se contato 3 tem dados
    if (clienteData.contato_3_nome) {
        console.log('‚úÖ Contato 3 detectado:', clienteData.contato_3_nome);
        const contato3Element = document.getElementById('contato_3');
        if (contato3Element) {
            contato3Element.style.display = 'block';
            const nomeContato3Input = contato3Element.querySelector('input[name="contato_3_nome"]');
            if (nomeContato3Input) {
                nomeContato3Input.value = clienteData.contato_3_nome;
                console.log('‚úÖ Contato 3 carregado:', clienteData.contato_3_nome);
            }
        }
    }
    
    console.log('üèÅ CARREGAMENTO FOR√áADO CONCLU√çDO');
}, 2000);
{% endif %}

</script>
{% endblock %}