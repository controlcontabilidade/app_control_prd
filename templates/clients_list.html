{% extends "base.html" %}

{% block title %}Empresas – SiGEC{% endblock %}

{% block content %}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1>
                <i class="bi bi-building text-primary"></i>
                Lista de Empresas
            </h1>
            <p class="text-muted mb-0">Gerencie todos os seus clientes cadastrados</p>
        </div>
        <div class="col-md-4 text-end">
            {% if can_create() %}
            <a href="{{ url_for('new_client') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-2"></i>NOVO CLIENTE
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Barra de Busca e Filtros -->
<div class="card mt-3">
    <div class="card-header bg-white border-0 pb-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 fw-normal">
                <i class="bi bi-search me-2"></i>BUSCA E FILTROS
            </h6>
            <small class="text-muted" id="resultsCounter">
                {% if pagination %}
                    Mostrando {{ pagination.start_index }}-{{ pagination.end_index }} de {{ pagination.total }} empresas
                    {% if search_query %}(filtrados de "{{ search_query }}"){% endif %}
                {% elif clients %}
                    {{ clients|length }} EMPRESAS
                {% else %}
                    0 EMPRESAS
                {% endif %}
            </small>
        </div>
        
        <div class="row g-3">
            <div class="col-md-6">
                <label for="globalSearch" class="form-label small text-muted mb-1">
                    <i class="bi bi-search me-1"></i>BUSCA GLOBAL
                </label>
                <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           id="globalSearch" 
                           placeholder="Buscar por nome, CNPJ, cidade..." 
                           value="{{ search_query or '' }}"
                           autocomplete="off">
                    <button type="button" class="btn btn-outline-secondary" id="clearSearch" title="Limpar busca">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label for="perPageSelect" class="form-label small text-muted mb-1">
                    <i class="bi bi-list-ul me-1"></i>ITENS POR PÁGINA
                </label>
                <select class="form-select" id="perPageSelect">
                    <option value="10" {{ 'selected' if pagination and pagination.per_page == 10 else '' }}>10</option>
                    <option value="20" {{ 'selected' if pagination and pagination.per_page == 20 else '' }}>20</option>
                    <option value="50" {{ 'selected' if pagination and pagination.per_page == 50 else '' }}>50</option>
                    <option value="100" {{ 'selected' if pagination and pagination.per_page == 100 else '' }}>100</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label small text-muted mb-1">
                    <i class="bi bi-funnel me-1"></i>FILTRO DE STATUS
                </label>
                <select class="form-select" id="statusFilter">
                    <option value="ativo" {{ 'selected' if status_filter == 'ativo' else '' }}>Apenas Ativos</option>
                    <option value="inativo" {{ 'selected' if status_filter == 'inativo' else '' }}>Apenas Inativos</option>
                    <option value="todos" {{ 'selected' if status_filter == 'todos' else '' }}>Todos</option>
                </select>
            </div>
        </div>
    </div>
</div>

{% if clients %}
<!-- Tabela de Empresas -->
<div class="card mt-3">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="min-width: 180px;"><i class="bi bi-building me-1"></i>NOME DA EMPRESA</th>
                        <th style="min-width: 120px;"><i class="bi bi-file-text me-1"></i>CNPJ</th>
                        <th style="min-width: 90px;"><i class="bi bi-card-list me-1"></i>IE</th>
                        <th style="min-width: 90px;"><i class="bi bi-geo me-1"></i>IM</th>
                        <th style="min-width: 130px;"><i class="bi bi-percent me-1"></i>REGIME FEDERAL</th>
                        <th style="min-width: 110px;"><i class="bi bi-briefcase me-1"></i>SERVIÇOS</th>
                        <th style="min-width: 70px;"><i class="bi bi-person-badge me-1"></i>PERFIL</th>
                        <th style="min-width: 140px;"><i class="bi bi-gear me-1"></i>AÇÕES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients %}
                    <tr>
                        <td>
                            <strong class="text-primary">{{ client['nomeEmpresa'] or client['nomeFantasiaReceita'] or '-' }}</strong>
                        </td>
                        <td>
                            {% if client['cnpj'] %}
                                <code class="text-muted">{{ client['cnpj'] }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ client['inscEst'] or '-' }}</small>
                        </td>
                        <td>
                            <small class="text-muted">{{ client['inscMun'] or '-' }}</small>
                        </td>
                        <td>
                            <span class="badge {% if client['regimeFederal'] == 'SIMPLES_NACIONAL' or client['regimeFederal'] == 'SIMPLES' %}bg-success{% elif client['regimeFederal'] == 'LUCRO_PRESUMIDO' %}bg-warning{% elif client['regimeFederal'] == 'LUCRO_REAL' %}bg-danger{% elif client['regimeFederal'] == 'MEI' %}bg-info{% else %}bg-secondary{% endif %}">
                                {{ client['regimeFederal'] or 'N/D' }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-1 flex-wrap">
                                {% if client['ct'] %}
                                    <span class="badge bg-primary" title="Contábil">CT</span>
                                {% endif %}
                                {% if client['fs'] %}
                                    <span class="badge bg-secondary" title="Fiscal">FS</span>
                                {% endif %}
                                {% if client['dp'] %}
                                    <span class="badge bg-success" title="Pessoal">DP</span>
                                {% endif %}
                                {% if not client['ct'] and not client['fs'] and not client['dp'] %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge {% if client['perfilCliente'] == 'A' %}bg-success{% elif client['perfilCliente'] == 'B' %}bg-info{% elif client['perfilCliente'] == 'C' %}bg-warning{% elif client['perfilCliente'] == 'D' %}bg-danger{% else %}bg-secondary{% endif %}">
                                {{ client['perfilCliente'] or client['perfil'] or 'N/D' }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-1 flex-wrap">
                                <a href="{{ url_for('view_client', client_id=client['id']) }}" 
                                   class="btn btn-outline-primary btn-sm" 
                                   title="Ver detalhes">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if can_edit() %}
                                <a href="{{ url_for('edit_client', client_id=client['id']) }}" 
                                   class="btn btn-outline-secondary btn-sm" 
                                   title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {% endif %}
                                <a href="{{ url_for('view_client_meetings', client_id=client['id']) }}" 
                                   class="btn btn-outline-success btn-sm" 
                                   title="Ver Atas">
                                    <i class="bi bi-file-earmark-text"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginação -->
        {% if pagination and pagination.total_pages > 1 %}
        <div class="card-footer bg-light border-0 py-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted">
                        Página {{ pagination.page }} de {{ pagination.total_pages }}
                    </small>
                    <div class="btn-group ms-3" role="group">
                        {% if pagination.has_prev %}
                            <a href="{{ url_for('clients', page=1, per_page=pagination.per_page, status=status_filter, search=search_query) }}" 
                               class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                            <a href="{{ url_for('clients', page=pagination.prev_num, per_page=pagination.per_page, status=status_filter, search=search_query) }}" 
                               class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        {% else %}
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="bi bi-chevron-double-left"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        {% endif %}
                        
                        {% if pagination.has_next %}
                            <a href="{{ url_for('clients', page=pagination.next_num, per_page=pagination.per_page, status=status_filter, search=search_query) }}" 
                               class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                            <a href="{{ url_for('clients', page=pagination.total_pages, per_page=pagination.per_page, status=status_filter, search=search_query) }}" 
                               class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        {% else %}
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="bi bi-chevron-double-right"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted me-2">Ir para página:</small>
                    <div class="input-group d-inline-flex" style="width: 120px;">
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="pageJump" 
                               min="1" 
                               max="{{ pagination.total_pages }}" 
                               value="{{ pagination.page }}">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="goToPage">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% else %}
<!-- Estado vazio -->
<div class="card mt-3">
    <div class="card-body text-center py-5">
        <i class="bi bi-search display-1 text-muted mb-3"></i>
        <h4 class="text-muted">Nenhuma empresa encontrada</h4>
        <p class="text-muted mb-4">
            {% if search_query %}
                Não foram encontradas empresas que correspondam à busca "<strong>{{ search_query }}</strong>".
            {% else %}
                Não há empresas cadastradas no sistema ainda.
            {% endif %}
        </p>
        {% if search_query %}
            <button type="button" class="btn btn-outline-secondary me-2" onclick="clearSearchAndReload()">
                <i class="bi bi-arrow-clockwise"></i>
                LIMPAR BUSCA
            </button>
        {% endif %}
        {% if can_create() %}
        <a href="{{ url_for('new_client') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i>
            CADASTRAR NOVA EMPRESA
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const globalSearch = document.getElementById('globalSearch');
    const statusFilter = document.getElementById('statusFilter');
    const perPageSelect = document.getElementById('perPageSelect');
    const clearSearchBtn = document.getElementById('clearSearch');
    const goToPageBtn = document.getElementById('goToPage');
    const pageJumpInput = document.getElementById('pageJump');
    
    let searchTimeout;
    
    if (globalSearch) {
        globalSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 500);
        });
        
        globalSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                performSearch();
            }
        });
    }
    
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            globalSearch.value = '';
            performSearch();
        });
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', performSearch);
    }
    
    if (perPageSelect) {
        perPageSelect.addEventListener('change', performSearch);
    }
    
    if (goToPageBtn) {
        goToPageBtn.addEventListener('click', function() {
            const page = parseInt(pageJumpInput.value);
            if (page && page > 0) {
                updateUrl({ page: page });
            }
        });
    }
    
    function performSearch() {
        const searchQuery = globalSearch ? globalSearch.value.trim() : '';
        const status = statusFilter ? statusFilter.value : 'ativo';
        const perPage = perPageSelect ? perPageSelect.value : '100';
        
        updateUrl({
            search: searchQuery,
            status: status,
            per_page: perPage,
            page: 1
        });
    }
    
    function updateUrl(params) {
        const url = new URL(window.location);
        url.searchParams.delete('search');
        url.searchParams.delete('status');
        url.searchParams.delete('per_page');
        url.searchParams.delete('page');
        
        if (params.search && params.search.trim()) {
            url.searchParams.set('search', params.search.trim());
        }
        if (params.status) {
            url.searchParams.set('status', params.status);
        }
        if (params.per_page) {
            url.searchParams.set('per_page', params.per_page);
        }
        if (params.page) {
            url.searchParams.set('page', params.page);
        }
        
        window.location.href = url.toString();
    }
    
    window.clearSearchAndReload = function() {
        const url = new URL(window.location);
        url.searchParams.delete('search');
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    };
});
</script>
{% endblock %}
