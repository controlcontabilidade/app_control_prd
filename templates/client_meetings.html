{% extends "base.html" %}

{% block title %}Atas de {{ client.nomeEmpresa }} - SIGEC{% endblock %}

{% block content %}
<!-- Header da p√°gina -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1>
                <i class="bi bi-file-earmark-text text-primary"></i>
                Atas de Reuni√£o
            </h1>
            <p class="mb-0">
                Cliente: <strong>{{ client.nomeFantasiaReceita or client.nomeEmpresa }}</strong>
                {% if client.cnpj %} - CNPJ: {{ client.cnpj }}{% endif %}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('register_meeting', client_id=client.id) }}" class="btn btn-success me-2">
                <i class="bi bi-plus-circle"></i>
                Registrar Ata de Reuni√£o
            </a>
            <a href="/" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i>
                Voltar ao Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Estat√≠sticas do cliente -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-0" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
            <div class="card-body text-center">
                <i class="bi bi-file-earmark-text display-6 mb-2" style="color: var(--control-primary);"></i>
                <h3 class="mb-1" style="color: var(--control-primary);">{{ meetings|length }}</h3>
                <small class="text-muted">Total de Atas</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
            <div class="card-body text-center">
                <i class="bi bi-calendar-event display-6 text-success mb-2"></i>
                <h3 class="text-success mb-1">
                    {% if meetings %}
                        {{ meetings[0].date if meetings else '-' }}
                    {% else %}
                        -
                    {% endif %}
                </h3>
                <small class="text-muted">√öltima Reuni√£o</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0" style="background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);">
            <div class="card-body text-center">
                <i class="bi bi-clock-history display-6 mb-2" style="color: var(--control-secondary);"></i>
                <h3 class="mb-1" style="color: var(--control-secondary);">
                    {% if meetings %}
                        {{ ((meetings|length) / 12) | round(1) }}
                    {% else %}
                        0
                    {% endif %}
                </h3>
                <small class="text-muted">Atas/Ano</small>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Atas do Cliente -->
{% if meetings %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>
            Hist√≥rico de Reuni√µes
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Hor√°rio</th>
                        <th>Participantes</th>
                        <th>Conte√∫do da Reuni√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for meeting in meetings %}
                    <tr>
                        <td>
                            {% if meeting.date %}
                                <strong>{{ meeting.date }}</strong>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if meeting.time %}
                                {{ meeting.time }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;">
                                {{ meeting.participants[:50] }}{% if meeting.participants|length > 50 %}...{% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 300px;">
                                {{ meeting.topics[:80] }}{% if meeting.topics|length > 80 %}...{% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                <button type="button" 
                                        class="btn btn-outline-primary btn-sm view-meeting-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#meetingDetailsModal"
                                        data-meeting-id="{{ meeting.id }}"
                                        data-meeting-date="{{ meeting.date or '' }}"
                                        data-meeting-time="{{ meeting.time or '' }}"
                                        data-meeting-participants="{{ meeting.participants or '' }}"
                                        data-meeting-topics="{{ meeting.topics or '' }}"
                                        data-meeting-topics-formatted="{{ meeting.topics_formatted or meeting.topics or '' }}"
                                        data-meeting-created-date="{{ meeting.created_date or '' }}"
                                        data-meeting-created-time="{{ meeting.created_time or '' }}"
                                        data-meeting-created-by="{{ meeting.created_by or '' }}"
                                        data-meeting-updated-date="{{ meeting.updated_date or '' }}"
                                        data-meeting-updated-time="{{ meeting.updated_time or '' }}"
                                        data-meeting-updated-by="{{ meeting.updated_by or '' }}"
                                        title="Ver detalhes completos">
                                    <i class="bi bi-eye"></i>
                                </button>
                                {% if session.user_perfil and session.user_perfil.lower() == 'administrador' %}
                                <button type="button" 
                                        class="btn btn-outline-warning btn-sm" 
                                        onclick="editClientMeeting('{{ meeting.id }}', '{{ client.id }}')"
                                        title="Editar ata">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" 
                                        class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteClientMeeting('{{ meeting.id }}', '{{ client.nomeEmpresa or client.nomeFantasiaReceita }}')"
                                        title="Excluir ata">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para visualizar detalhes da ata -->
<div class="modal fade" id="meetingDetailsModal" tabindex="-1" aria-labelledby="meetingDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="meetingDetailsModalLabel">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    Detalhes da Ata de Reuni√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informa√ß√µes da Reuni√£o -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">üìÖ Data da Reuni√£o</h6>
                        <p id="modalDate" class="mb-0">-</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">üïê Hor√°rio</h6>
                        <p id="modalTime" class="mb-0">-</p>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="text-muted mb-2">üë• Participantes</h6>
                    <p id="modalParticipants" class="mb-0">-</p>
                </div>

                <div class="mb-4">
                    <h6 class="text-muted mb-2">üí≠ Conte√∫do da Reuni√£o</h6>
                    <div id="modalTopics" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">-</div>
                </div>

                <!-- Informa√ß√µes de Auditoria -->
                <hr>
                <h6 class="text-muted mb-3">üîç Informa√ß√µes de Registro</h6>
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <strong>Registrado em:</strong><br>
                            <span id="modalCreatedDate">-</span> √†s <span id="modalCreatedTime">-</span><br>
                            <strong>Por:</strong> <span id="modalCreatedBy">-</span>
                        </small>
                    </div>
                    <div class="col-md-6" id="modalUpdatedInfo" style="display: none;">
                        <small class="text-muted">
                            <strong>√öltima atualiza√ß√£o:</strong><br>
                            <span id="modalUpdatedDate">-</span> √†s <span id="modalUpdatedTime">-</span><br>
                            <strong>Por:</strong> <span id="modalUpdatedBy">-</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Estado vazio -->
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-file-earmark-text display-1 text-muted mb-3"></i>
        <h4 class="text-muted mb-3">Nenhuma ata de reuni√£o encontrada</h4>
        <p class="text-muted mb-4">
            Este cliente ainda n√£o possui atas de reuni√£o registradas.<br>
            Comece registrando a primeira reuni√£o.
        </p>
        <a href="{{ url_for('register_meeting', client_id=client.id) }}" class="btn btn-success">
            <i class="bi bi-plus-circle me-1"></i>
            Registrar Primeira Ata
        </a>
    </div>
</div>
{% endif %}

<script>
// Adicionar event listeners para os bot√µes de visualiza√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    const viewButtons = document.querySelectorAll('.view-meeting-btn');
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const meetingData = {
                id: this.dataset.meetingId,
                date: this.dataset.meetingDate,
                time: this.dataset.meetingTime,
                participants: this.dataset.meetingParticipants,
                topics: this.dataset.meetingTopics,
                topics_formatted: this.dataset.meetingTopicsFormatted,
                created_date: this.dataset.meetingCreatedDate,
                created_time: this.dataset.meetingCreatedTime,
                created_by: this.dataset.meetingCreatedBy,
                updated_date: this.dataset.meetingUpdatedDate,
                updated_time: this.dataset.meetingUpdatedTime,
                updated_by: this.dataset.meetingUpdatedBy
            };
            
            viewMeetingDetails(meetingData);
        });
    });
});

function viewMeetingDetails(meetingData) {
    // Debug: logar os dados recebidos
    console.log('Meeting Data:', meetingData);
    
    // Popula informa√ß√µes da reuni√£o
    document.getElementById('modalDate').textContent = meetingData.date || '-';
    document.getElementById('modalTime').textContent = meetingData.time || '-';
    document.getElementById('modalParticipants').textContent = meetingData.participants || '-';
    
    // Popula conte√∫do da reuni√£o com formata√ß√£o preservada
    const topicsElement = document.getElementById('modalTopics');
    const formattedContent = meetingData.topics_formatted || meetingData.topics;
    
    if (formattedContent && formattedContent.trim() !== '') {
        // Usar o conte√∫do formatado original (HTML)
        topicsElement.innerHTML = formattedContent;
    } else {
        topicsElement.textContent = 'Nenhum conte√∫do registrado';
    }
    
    // Popula informa√ß√µes de auditoria
    document.getElementById('modalCreatedDate').textContent = meetingData.created_date || '-';
    document.getElementById('modalCreatedTime').textContent = meetingData.created_time || '-';
    document.getElementById('modalCreatedBy').textContent = meetingData.created_by || '-';
    
    // Mostra informa√ß√µes de atualiza√ß√£o se existirem
    const updatedInfo = document.getElementById('modalUpdatedInfo');
    if (meetingData.updated_date && meetingData.updated_date.trim() !== '') {
        document.getElementById('modalUpdatedDate').textContent = meetingData.updated_date;
        document.getElementById('modalUpdatedTime').textContent = meetingData.updated_time || '-';
        document.getElementById('modalUpdatedBy').textContent = meetingData.updated_by || '-';
        updatedInfo.style.display = 'block';
    } else {
        updatedInfo.style.display = 'none';
    }
}

// Fun√ß√£o para editar ata do cliente
function editClientMeeting(meetingId, clientId) {
    // Redireciona para uma p√°gina de edi√ß√£o (a ser criada)
    window.location.href = `/client/${clientId}/meeting/${meetingId}/edit`;
}

// Fun√ß√£o para excluir ata do cliente
function deleteClientMeeting(meetingId, clientName) {
    if (confirm(`Tem certeza que deseja excluir esta ata de reuni√£o do cliente "${clientName}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        // Envia requisi√ß√£o de exclus√£o
        fetch(`/meeting/${meetingId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Recarrega a p√°gina para atualizar a lista
                location.reload();
            } else {
                alert('Erro ao excluir ata: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir ata. Tente novamente.');
        });
    }
}
</script>

{% endblock %}
