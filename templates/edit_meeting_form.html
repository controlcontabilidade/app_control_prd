{% extends "base.html" %}

{% block title %}Editar Ata de Reunião - {{ client.nomeEmpresa }} - SIGEC{% endblock %}

{% block content %}
<!-- Header da página -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1>
                <i class="bi bi-pencil-square text-warning"></i>
                Editar Ata de Reunião
            </h1>
            <p class="mb-0">
                Cliente: <strong>{{ client.nomeFantasiaReceita or client.nomeEmpresa }}</strong>
                {% if client.cnpj %} - CNPJ: {{ client.cnpj }}{% endif %}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('view_client_meetings', client_id=client.id) }}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-list-ul"></i>
                Ver Todas as Atas
            </a>
            <a href="/" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i>
                Voltar ao Dashboard
            </a>
        </div>
    </div>
</div>

<form method="POST" action="{{ url_for('update_meeting', client_id=client.id, meeting_id=meeting.id) }}" class="needs-validation" novalidate>
    <input type="hidden" name="client_name" value="{{ client.nomeFantasiaReceita or client.nomeEmpresa }}">
    
    <!-- Informações da Reunião -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-calendar-event me-2 text-primary"></i>
                Dados da Reunião
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="meeting_date" class="form-label">
                        <i class="bi bi-calendar me-1"></i>Data da Reunião *
                    </label>
                    <div class="input-group position-relative">
                        <input type="text" class="form-control" id="meeting_date" name="meeting_date" 
                               placeholder="DD/MM/AAAA" maxlength="10" required value="{{ meeting.date or '' }}">
                        <button class="btn btn-outline-secondary" type="button" id="calendar-btn" 
                                data-bs-toggle="tooltip" title="Selecionar data">
                            <i class="bi bi-calendar-date"></i>
                        </button>
                        <input type="date" id="date-picker" style="position: absolute; top: 100%; right: 0; opacity: 0; pointer-events: none; z-index: 1000;">
                    </div>
                    <div class="invalid-feedback">
                        Por favor, informe a data da reunião no formato DD/MM/AAAA.
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="meeting_time" class="form-label">
                        <i class="bi bi-clock me-1"></i>Horário *
                    </label>
                    <input type="time" class="form-control" id="meeting_time" name="meeting_time" required value="{{ meeting.time or '' }}">
                    <div class="form-text">Horário que foi realizada a reunião</div>
                    <div class="invalid-feedback">
                        Por favor, informe o horário da reunião.
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="participants" class="form-label">
                        <i class="bi bi-people me-1"></i>Participantes *
                    </label>
                    <textarea class="form-control" id="participants" name="participants" rows="2" 
                              placeholder="Liste todos os participantes da reunião..." required>{{ meeting.participants or '' }}</textarea>
                    <div class="invalid-feedback">
                        Por favor, informe os participantes da reunião.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conteúdo da Reunião -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-chat-dots me-2 text-info"></i>
                Conteúdo da Reunião
            </h5>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <label for="topics" class="form-label">
                    <i class="bi bi-chat-dots me-1"></i>Conteúdo da Reunião *
                </label>
                <div class="form-text mb-2">
                    Descreva os principais tópicos e assuntos discutidos na reunião...
                </div>
                
                <!-- Toolbar de formatação -->
                <div class="border rounded-top p-2 bg-light">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="Negrito">
                                <i class="bi bi-type-bold"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="Itálico">
                                <i class="bi bi-type-italic"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="Sublinhado">
                                <i class="bi bi-type-underline"></i>
                            </button>
                        </div>
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyLeft')" title="Alinhar à esquerda">
                                <i class="bi bi-text-left"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyCenter')" title="Centralizar">
                                <i class="bi bi-text-center"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyRight')" title="Alinhar à direita">
                                <i class="bi bi-text-right"></i>
                            </button>
                        </div>
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertOrderedList')" title="Lista numerada">
                                <i class="bi bi-list-ol"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Lista com marcadores">
                                <i class="bi bi-list-ul"></i>
                            </button>
                        </div>
                        <div class="btn-group" role="group">
                            <input type="color" id="textColor" class="btn btn-sm" onchange="formatColor(this.value)" title="Cor do texto" style="width: 40px; height: 31px;">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('removeFormat')" title="Remover formatação">
                                <i class="bi bi-eraser"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Editor contenteditable -->
                <div id="editor" contenteditable="true" 
                     class="form-control border-top-0 rounded-bottom" 
                     style="min-height: 300px; max-height: 500px; overflow-y: auto;"
                     placeholder="Descreva os principais tópicos e assuntos discutidos na reunião..."></div>
                
                <!-- Campo oculto para armazenar o conteúdo formatado -->
                <textarea id="topics" name="topics" style="display: none;" required></textarea>
                
                <!-- Script JSON com conteúdo formatado -->
                <script type="application/json" id="meeting-formatted-content">
                  {% if meeting.topics_formatted -%}
                  {{ meeting.topics_formatted|tojson|safe }}
                  {%- elif meeting.topics -%}
                  {{ meeting.topics|tojson|safe }}
                  {%- else -%}
                  ""
                  {%- endif %}
                </script>
                
                <div id="topics-feedback" class="invalid-feedback">
                    Por favor, descreva o conteúdo da reunião.
                </div>
            </div>
        </div>
    </div>

    <!-- Botões de ação -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Todos os campos marcados com (*) são obrigatórios
                    </small>
                </div>
                <div>
                    <a href="{{ url_for('view_client_meetings', client_id=client.id) }}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle me-1"></i>Atualizar Ata
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// Funções de formatação de texto
function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('editor').focus();
    updateHiddenField();
}

function formatColor(color) {
    document.execCommand('foreColor', false, color);
    document.getElementById('editor').focus();
    updateHiddenField();
}

function updateHiddenField() {
    const editorContent = document.getElementById('editor').innerHTML;
    document.getElementById('topics').value = editorContent;
}

// Função para formatar data para formato brasileiro
function formatDateToBR(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString + 'T00:00:00');
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// Função para converter data BR para formato ISO
function formatDateToISO(dateString) {
    if (!dateString) return '';
    const parts = dateString.split('/');
    if (parts.length === 3) {
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
    return '';
}

document.addEventListener('DOMContentLoaded', function() {
    // Configurar editor
    const editor = document.getElementById('editor');
    const topicsField = document.getElementById('topics');
    
    // Carregar conteúdo formatado no editor
    const contentScript = document.getElementById('meeting-formatted-content');
    if (contentScript) {
        try {
            console.log('🔍 Script JSON encontrado');
            console.log('📝 Conteúdo bruto do script:', contentScript.textContent.substring(0, 200) + '...');
            
            const formattedContent = JSON.parse(contentScript.textContent);
            console.log('📋 Conteúdo após JSON.parse:', formattedContent ? formattedContent.substring(0, 200) + '...' : 'VAZIO');
            
            if (formattedContent && formattedContent.trim() !== '') {
                editor.innerHTML = formattedContent;
                topicsField.value = formattedContent;
                console.log('✅ Conteúdo formatado carregado no editor');
                console.log('📏 Tamanho do conteúdo:', formattedContent.length, 'caracteres');
            } else {
                console.warn('⚠️ Conteúdo formatado está vazio');
            }
        } catch (e) {
            console.error('❌ Erro ao carregar conteúdo formatado:', e);
            console.error('📝 Conteúdo que causou erro:', contentScript.textContent);
        }
    } else {
        console.error('❌ Script JSON não encontrado');
    }
    
    // Atualizar campo oculto quando o editor perde o foco
    editor.addEventListener('blur', updateHiddenField);
    editor.addEventListener('input', updateHiddenField);
    
    // Botão do calendário
    document.getElementById('calendar-btn').addEventListener('click', function() {
        const textInput = document.getElementById('meeting_date');
        const dateInput = document.getElementById('date-picker');
        
        // Converter data atual para formato ISO se existir
        const currentDate = textInput.value;
        if (currentDate) {
            dateInput.value = formatDateToISO(currentDate);
        }
        
        dateInput.click();
    });

    // Quando uma data é selecionada no picker
    document.getElementById('date-picker').addEventListener('change', function() {
        const textInput = document.getElementById('meeting_date');
        textInput.value = formatDateToBR(this.value);
        textInput.focus();
    });
    
    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Validação Bootstrap
    var forms = document.querySelectorAll('.needs-validation');
    
    Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            // Atualizar campo oculto antes da validação
            updateHiddenField();
            
            // Validar formato da data
            const dateInput = document.getElementById('meeting_date');
            const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = dateInput.value.match(datePattern);
            
            if (!match) {
                dateInput.setCustomValidity('Data deve estar no formato DD/MM/AAAA');
            } else {
                const day = parseInt(match[1]);
                const month = parseInt(match[2]);
                const year = parseInt(match[3]);
                
                if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900) {
                    dateInput.setCustomValidity('Data inválida');
                } else {
                    dateInput.setCustomValidity('');
                }
            }
            
            // Validar se o conteúdo da reunião foi preenchido
            const editorContent = document.getElementById('editor').innerHTML;
            const topicsInput = document.getElementById('topics');
            const feedbackDiv = document.getElementById('topics-feedback');
            const editorDiv = document.getElementById('editor');
            
            // Verifica se o conteúdo está vazio
            const textContent = editorDiv.innerText.trim();
            
            if (!textContent || textContent === '' || editorContent === '<br>' || editorContent === '') {
                // Mostra erro visual
                editorDiv.style.borderColor = '#dc3545';
                feedbackDiv.style.display = 'block';
                feedbackDiv.style.color = '#dc3545';
                topicsInput.setCustomValidity('Por favor, descreva o conteúdo da reunião.');
            } else {
                // Remove erro visual
                editorDiv.style.borderColor = '#ced4da';
                feedbackDiv.style.display = 'none';
                topicsInput.setCustomValidity('');
            }
            
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
        }, false);
    });
});
</script>



{% endblock %}