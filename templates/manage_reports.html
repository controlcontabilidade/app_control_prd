{% extends "base.html" %}

{% block title %}Gerenciar Relatórios{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="bi bi-graph-up me-2"></i>Gerenciar Relatórios
                    </h1>
                    <p class="text-muted mb-0">Configure e gerencie os relatórios Power BI disponíveis</p>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createReportModal">
                    <i class="bi bi-plus-circle me-2"></i>Novo Relatório
                </button>
            </div>

            <!-- Filtros e Busca -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="bi bi-search text-muted"></i>
                                </span>
                                <input type="text" 
                                       class="form-control border-start-0" 
                                       id="searchInput" 
                                       placeholder="Buscar relatórios por nome ou descrição...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">Todos os Status</option>
                                <option value="ativo">Somente Ativos</option>
                                <option value="inativo">Somente Inativos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="text-muted">
                                <i class="bi bi-bar-chart me-1"></i>
                                Total: <span id="totalReports">{{ reports|length }}</span> relatórios
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Relatórios -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    {% if reports %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="reportsTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 py-3">Nome</th>
                                    <th class="border-0 py-3">Descrição</th>
                                    <th class="border-0 py-3">Status</th>
                                    <th class="border-0 py-3">Ordem</th>
                                    <th class="border-0 py-3">Criado Por</th>
                                    <th class="border-0 py-3">Data</th>
                                    <th class="border-0 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for report in reports %}
                                <tr class="report-row">
                                    <td class="py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="report-icon-sm me-3">
                                                <i class="bi bi-bar-chart"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">{{ report.nome }}</h6>
                                                <small class="text-muted">ID: {{ report.id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-3">
                                        <span class="text-muted">
                                            {{ (report.descricao[:60] + '...') if report.descricao and report.descricao|length > 60 else (report.descricao or 'Sem descrição') }}
                                        </span>
                                    </td>
                                    <td class="py-3">
                                        {% if report.ativo %}
                                        <span class="badge bg-success-subtle text-success border border-success-subtle">
                                            <i class="bi bi-check-circle me-1"></i>Ativo
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger-subtle text-danger border border-danger-subtle">
                                            <i class="bi bi-x-circle me-1"></i>Inativo
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="py-3">
                                        <span class="badge bg-light text-dark">{{ report.ordem or 0 }}</span>
                                    </td>
                                    <td class="py-3">
                                        <small class="text-muted">{{ report.criado_por or 'N/A' }}</small>
                                    </td>
                                    <td class="py-3">
                                        <small class="text-muted">
                                            {% if report.data_criacao and report.data_criacao.__class__.__name__ == 'datetime' %}{{ report.data_criacao.strftime('%d/%m/%Y %H:%M') }}{% else %}{{ report.data_criacao or 'N/A' }}{% endif %}
                                        </small>
                                    </td>
                                    <td class="py-3 text-center">
                                        <div class="btn-group" role="group">
                                            <a href="{{ report.link }}" 
                                               target="_blank" 
                                               class="btn btn-outline-primary btn-sm" 
                                               title="Visualizar Relatório">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button type="button" 
                                                    class="btn btn-outline-warning btn-sm edit-btn" 
                                                    title="Editar"
                                                    data-id="{{ report.id }}"
                                                    data-nome="{{ report.nome }}"
                                                    data-descricao="{{ report.descricao or '' }}"
                                                    data-link="{{ report.link }}"
                                                    data-ativo="{{ report.ativo }}"
                                                    data-ordem="{{ report.ordem or 0 }}"
                                                    data-usuarios_autorizados="{{ report.usuarios_autorizados or 'todos' }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-outline-danger btn-sm delete-btn" 
                                                    title="Excluir"
                                                    data-id="{{ report.id }}"
                                                    data-nome="{{ report.nome }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="empty-state">
                            <i class="bi bi-graph-up display-4 text-muted mb-3"></i>
                            <h4 class="text-muted">Nenhum relatório cadastrado</h4>
                            <p class="text-muted mb-4">
                                Comece criando seu primeiro relatório Power BI
                            </p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createReportModal">
                                <i class="bi bi-plus-circle me-2"></i>Criar Primeiro Relatório
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Criar Relatório -->
<div class="modal fade" id="createReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>Novo Relatório
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('create_report') }}" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="nome" class="form-label">
                                    Nome do Relatório <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ordem" class="form-label">Ordem de Exibição</label>
                                <input type="number" class="form-control" id="ordem" name="ordem" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="3" placeholder="Descreva o conteúdo e objetivo do relatório..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="link" class="form-label">
                            Link do Power BI <span class="text-danger">*</span>
                        </label>
                        <input type="url" class="form-control" id="link" name="link" required placeholder="https://app.powerbi.com/...">
                        <div class="form-text">Cole aqui o link completo do relatório no Power BI</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="usuarios_autorizados" class="form-label">
                            <i class="bi bi-people me-2"></i>Usuários Autorizados
                        </label>
                        <select class="form-select" id="usuarios_autorizados" name="usuarios_autorizados_select" multiple>
                            <option value="todos" selected>🌐 Todos os usuários</option>
                            <!-- Usuários serão carregados via JavaScript -->
                        </select>
                        <input type="hidden" id="usuarios_autorizados_hidden" name="usuarios_autorizados" value="todos">
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Selecione "Todos" para acesso geral ou escolha usuários específicos. Use Ctrl+Click para múltipla seleção.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ativo" name="ativo" value="on" checked>
                            <label class="form-check-label" for="ativo">
                                <i class="bi bi-eye text-success me-1"></i>
                                Relatório ativo (visível para usuários)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check me-2"></i>Criar Relatório
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Relatório -->
<div class="modal fade" id="editReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>Editar Relatório
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('edit_report') }}" method="POST">
                <input type="hidden" id="edit_report_id" name="report_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="edit_nome" class="form-label">
                                    Nome do Relatório <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="edit_nome" name="nome" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit_ordem" class="form-label">Ordem de Exibição</label>
                                <input type="number" class="form-control" id="edit_ordem" name="ordem">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="edit_descricao" name="descricao" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_link" class="form-label">
                            Link do Power BI <span class="text-danger">*</span>
                        </label>
                        <input type="url" class="form-control" id="edit_link" name="link" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_usuarios_autorizados" class="form-label">
                            <i class="bi bi-people me-2"></i>Usuários Autorizados
                        </label>
                        <select class="form-select" id="edit_usuarios_autorizados" name="usuarios_autorizados_select" multiple>
                            <option value="todos">🌐 Todos os usuários</option>
                            <!-- Usuários serão carregados via JavaScript -->
                        </select>
                        <input type="hidden" id="edit_usuarios_autorizados_hidden" name="usuarios_autorizados" value="todos">
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Selecione "Todos" para acesso geral ou escolha usuários específicos. Use Ctrl+Click para múltipla seleção.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_ativo" name="ativo" value="on">
                            <label class="form-check-label" for="edit_ativo">
                                <i class="bi bi-eye text-success me-1"></i>
                                Relatório ativo (visível para usuários)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check me-2"></i>Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Confirmar Exclusão -->
<div class="modal fade" id="deleteReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('delete_report') }}" method="POST">
                <input type="hidden" id="delete_report_id" name="report_id">
                <div class="modal-body">
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle display-4 text-danger mb-3"></i>
                        <h5>Tem certeza que deseja excluir este relatório?</h5>
                        <p class="text-muted mb-3">
                            <strong id="delete_report_name"></strong>
                        </p>
                        <div class="alert alert-danger">
                            <i class="bi bi-info-circle me-2"></i>
                            Esta ação não pode ser desfeita. O relatório será removido permanentemente.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>Excluir Relatório
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .report-icon-sm {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.05) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--bs-primary);
        flex-shrink: 0;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .btn-group .btn {
        margin: 0 1px;
    }

    .empty-state i {
        opacity: 0.6;
    }

    .badge {
        font-size: 0.75rem;
        font-weight: 500;
    }

    .form-check-input:checked {
        background-color: var(--bs-success);
        border-color: var(--bs-success);
    }

    .modal-header.bg-primary .btn-close-white:hover {
        opacity: 0.8;
    }

    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
        }
        
        .btn-group .btn {
            margin: 1px 0;
            border-radius: 0.25rem;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const table = document.getElementById('reportsTable');
    const totalReports = document.getElementById('totalReports');

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusTerm = statusFilter.value.toLowerCase();
        const rows = table.querySelectorAll('tbody tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const nome = row.cells[0].textContent.toLowerCase();
            const descricao = row.cells[1].textContent.toLowerCase();
            const status = row.cells[2].textContent.toLowerCase();
            
            const matchesSearch = nome.includes(searchTerm) || descricao.includes(searchTerm);
            const matchesStatus = !statusTerm || 
                                (statusTerm === 'ativo' && status.includes('ativo')) ||
                                (statusTerm === 'inativo' && status.includes('inativo'));
            
            if (matchesSearch && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        totalReports.textContent = visibleCount;
    }

    if (searchInput) searchInput.addEventListener('input', filterTable);
    if (statusFilter) statusFilter.addEventListener('change', filterTable);

    // Carregar usuários disponíveis
    loadAvailableUsers();
    
    // Configurar event listeners para seleção de usuários
    setupUserSelection();
    
    function loadAvailableUsers() {
        fetch('/api/users')
            .then(response => response.json())
            .then(data => {
                const users = data.users || ['todos', 'admin', 'usuario'];
                populateUserSelects(users);
            })
            .catch(error => {
                console.error('Erro ao carregar usuários:', error);
                // Usar lista padrão em caso de erro
                populateUserSelects(['todos', 'admin', 'usuario']);
            });
    }
    
    function populateUserSelects(users) {
        const createSelect = document.getElementById('usuarios_autorizados');
        const editSelect = document.getElementById('edit_usuarios_autorizados');
        
        // Limpar opções existentes (exceto "todos")
        [createSelect, editSelect].forEach(select => {
            if (select) {
                // Manter apenas a opção "todos"
                const todosOption = select.querySelector('option[value="todos"]');
                select.innerHTML = '';
                if (todosOption) {
                    select.appendChild(todosOption);
                } else {
                    const newTodosOption = document.createElement('option');
                    newTodosOption.value = 'todos';
                    newTodosOption.textContent = '🌐 Todos os usuários';
                    newTodosOption.selected = true;
                    select.appendChild(newTodosOption);
                }
                
                // Adicionar outros usuários
                users.forEach(user => {
                    if (user !== 'todos') {
                        const option = document.createElement('option');
                        option.value = user;
                        option.textContent = `👤 ${user}`;
                        select.appendChild(option);
                    }
                });
            }
        });
    }
    
    function setupUserSelection() {
        const createSelect = document.getElementById('usuarios_autorizados');
        const createHidden = document.getElementById('usuarios_autorizados_hidden');
        const editSelect = document.getElementById('edit_usuarios_autorizados');
        const editHidden = document.getElementById('edit_usuarios_autorizados_hidden');
        
        // Event listener para formulário de criação
        if (createSelect && createHidden) {
            createSelect.addEventListener('change', function() {
                updateHiddenField(createSelect, createHidden);
            });
        }
        
        // Event listener para formulário de edição
        if (editSelect && editHidden) {
            editSelect.addEventListener('change', function() {
                updateHiddenField(editSelect, editHidden);
            });
        }
    }
    
    function updateHiddenField(selectElement, hiddenElement) {
        const selectedValues = Array.from(selectElement.selectedOptions).map(option => option.value);
        
        // Se "todos" estiver selecionado, usar apenas "todos"
        if (selectedValues.includes('todos')) {
            hiddenElement.value = 'todos';
            // Desmarcar outras opções
            Array.from(selectElement.options).forEach(option => {
                if (option.value !== 'todos') {
                    option.selected = false;
                }
            });
        } else if (selectedValues.length > 0) {
            hiddenElement.value = selectedValues.join(', ');
        } else {
            // Se nada selecionado, usar "todos" como padrão
            hiddenElement.value = 'todos';
            selectElement.querySelector('option[value="todos"]').selected = true;
        }
    }

    // Event listeners para botões de editar
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const nome = this.dataset.nome;
            const descricao = this.dataset.descricao;
            const link = this.dataset.link;
            const ativo = this.dataset.ativo === 'True';
            const ordem = this.dataset.ordem;
            const usuarios_autorizados = this.dataset.usuarios_autorizados;
            
            editReport(id, nome, descricao, link, ativo, ordem, usuarios_autorizados);
        });
    });

    // Event listeners para botões de excluir
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const nome = this.dataset.nome;
            
            deleteReport(id, nome);
        });
    });
});

function editReport(id, nome, descricao, link, ativo, ordem, usuarios_autorizados) {
    document.getElementById('edit_report_id').value = id;
    document.getElementById('edit_nome').value = nome;
    document.getElementById('edit_descricao').value = descricao;
    document.getElementById('edit_link').value = link;
    document.getElementById('edit_ativo').checked = ativo;
    document.getElementById('edit_ordem').value = ordem;
    
    // Configurar usuários autorizados
    const editSelect = document.getElementById('edit_usuarios_autorizados');
    const editHidden = document.getElementById('edit_usuarios_autorizados_hidden');
    
    if (editSelect && editHidden) {
        const usuarios = usuarios_autorizados || 'todos';
        editHidden.value = usuarios;
        
        // Limpar seleções anteriores
        Array.from(editSelect.options).forEach(option => {
            option.selected = false;
        });
        
        if (usuarios.toLowerCase() === 'todos') {
            // Selecionar apenas "todos"
            const todosOption = editSelect.querySelector('option[value="todos"]');
            if (todosOption) todosOption.selected = true;
        } else {
            // Selecionar usuários específicos
            const userList = usuarios.split(',').map(u => u.trim());
            userList.forEach(user => {
                const option = editSelect.querySelector(`option[value="${user}"]`);
                if (option) option.selected = true;
            });
        }
    }
    
    new bootstrap.Modal(document.getElementById('editReportModal')).show();
}

function deleteReport(id, nome) {
    document.getElementById('delete_report_id').value = id;
    document.getElementById('delete_report_name').textContent = nome;
    
    new bootstrap.Modal(document.getElementById('deleteReportModal')).show();
}
</script>
{% endblock %}
