{% extends "base.html" %}

{% block title %}{% if client %}editar cliente{% else %}novo cliente{% endif %} - SIGEC{% endblock %}

{% block content %}
<!-- Header da página -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1>
                <i class="bi bi-{% if client %}pencil-square{% else %}person-plus{% endif %}" style="color: var(--control-primary);"></i>
                {% if client %}editar cliente{% else %}novo cliente{% endif %}
            </h1>
            <p class="mb-0">
                {% if client %}
                    Atualize as informações do cliente <strong>{{ client.nomeEmpresa }}</strong>
                {% else %}
                    SIGEC - sistema de gestão de empresas control - Cadastro de novo cliente
                {% endif %}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i>
                voltar ao dashboard
            </a>
        </div>

<form method="POST" action="/client" class="needs-validation" novalidate id="clientForm">
    <!-- DEBUG: Cliente e ID -->
    <!-- Cliente existe: {{ client is defined and client }} -->
    <!-- Cliente ID: {{ client.id if client else 'N/A' }} -->
    
    <!-- Campo ID sempre enviado - corrigido para evitar duplicação -->
    <input type="hidden" name="id" value="{{ client.id if client and client.id else '' }}">
    
    <!-- Bloco 1: Informações da Pessoa Física / Jurídica -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-building me-2" style="color: var(--control-primary);"></i>
                Bloco 1 - Informações da Pessoa Física / Jurídica
            </h5>
        </div>
        <div class="card-body">
            <!-- Primeira linha: Nome da Empresa e Razão Social -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nomeEmpresa" class="form-label">
                        <i class="bi bi-building me-1"></i>Nome da Empresa
                        <span class="text-danger required-field">*</span>
                    </label>
                    <input type="text" class="form-control upper-input" id="nomeEmpresa" name="nomeEmpresa" 
                           value="{{ client.nomeEmpresa if client else '' }}" required>
                    <div class="invalid-feedback">
                        Por favor, informe o nome da empresa.
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="razaoSocialReceita" class="form-label">
                        <i class="bi bi-file-text me-1"></i>Razão Social (Receita)
                        <span class="text-danger conditional-required">*</span>
                    </label>
                    <input type="text" class="form-control upper-input" id="razaoSocialReceita" name="razaoSocialReceita"
                           value="{{ client.razaoSocialReceita if client else '' }}">
                    <div class="invalid-feedback">
                        Por favor, informe a razão social.
                    </div>
                </div>
            </div>
            
            <!-- Segunda linha: Nome Fantasia e CPF/CNPJ -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nomeFantasiaReceita" class="form-label">
                        <i class="bi bi-shop me-1"></i>Nome Fantasia (Receita)
                        <span class="text-danger conditional-required">*</span>
                    </label>
                    <input type="text" class="form-control upper-input" id="nomeFantasiaReceita" name="nomeFantasiaReceita"
                           value="{{ client.nomeFantasiaReceita if client else '' }}">
                    <div class="invalid-feedback">
                        Por favor, informe o nome fantasia.
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="cpfCnpj" class="form-label">
                        <i class="bi bi-card-text me-1"></i>CPF/CNPJ
                        <span class="text-danger required-field">*</span>
                    </label>
                    <input type="text" class="form-control upper-input" id="cpfCnpj" name="cpfCnpj"
                           value="{{ client.cpfCnpj if client else '' }}" placeholder="00.000.000/0001-00" required>
                    <div class="invalid-feedback">
                        Por favor, informe o CPF ou CNPJ.
                    </div>
                </div>
            </div>
            
            <!-- Terceira linha: Estado, Cidade, Inscrição Estadual, Inscrição Municipal -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="estado" class="form-label">
                        <i class="bi bi-map me-1"></i>Estado
                        <span class="text-danger required-field">*</span>
                    </label>
                    <select class="form-select" id="estado" name="estado" required>
                        <option value="">Selecione o estado</option>
                        <option value="AC" {% if client and client.estado == 'AC' %}selected{% endif %}>Acre</option>
                        <option value="AL" {% if client and client.estado == 'AL' %}selected{% endif %}>Alagoas</option>
                        <option value="AP" {% if client and client.estado == 'AP' %}selected{% endif %}>Amapá</option>
                        <option value="AM" {% if client and client.estado == 'AM' %}selected{% endif %}>Amazonas</option>
                        <option value="BA" {% if client and client.estado == 'BA' %}selected{% endif %}>Bahia</option>
                        <option value="CE" {% if client and client.estado == 'CE' %}selected{% endif %}>Ceará</option>
                        <option value="DF" {% if client and client.estado == 'DF' %}selected{% endif %}>Distrito Federal</option>
                        <option value="ES" {% if client and client.estado == 'ES' %}selected{% endif %}>Espírito Santo</option>
                        <option value="GO" {% if client and client.estado == 'GO' %}selected{% endif %}>Goiás</option>
                        <option value="MA" {% if client and client.estado == 'MA' %}selected{% endif %}>Maranhão</option>
                        <option value="MT" {% if client and client.estado == 'MT' %}selected{% endif %}>Mato Grosso</option>
                        <option value="MS" {% if client and client.estado == 'MS' %}selected{% endif %}>Mato Grosso do Sul</option>
                        <option value="MG" {% if client and client.estado == 'MG' %}selected{% endif %}>Minas Gerais</option>
                        <option value="PA" {% if client and client.estado == 'PA' %}selected{% endif %}>Pará</option>
                        <option value="PB" {% if client and client.estado == 'PB' %}selected{% endif %}>Paraíba</option>
                        <option value="PR" {% if client and client.estado == 'PR' %}selected{% endif %}>Paraná</option>
                        <option value="PE" {% if client and client.estado == 'PE' %}selected{% endif %}>Pernambuco</option>
                        <option value="PI" {% if client and client.estado == 'PI' %}selected{% endif %}>Piauí</option>
                        <option value="RJ" {% if client and client.estado == 'RJ' %}selected{% endif %}>Rio de Janeiro</option>
                        <option value="RN" {% if client and client.estado == 'RN' %}selected{% endif %}>Rio Grande do Norte</option>
                        <option value="RS" {% if client and client.estado == 'RS' %}selected{% endif %}>Rio Grande do Sul</option>
                        <option value="RO" {% if client and client.estado == 'RO' %}selected{% endif %}>Rondônia</option>
                        <option value="RR" {% if client and client.estado == 'RR' %}selected{% endif %}>Roraima</option>
                        <option value="SC" {% if client and client.estado == 'SC' %}selected{% endif %}>Santa Catarina</option>
                        <option value="SP" {% if client and client.estado == 'SP' %}selected{% endif %}>São Paulo</option>
                        <option value="SE" {% if client and client.estado == 'SE' %}selected{% endif %}>Sergipe</option>
                        <option value="TO" {% if client and client.estado == 'TO' %}selected{% endif %}>Tocantins</option>
                    </select>
                    <div class="invalid-feedback">
                        Por favor, selecione o estado.
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="cidade" class="form-label">
                        <i class="bi bi-geo me-1"></i>Cidade
                        <span class="text-danger required-field">*</span>
                    </label>
                    <input type="text" class="form-control upper-input" id="cidade" name="cidade"
                           value="{{ client.cidade if client else '' }}" required>
                    <div class="invalid-feedback">
                        Por favor, informe a cidade.
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="inscEst" class="form-label">
                        <i class="bi bi-card-list me-1"></i>Inscrição Estadual
                        <span class="text-danger conditional-required">*</span>
                    </label>
                    <input type="text" class="form-control upper-input" id="inscEst" name="inscEst"
                           value="{{ client.inscEst if client else '' }}">
                    <div class="invalid-feedback">
                        Por favor, informe a inscrição estadual.
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="inscMun" class="form-label">
                        <i class="bi bi-geo-alt me-1"></i>Inscrição Municipal
                        <span class="text-danger conditional-required">*</span>
                    </label>
                    <input type="text" class="form-control upper-input" id="inscMun" name="inscMun"
                           value="{{ client.inscMun if client else '' }}">
                    <div class="invalid-feedback">
                        Por favor, informe a inscrição municipal.
                    </div>
                </div>
            </div>
            
            <!-- Quarta linha: Segmento, Atividade Principal -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="segmento" class="form-label">
                        <i class="bi bi-tags me-1"></i>Segmento
                        <span class="text-danger conditional-required">*</span>
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control upper-input" id="segmento" name="segmento"
                               value="{{ client.segmento if client else '' }}">
                        <button class="btn btn-outline-secondary" type="button" onclick="window.open('/segmentos', '_blank')" title="Cadastrar novos segmentos">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback">
                        Por favor, informe o segmento.
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="atividade" class="form-label">
                        <i class="bi bi-briefcase me-1"></i>Atividade Principal
                        <span class="text-danger conditional-required">*</span>
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control upper-input" id="atividade" name="atividade"
                               value="{{ client.atividade if client else '' }}">
                        <button class="btn btn-outline-secondary" type="button" onclick="window.open('/atividades', '_blank')" title="Cadastrar novas atividades">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback">
                        Por favor, informe a atividade principal.
                    </div>
                </div>
            </div>
            
            <!-- Quinta linha: Regime Estadual e Regime Federal -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="regimeEstadual" class="form-label">
                        <i class="bi bi-bank me-1"></i>Regime Estadual
                        <span class="text-danger conditional-required">*</span>
                    </label>
                    <select class="form-select" id="regimeEstadual" name="regimeEstadual">
                        <option value="">Selecione o regime estadual</option>
                        <option value="SIMPLES" {% if client and client.regimeEstadual == 'SIMPLES' %}selected{% endif %}>Simples Nacional</option>
                        <option value="NORMAL" {% if client and client.regimeEstadual == 'NORMAL' %}selected{% endif %}>Regime Normal</option>
                        <option value="REGIME_ESPECIAL" {% if client and client.regimeEstadual == 'REGIME_ESPECIAL' %}selected{% endif %}>Regime Especial</option>
                    </select>
                    <div class="invalid-feedback">
                        Por favor, selecione o regime estadual.
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="regimeFederal" class="form-label">
                        <i class="bi bi-percent me-1"></i>Regime Federal
                        <span class="text-danger conditional-required">*</span>
                    </label>
                    <select class="form-select" id="regimeFederal" name="regimeFederal">
                        <option value="">Selecione o regime federal</option>
                        <option value="MEI" {% if client and client.regimeFederal == 'MEI' %}selected{% endif %}>MEI</option>
                        <option value="SIMPLES" {% if client and client.regimeFederal == 'SIMPLES' %}selected{% endif %}>Simples Nacional</option>
                        <option value="LUCRO_PRESUMIDO" {% if client and client.regimeFederal == 'LUCRO_PRESUMIDO' %}selected{% endif %}>Lucro Presumido</option>
                        <option value="LUCRO_REAL" {% if client and client.regimeFederal == 'LUCRO_REAL' %}selected{% endif %}>Lucro Real</option>
                        <option value="REGIME_ESPECIAL" {% if client and client.regimeFederal == 'REGIME_ESPECIAL' %}selected{% endif %}>Regime Especial</option>
                    </select>
                    <div class="invalid-feedback">
                        Por favor, selecione o regime federal.
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-handshake me-2"></i>
                Bloco 2: Serviços Prestados pela Control
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- BPO Financeiro -->
                <div class="col-md-3 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="bpoFinanceiro" name="bpoFinanceiro" 
                               {% if client and client.bpoFinanceiro %}checked{% endif %}>
                        <label class="form-check-label" for="bpoFinanceiro">
                            <i class="bi bi-graph-up me-1 text-info"></i>
                            <strong>BPO Financeiro</strong>
                        </label>
                    </div>

                <!-- Departamento Contábil (CT) -->
                <div class="col-md-3 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ct" name="ct" 
                               {% if client and client.ct %}checked{% endif %}>
                        <label class="form-check-label" for="ct">
                            <i class="bi bi-calculator me-1" style="color: var(--control-primary);"></i>
                            <strong>Departamento Contábil (CT)</strong>
                        </label>
                    </div>

                <!-- Departamento Fiscal (FS) -->
                <div class="col-md-3 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="fs" name="fs" 
                               {% if client and client.fs %}checked{% endif %}>
                        <label class="form-check-label" for="fs">
                            <i class="bi bi-file-text me-1" style="color: var(--control-secondary);"></i>
                            <strong>Departamento Fiscal (FS)</strong>
                        </label>
                    </div>

                <!-- Departamento Pessoal (DP) -->
                <div class="col-md-3 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="dp" name="dp" 
                               {% if client and client.dp %}checked{% endif %}>
                        <label class="form-check-label" for="dp">
                            <i class="bi bi-people me-1 text-success"></i>
                            <strong>Departamento Pessoal (DP)</strong>
                        </label>
                    </div>

                <!-- Data de Início dos Serviços -->
                <div class="col-md-6 mb-3">
                    <label for="dataInicioServicos" class="form-label">
                        <i class="bi bi-calendar-event me-1"></i>
                        data de início dos serviços
                    </label>
                    <input type="month" class="form-control" id="dataInicioServicos" name="dataInicioServicos" 
                           value="{{ client.dataInicioServicos or client.mesAnoInicio if client else '' }}">
                    <div class="form-text">
                        Formato: Mês/Ano (Ex: 2024-01)
                    </div>

                <!-- Responsável pelos Serviços -->
                <div class="col-md-6 mb-3">
                    <label for="responsavelServicos" class="form-label">
                        <i class="bi bi-person-badge me-1"></i>
                        responsável pelos serviços
                    </label>
                    <input type="text" class="form-control" id="responsavelServicos" name="responsavelServicos" 
                           value="{{ client.responsavelServicos if client else '' }}"
                            "placeholder= +                            placeholder="NOME DO RESPONSÁVEL">
                </div>
                
                <!-- E-MAIL SECUNDÁRIO -->
                <div class="col-md-6 mb-3">
                    <label for="emailSecundario" class="form-label">E-MAIL SECUNDÁRIO</label>
                    <input type="EMAIL" class="form-control" id="emailSecundario" name="emailSecundario" 
                           value="{{ client.emailSecundario if client else '' }}" 
                            "placeholder= +                            placeholder="FINANCEIRO@EMPRESA.COM.BR">
                </div>
            
            <div class="row">
                <!-- RESPONSÁVEL IMEDIATO -->
                <div class="col-md-6 mb-3">
                    <label for="responsavelImediato" class="form-label">RESPONSÁVEL IMEDIATO</label>
                    <input type="text" class="form-control" id="responsavelImediato" name="responsavelImediato" 
                           value="{{ client.responsavelImediato if client else '' }}" 
                            "placeholder= +                            placeholder="NOME DO RESPONSÁVEL PELA EMPRESA">
                </div>
                
                <!-- E-MAILS DOS SÓCIOS -->
                <div class="col-md-6 mb-3">
                    <label for="emailsSocios" class="form-label">E-MAILS DOS SÓCIOS</label>
                    <textarea class="form-control" id="emailsSocios" name="emailsSocios" rows="2" 
                               "placeholder= +                               placeholder="SOCIO1@EMAIL.COM, SOCIO2@EMAIL.COM">{{ client.emailsSocios if client else '' }}</textarea>{{ client.emailsSocios if client else '' }}</textarea>
                    <div class="form-text">Separar múltiplos e-mails por vírgula</div>
                </div>
            
            <div class="row">
                <!-- CONTATO CONTADOR -->
                <div class="col-md-4 mb-3">
                    <label for="contatoContador" class="form-label">CONTATO CONTADOR</label>
                    <input type="text" class="form-control" id="contatoContador" name="contatoContador" 
                           value="{{ client.contatoContador if client else '' }}" 
                            "placeholder= +                            placeholder="NOME DO CONTADOR RESPONSÁVEL">
                </div>
                
                <!-- TELEFONE CONTADOR -->
                <div class="col-md-4 mb-3">
                    <label for="telefoneContador" class="form-label">TELEFONE CONTADOR</label>
                    <input type="tel" class="form-control" id="telefoneContador" name="telefoneContador" 
                           value="{{ client.telefoneContador if client else '' }}" 
                            "placeholder= +                            placeholder="(85) 99999-9999">
                </div>
                
                <!-- E-MAIL CONTADOR -->
                <div class="col-md-4 mb-3">
                    <label for="emailContador" class="form-label">E-MAIL CONTADOR</label>
                    <input type="EMAIL" class="form-control" id="emailContador" name="emailContador" 
                           value="{{ client.emailContador if client else '' }}" 
                            "placeholder= +                            placeholder="CONTADOR@CONTROLCONTABILIDADE.COM.BR">
                </div>

    <!-- Bloco 5: Sistemas e Acessos -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="fas fa-desktop me-2"></i>Bloco 5: Sistemas e Acessos
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- SISTEMA PRINCIPAL UTILIZADO -->
                <div class="col-md-6 mb-3">
                    <label for="sistemaPrincipal" class="form-label">SISTEMA PRINCIPAL UTILIZADO</label>
                    <select class="form-select" id="sistemaPrincipal" name="sistemaPrincipal">
                        <option value="">Selecione...</option>
                        <option value="Dominio" {{ 'selected' if client and client.sistemaPrincipal == 'Dominio' else '' }}>Domínio</option>
                        <option value="Fortes" {{ 'selected' if client and client.sistemaPrincipal == 'Fortes' else '' }}>Fortes</option>
                        <option value="Outros" {{ 'selected' if client and client.sistemaPrincipal == 'Outros' else '' }}>Outros</option>
                    </select>
                </div>
                
                <!-- VERSÃO DO SISTEMA -->
                <div class="col-md-6 mb-3">
                    <label for="versaoSistema" class="form-label">VERSÃO DO SISTEMA</label>
                    <input type="text" class="form-control" id="versaoSistema" name="versaoSistema" 
                           value="{{ client.versaoSistema if client else '' }}" 
                            "placeholder= +                            placeholder="EX: 2024.1, V3.2, ETC.">
                </div>
            
            <div class="row">
                <!-- Código de Acesso Simples Nacional -->
                <div class="col-md-6 mb-3">
                    <label for="codAcessoSimples" class="form-label">CÓDIGO ACESSO SIMPLES NACIONAL</label>
                    <input type="text" class="form-control" id="codAcessoSimples" name="codAcessoSimples" 
                           value="{{ client.codAcessoSimples if client else '' }}" 
                            "placeholder= +                            placeholder="CÓDIGO DE ACESSO SN">
                </div>
                
                <!-- CPF ou CNPJ para Acesso -->
                <div class="col-md-6 mb-3">
                    <label for="cpfCnpjAcesso" class="form-label">CPF/CNPJ PARA ACESSO</label>
                    <input type="text" class="form-control" id="cpfCnpjAcesso" name="cpfCnpjAcesso" 
                           value="{{ client.cpfCnpjAcesso if client else '' }}" 
                            "placeholder= +                            placeholder="CPF OU CNPJ USADO NOS ACESSOS">
                </div>

    <!-- Bloco 6: Senhas e Credenciais -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
                <i class="fas fa-key me-2"></i>Bloco 6: Senhas e Credenciais
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Atenção!</strong> Informações sensíveis. Mantenha a confidencialidade.
            </div>
            
            <div class="row">
                <!-- ACESSO ISS -->
                <div class="col-md-6 mb-3">
                    <label for="acessoIss" class="form-label">ACESSO ISS</label>
                    <input type="text" class="form-control" id="acessoIss" name="acessoIss" 
                           value="{{ client.acessoIss if client else '' }}" 
                            "placeholder= +                            placeholder="LOGIN ISS">
                </div>
                
                <!-- SENHA ISS -->
                <div class="col-md-6 mb-3">
                    <label for="senhaIss" class="form-label">SENHA ISS</label>
                    <input type="password" class="form-control" id="senhaIss" name="senhaIss" 
                           value="{{ client.senhaIss if client else '' }}">
                </div>
            
            <div class="row">
                <!-- ACESSO SEFIN -->
                <div class="col-md-6 mb-3">
                    <label for="acessoSefin" class="form-label">ACESSO SEFIN</label>
                    <input type="text" class="form-control" id="acessoSefin" name="acessoSefin" 
                           value="{{ client.acessoSefin if client else '' }}" 
                            "placeholder= +                            placeholder="LOGIN SEFIN">
                </div>
                
                <!-- SENHA SEFIN -->
                <div class="col-md-6 mb-3">
                    <label for="senhaSefin" class="form-label">SENHA SEFIN</label>
                    <input type="password" class="form-control" id="senhaSefin" name="senhaSefin" 
                           value="{{ client.senhaSefin if client else '' }}">
                </div>
            
            <div class="row">
                <!-- ACESSO SEUMA -->
                <div class="col-md-6 mb-3">
                    <label for="acessoSeuma" class="form-label">ACESSO SEUMA</label>
                    <input type="text" class="form-control" id="acessoSeuma" name="acessoSeuma" 
                           value="{{ client.acessoSeuma if client else '' }}" 
                            "placeholder= +                            placeholder="LOGIN SEUMA">
                </div>
                
                <!-- SENHA SEUMA -->
                <div class="col-md-6 mb-3">
                    <label for="senhaSeuma" class="form-label">SENHA SEUMA</label>
                    <input type="password" class="form-control" id="senhaSeuma" name="senhaSeuma" 
                           value="{{ client.senhaSeuma if client else '' }}">
                </div>
            
            <div class="row">
                <!-- ACESSO EMPWEB -->
                <div class="col-md-6 mb-3">
                    <label for="acessoEmpWeb" class="form-label">ACESSO EMPWEB</label>
                    <input type="text" class="form-control" id="acessoEmpWeb" name="acessoEmpWeb" 
                           value="{{ client.acessoEmpWeb if client else '' }}" 
                            "placeholder= +                            placeholder="Login EmpWeb">
                </div>
                
                <!-- SENHA EMPWEB -->
                <div class="col-md-6 mb-3">
                    <label for="senhaEmpWeb" class="form-label">SENHA EMPWEB</label>
                    <input type="password" class="form-control" id="senhaEmpWeb" name="senhaEmpWeb" 
                           value="{{ client.senhaEmpWeb if client else '' }}">
                </div>
            
            <div class="row">
                <!-- Acesso FAP/INSS -->
                <div class="col-md-6 mb-3">
                    <label for="acessoFapInss" class="form-label">ACESSO FAP/INSS</label>
                    <input type="text" class="form-control" id="acessoFapInss" name="acessoFapInss" 
                           value="{{ client.acessoFapInss if client else '' }}" 
                            "placeholder= +                            placeholder="Login FAP/INSS">
                </div>
                
                <!-- Senha FAP/INSS -->
                <div class="col-md-6 mb-3">
                    <label for="senhaFapInss" class="form-label">SENHA FAP/INSS</label>
                    <input type="password" class="form-control" id="senhaFapInss" name="senhaFapInss" 
                           value="{{ client.senhaFapInss if client else '' }}">
                </div>
            
            <div class="row">
                <!-- ACESSO CRF -->
                <div class="col-md-6 mb-3">
                    <label for="acessoCrf" class="form-label">ACESSO CRF</label>
                    <input type="text" class="form-control" id="acessoCrf" name="acessoCrf" 
                           value="{{ client.acessoCrf if client else '' }}" 
                            "placeholder= +                            placeholder="Login CRF">
                </div>
                
                <!-- SENHA CRF -->
                <div class="col-md-6 mb-3">
                    <label for="senhaCrf" class="form-label">SENHA CRF</label>
                    <input type="password" class="form-control" id="senhaCrf" name="senhaCrf" 
                           value="{{ client.senhaCrf if client else '' }}">
                </div>
            
            <div class="row">
                <!-- E-mail Gestor -->
                <div class="col-md-6 mb-3">
                    <label for="emailGestor" class="form-label">E-MAIL GESTOR</label>
                    <input type="EMAIL" class="form-control" id="emailGestor" name="emailGestor" 
                           value="{{ client.emailGestor if client else '' }}" 
                            "placeholder= +                            placeholder="gestor@empresa.com.br">
                </div>
                
                <!-- Senha E-mail Gestor -->
                <div class="col-md-6 mb-3">
                    <label for="senhaEmailGestor" class="form-label">SENHA E-MAIL GESTOR</label>
                    <input type="password" class="form-control" id="senhaEmailGestor" name="senhaEmailGestor" 
                           value="{{ client.senhaEmailGestor if client else '' }}">
                </div>
            
            <div class="row">
                <!-- ANVISA GESTOR -->
                <div class="col-md-6 mb-3">
                    <label for="anvisaGestor" class="form-label">ANVISA GESTOR</label>
                    <input type="text" class="form-control" id="anvisaGestor" name="anvisaGestor" 
                           value="{{ client.anvisaGestor if client else '' }}" 
                            "placeholder= +                            placeholder="Login ANVISA GESTOR">
                </div>
                
                <!-- ANVISA EMPRESA -->
                <div class="col-md-6 mb-3">
                    <label for="anvisaEmpresa" class="form-label">ANVISA EMPRESA</label>
                    <input type="text" class="form-control" id="anvisaEmpresa" name="anvisaEmpresa" 
                           value="{{ client.anvisaEmpresa if client else '' }}" 
                            "placeholder= +                            placeholder="Login ANVISA EMPRESA">
                </div>
            
            <div class="row">
                <!-- ACESSO IBAMA -->
                <div class="col-md-6 mb-3">
                    <label for="acessoIbama" class="form-label">ACESSO IBAMA</label>
                    <input type="text" class="form-control" id="acessoIbama" name="acessoIbama" 
                           value="{{ client.acessoIbama if client else '' }}" 
                            "placeholder= +                            placeholder="Login IBAMA">
                </div>
                
                <!-- SENHA IBAMA -->
                <div class="col-md-6 mb-3">
                    <label for="senhaIbama" class="form-label">SENHA IBAMA</label>
                    <input type="password" class="form-control" id="senhaIbama" name="senhaIbama" 
                           value="{{ client.senhaIbama if client else '' }}">
                </div>
            
            <div class="row">
                <!-- ACESSO SEMACE -->
                <div class="col-md-6 mb-3">
                    <label for="acessoSemace" class="form-label">ACESSO SEMACE</label>
                    <input type="text" class="form-control" id="acessoSemace" name="acessoSemace" 
                           value="{{ client.acessoSemace if client else '' }}" 
                            "placeholder= +                            placeholder="Login SEMACE">
                </div>
                
                <!-- SENHA SEMACE -->
                <div class="col-md-6 mb-3">
                    <label for="senhaSemace" class="form-label">SENHA SEMACE</label>
                    <input type="password" class="form-control" id="senhaSemace" name="senhaSemace" 
                           value="{{ client.senhaSemace if client else '' }}">
                </div>

    <!-- Bloco 7: Procurações -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
                <i class="fas fa-file-contract me-2"></i>Bloco 7: Procurações
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Procuração RFB (Receita Federal) -->
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="procRfb" name="procRfb" 
                               {{ 'checked' if client and client.procRfb else '' }}>
                        <label class="form-check-label" for="procRfb">
                            Procuração RFB (Receita Federal)
                        </label>
                    </div>
                    <div class="mt-2">
                        <label for="procRfbData" class="form-label">DATA DA PROCURAÇÃO</label>
                        <input type="date" class="form-control" id="procRfbData" name="procRfbData" 
                               value="{{ client.procRfbData if client else '' }}">
                    </div>
                
                <!-- Procuração RC (Receita Estadual) -->
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="procRc" name="procRc" 
                               {{ 'checked' if client and client.procRc else '' }}>
                        <label class="form-check-label" for="procRc">
                            Procuração RC (Receita Estadual)
                        </label>
                    </div>
                    <div class="mt-2">
                        <label for="procRcData" class="form-label">DATA DA PROCURAÇÃO</label>
                        <input type="date" class="form-control" id="procRcData" name="procRcData" 
                               value="{{ client.procRcData if client else '' }}">
                    </div>
                
                <!-- Procuração CX (Caixa Econômica) -->
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="procCx" name="procCx" 
                               {{ 'checked' if client and client.procCx else '' }}>
                        <label class="form-check-label" for="procCx">
                            Procuração CX (Caixa Econômica)
                        </label>
                    </div>
                    <div class="mt-2">
                        <label for="procCxData" class="form-label">DATA DA PROCURAÇÃO</label>
                        <input type="date" class="form-control" id="procCxData" name="procCxData" 
                               value="{{ client.procCxData if client else '' }}">
                    </div>
            
            <div class="row">
                <!-- Procuração SW (Previdência Social) -->
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="procSw" name="procSw" 
                               {{ 'checked' if client and client.procSw else '' }}>
                        <label class="form-check-label" for="procSw">
                            Procuração SW (Previdência Social)
                        </label>
                    </div>
                    <div class="mt-2">
                        <label for="procSwData" class="form-label">DATA DA PROCURAÇÃO</label>
                        <input type="date" class="form-control" id="procSwData" name="procSwData" 
                               value="{{ client.procSwData if client else '' }}">
                    </div>
                
                <!-- Procuração Municipal -->
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="procMunicipal" name="procMunicipal" 
                               {{ 'checked' if client and client.procMunicipal else '' }}>
                        <label class="form-check-label" for="procMunicipal">
                            Procuração Municipal
                        </label>
                    </div>
                    <div class="mt-2">
                        <label for="procMunicipalData" class="form-label">DATA DA PROCURAÇÃO</label>
                        <input type="date" class="form-control" id="procMunicipalData" name="procMunicipalData" 
                               value="{{ client.procMunicipalData if client else '' }}">
                    </div>
                
                <!-- outras procurações -->
                <div class="col-md-4 mb-3">
                    <label for="outrasProc" class="form-label">OUTRAS PROCURAÇÕES</label>
                    <textarea class="form-control" id="outrasProc" name="outrasProc" rows="3" 
                               "placeholder= +                               placeholder="Descreva outras procurações...">{{ client.outrasProc if client else '' }}</textarea>{{ client.outrasProc if client else '' }}</textarea>
                </div>
            
            <div class="row">
                <!-- observações sobre procurações -->
                <div class="col-12 mb-3">
                    <label for="obsProcuracoes" class="form-label">OBSERVAÇÕES SOBRE PROCURAÇÕES</label>
                    <textarea class="form-control" id="obsProcuracoes" name="obsProcuracoes" rows="3" 
                               "placeholder= +                               placeholder="observações gerais sobre as procurações...">{{ client.obsProcuracoes if client else '' }}</textarea>{{ client.obsProcuracoes if client else '' }}</textarea>
                </div>

    <!-- Bloco 8: Observações e Dados Adicionais -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-sticky-note me-2"></i>Bloco 8: Observações e Dados Adicionais
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Data de Início dos Serviços -->
                <div class="col-md-4 mb-3">
                    <label for="dataInicioServicos" class="form-label">DATA INÍCIO DOS SERVIÇOS</label>
                    <input type="date" class="form-control" id="dataInicioServicos" name="dataInicioServicos" 
                           value="{{ client.dataInicioServicos if client else '' }}">
                </div>
                
                <!-- status do cliente -->
                <div class="col-md-4 mb-3">
                    <label for="statusCliente" class="form-label">STATUS DO CLIENTE</label>
                    <select class="form-select" id="statusCliente" name="statusCliente">
                        <option value="ativo" {{ 'selected' if client and client.statusCliente == 'ativo' else '' }}>Ativo</option>
                        <option value="inativo" {{ 'selected' if client and client.statusCliente == 'inativo' else '' }}>Inativo</option>
                        <option value="suspenso" {{ 'selected' if client and client.statusCliente == 'suspenso' else '' }}>Suspenso</option>
                        <option value="em_analise" {{ 'selected' if client and client.statusCliente == 'em_analise' else '' }}>Em Análise</option>
                    </select>
                </div>
            
                <!-- Data da última atualização -->
                <div class="col-md-4 mb-3">
                    <label for="ultimaAtualizacao" class="form-label">última atualização</label>
                    <input type="datetime-local" class="form-control" id="ultimaAtualizacao" name="ultimaAtualizacao" 
                           value="{{ client.ultimaAtualizacao if client else '' }}" readonly>
                    <div class="form-text">Atualizado automaticamente</div>
                </div>
            </div>
            
            <div class="row">
                <!-- responsável pela atualização -->
                <div class="col-md-12 mb-3">
                    <label for="responsavelAtualizacao" class="form-label">RESPONSÁVEL PELA ATUALIZAÇÃO</label>
                    <input type="text" class="form-control" id="responsavelAtualizacao" name="responsavelAtualizacao" 
                           value="{{ session.usuario if session.usuario else '' }}" readonly>
                    <div class="form-text">Usuário logado no sistema</div>
                </div>

    <!-- Botões de ação -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="submit" class="btn btn-primary me-3">
                        <i class="bi bi-check-lg me-1"></i>
                        {% if client %}Atualizar Cliente{% else %}Salvar Cliente{% endif %}
                    </button>
                    <a href="/" class="btn btn-secondary">
                        <i class="bi bi-x-lg me-1"></i>
                        Cancelar
                    </a>
                </div>
                {% if client %}
                <button type="button" class="btn btn-outline-danger" 
                        onclick="confirmDelete('{{ client.id }}', '{{ client.nomeEmpresa }}')">
                    <i class="bi bi-trash me-1"></i>
                    Excluir Cliente
                </button>
                {% endif %}
            </div>
</form>
<style>
    .upper-input { text-transform: uppercase; }
    .conditional-required { display: none; }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Forçar caixa alta nos inputs
        document.querySelectorAll('.upper-input').forEach(function(input) {
            input.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        });
        
        // Controlar obrigatoriedade baseada no tipo de documento
        const cpfCnpjInput = document.getElementById('cpfCnpj');
        const requiredFields = document.querySelectorAll('.required-field');
        const conditionalFields = document.querySelectorAll('.conditional-required');
        
        function updateRequiredFields() {
            const value = cpfCnpjInput.value.replace(/\D/g, '');
            const isCPF = value.length <= 11;
            
            // Se for CPF, só obrigar: Nome da Empresa, CPF, Estado, Cidade
            if (isCPF) {
                // Ocultar asteriscos condicionais
                conditionalFields.forEach(span => {
                    span.style.display = 'none';
                });
                
                // Remover required dos campos condicionais
                ['razaoSocialReceita', 'nomeFantasiaReceita', 'inscEst', 'inscMun', 
                 'segmento', 'atividade', 'regimeEstadual', 'regimeFederal'].forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.removeAttribute('required');
                });
            } else {
                // Se for CNPJ, todos os campos são obrigatórios
                conditionalFields.forEach(span => {
                    span.style.display = 'inline';
                });
                
                // Adicionar required aos campos condicionais
                ['razaoSocialReceita', 'nomeFantasiaReceita', 'inscEst', 'inscMun', 
                 'segmento', 'atividade', 'regimeEstadual', 'regimeFederal'].forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.setAttribute('required', 'required');
                });
            }
        }
        
        // Executar ao carregar a página
        updateRequiredFields();
        
        // Executar quando o CPF/CNPJ mudar
        cpfCnpjInput.addEventListener('input', updateRequiredFields);
    });
</script>

<!-- Modal de confirmação de exclusão -->
{% if client %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o cliente <strong id="clientName">{{ client.nomeEmpresa }}</strong>?</p>
                <p class="text-muted">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" method="POST" action="/client/{{ client.id }}/delete" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Excluir
                    </button>
                </form>
            </div>
{% endif %}

<script>
// Validação do formulário
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Formatação de CNPJ
document.getElementById('cpfCnpj').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 14) {
        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
    }
    e.target.value = value;
});

// Formatação de telefones
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 11) {
        if (value.length <= 10) {
            value = value.replace(/^(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
        } else {
            value = value.replace(/^(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
    input.value = value;
}

// Aplicar máscaras de telefone
document.addEventListener('DOMContentLoaded', function() {
    const telefoneFixo = document.getElementById('telefoneFixo');
    const telefoneCelular = document.getElementById('telefoneCelular');
    const WHATSAPP = document.getElementById('WHATSAPP');
    const telefoneContador = document.getElementById('telefoneContador');
    
    if (telefoneFixo) {
        telefoneFixo.addEventListener('input', function(e) {
            formatPhone(e.target);
        });
    }
    
    if (telefoneCelular) {
        telefoneCelular.addEventListener('input', function(e) {
            formatPhone(e.target);
        });
    }
    
    if (WHATSAPP) {
        WHATSAPP.addEventListener('input', function(e) {
            formatPhone(e.target);
        });
    }
    
    if (telefoneContador) {
        telefoneContador.addEventListener('input', function(e) {
            formatPhone(e.target);
        });
    }
});

// Formatação de CNPJ
document.getElementById('cnpj').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 14) {
        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
    }
    e.target.value = value;
});

// Formatação de telefones
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 11) {
        if (value.length <= 10) {
            value = value.replace(/^(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
        } else {
            value = value.replace(/^(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
    input.value = value;
}

document.getElementById('telefoneFixo').addEventListener('input', function(e) {
    formatPhone(e.target);
});

document.getElementById('telefoneCelular').addEventListener('input', function(e) {
    formatPhone(e.target);
});

// Confirmação de exclusão
function confirmDelete(clientId, clientName) {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Indicador de loading no submit
document.getElementById('clientForm').addEventListener('submit', function() {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner"></span> Salvando...';
    submitBtn.disabled = true;
    
    // Simular delay para mostrar loading
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 2000);
});
</script>
{% endblock %}
