<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Sistema Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .debug-container { 
            background: #f8f9fa; 
            border: 2px solid #007bff; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 10px; 
        }
        .log-box { 
            background: #212529; 
            color: #fff; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto; 
            white-space: pre-wrap;
        }
        .status-success { background: #d4f6d4; border: 1px solid #28a745; padding: 10px; border-radius: 5px; }
        .status-error { background: #f8d7da; border: 1px solid #dc3545; padding: 10px; border-radius: 5px; }
        .status-warning { background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 5px; }
        .status-info { background: #d1ecf1; border: 1px solid #17a2b8; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üîç Debug: Simula√ß√£o do Sistema Real</h1>
        
        <div class="debug-container">
            <h3>üìä Teste: Exatamente Como no Sistema</h3>
            <p><strong>Este teste simula exatamente o que acontece quando voc√™ clica em um relat√≥rio no sistema real.</strong></p>
            
            <button id="testSystemReal" class="btn btn-primary me-2">
                üöÄ Simular Sistema Real
            </button>
            <button id="clearTest" class="btn btn-outline-secondary">
                üßπ Limpar Teste
            </button>
            
            <div id="testStatus" class="mt-3"></div>
        </div>

        <!-- Modal id√™ntico ao do sistema -->
        <div class="modal fade" id="reportModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title d-flex align-items-center">
                            <i class="bi bi-bar-chart me-2"></i>
                            <span id="reportModalTitle">Dashboard Financeiro</span>
                        </h5>
                        <div class="d-flex gap-2">
                            <button type="button" 
                                    class="btn btn-outline-light btn-sm" 
                                    id="openInNewTab"
                                    title="Abrir em nova aba">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </button>
                            <button type="button" 
                                    class="btn btn-outline-light btn-sm" 
                                    id="refreshReport"
                                    title="Atualizar relat√≥rio">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button type="button" 
                                    class="btn-close btn-close-white" 
                                    data-bs-dismiss="modal">
                            </button>
                        </div>
                    </div>
                    <div class="modal-body p-0 position-relative">
                        <div id="reportLoading" class="d-flex justify-content-center align-items-center position-absolute w-100 h-100 bg-white" style="z-index: 10;">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <h5 class="text-primary">Carregando Dashboard Financeiro...</h5>
                                <p class="text-muted">Aguarde enquanto o relat√≥rio √© carregado</p>
                            </div>
                        </div>
                        <iframe id="reportFrame" class="w-100 h-100 border-0" style="min-height: 80vh; display: none;"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <div class="debug-container">
            <h4>üìã Log de Debug Detalhado</h4>
            <div id="debugLog" class="log-box">Aguardando teste...\n</div>
            <button onclick="clearLog()" class="btn btn-outline-secondary btn-sm mt-2">Limpar Log</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/powerbi-smart-loader.js"></script>
    <script>
        const authLink = 'https://app.powerbi.com/reportEmbed?reportId=ef9c9663-7cec-4c9a-8b57-c1a6c895057a&autoAuth=true&ctid=0b754a09-0568-48fd-a100-8621a0bbd7ab';
        
        function log(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            debugLog.textContent += logMessage;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('testStatus');
            statusDiv.innerHTML = `<div class="status-${type} mt-3">${message}</div>`;
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = 'Log limpo...\n';
            console.clear();
        }

        document.getElementById('testSystemReal').addEventListener('click', function() {
            log('üöÄ INICIANDO: Simula√ß√£o exata do sistema real');
            log('üìä Link: ' + authLink);
            
            showStatus('info', '‚è≥ Iniciando teste do sistema real...');
            
            // Simula exatamente o que acontece no sistema
            const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            
            log('üì± Abrindo modal (como no sistema)');
            reportModal.show();
            
            // Aguarda um pouco para modal abrir (como no sistema real)
            setTimeout(() => {
                log('üß† Chamando loadReportSmart (exatamente como o sistema)');
                
                // Verifica se o smart loader foi carregado
                if (typeof loadReportSmart === 'function') {
                    log('‚úÖ Smart Loader detectado - chamando fun√ß√£o');
                    showStatus('info', 'üß† Smart Loader ativo - processando...');
                    
                    // Chama a fun√ß√£o exatamente como no sistema
                    loadReportSmart(authLink);
                    
                    // Monitora o que acontece
                    let monitorCount = 0;
                    const monitor = setInterval(() => {
                        monitorCount++;
                        log(`üîç Monitor ${monitorCount}: Verificando estado do sistema`);
                        
                        const reportFrame = document.getElementById('reportFrame');
                        const reportLoading = document.getElementById('reportLoading');
                        const alternative = document.querySelector('.powerbi-alternative');
                        
                        if (reportFrame.style.display !== 'none') {
                            log('‚úÖ SUCESSO: Iframe est√° vis√≠vel!');
                            const rect = reportFrame.getBoundingClientRect();
                            log(`üìè Dimens√µes do iframe: ${rect.width}x${rect.height}`);
                            showStatus('success', `üéâ SUCESSO! Iframe vis√≠vel com dimens√µes ${rect.width}x${rect.height}`);
                            clearInterval(monitor);
                        } else if (alternative) {
                            log('üîÑ Sistema mostrou alternativas');
                            showStatus('warning', '‚ö†Ô∏è Sistema optou por mostrar alternativas ao inv√©s do iframe');
                            clearInterval(monitor);
                        } else if (reportLoading.style.display !== 'none') {
                            log('‚è≥ Ainda carregando...');
                            if (monitorCount > 25) {
                                log('‚è∞ TIMEOUT: Sistema ainda est√° carregando ap√≥s 25 segundos');
                                showStatus('error', '‚ùå TIMEOUT: Sistema n√£o finalizou ap√≥s 25 segundos');
                                clearInterval(monitor);
                            }
                        }
                    }, 1000);
                    
                } else {
                    log('‚ùå ERRO CR√çTICO: Smart Loader n√£o foi carregado!');
                    showStatus('error', '‚ùå ERRO: Smart Loader n√£o est√° dispon√≠vel');
                    
                    // Teste de fallback sem smart loader
                    log('üîÑ Tentando carregamento direto sem smart loader');
                    const reportFrame = document.getElementById('reportFrame');
                    const reportLoading = document.getElementById('reportLoading');
                    
                    reportFrame.src = authLink;
                    
                    reportFrame.onload = function() {
                        log('üì° Iframe onload (sem smart loader)');
                        setTimeout(() => {
                            const rect = reportFrame.getBoundingClientRect();
                            if (rect.height > 200) {
                                log('‚úÖ Fallback funcionou!');
                                reportLoading.style.display = 'none';
                                reportFrame.style.display = 'block';
                                showStatus('success', '‚úÖ Fallback sem smart loader funcionou!');
                            } else {
                                log('‚ùå Fallback tamb√©m falhou');
                                showStatus('error', '‚ùå Nem smart loader nem fallback funcionaram');
                            }
                        }, 2000);
                    };
                }
                
            }, 500);
        });

        document.getElementById('clearTest').addEventListener('click', function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
            if (modal) {
                modal.hide();
            }
            
            document.getElementById('reportFrame').style.display = 'none';
            document.getElementById('reportLoading').style.display = 'flex';
            document.getElementById('testStatus').innerHTML = '';
            
            // Remove alternativas se existirem
            const alternative = document.querySelector('.powerbi-alternative');
            if (alternative) {
                alternative.remove();
            }
            
            log('üßπ Teste limpo e resetado');
        });

        // Intercepta erros e logs do console
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            // Captura logs do smart loader
            if (args[0] && typeof args[0] === 'string' && 
                (args[0].includes('üöÄ') || args[0].includes('‚úÖ') || args[0].includes('‚ùå') || 
                 args[0].includes('üîê') || args[0].includes('üì°') || args[0].includes('üéØ'))) {
                log('SMART LOADER: ' + args.join(' '));
            }
        };

        const originalConsoleError = console.error;
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            log('‚ùå CONSOLE ERROR: ' + args.join(' '));
        };

        window.addEventListener('error', function(e) {
            log(`‚ùå ERRO JS: ${e.message} em ${e.filename}:${e.lineno}`);
        });

        // Inicializa√ß√£o
        log('üéØ Sistema de debug carregado');
        log('üí° Este teste simula exatamente o comportamento do sistema real');
        log('üîß Verificando se Smart Loader est√° dispon√≠vel...');
        
        if (typeof loadReportSmart === 'function') {
            log('‚úÖ Smart Loader carregado e dispon√≠vel');
        } else {
            log('‚ùå Smart Loader N√ÉO est√° dispon√≠vel - isso pode ser o problema!');
        }
    </script>
</body>
</html>
